<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title>GAME2 Disassembly</title>

    <meta content="en-us" http-equiv="Content-Language" />
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <meta name="description" content="SourceGen-generated disassembly of GAME2" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="SGStyle.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <p style="font-size:smaller;"><a href="./">(back to project page)</a></p>
    <h1>GAME2 Disassembly</h1>

    <div id="code-lines">
        <!-- The CodeLines marker is not optional, and may only appear once -->
<pre>                   ; 6502bench SourceGen v1.7.3
                   <a name="Symitem_spiritLamp">item_spiritLamp</a>       .eq     $01    {const}
                   <a name="SymRWTSCMD_read">RWTSCMD_read</a>          .eq     $01    {const}
                   <a name="SymSTARVED_food">STARVED_food</a>          .eq     $01    {const}
                   <a name="SymPLAYER_Herd">PLAYER_Herd</a>           .eq     $02    {const}
                   <a name="SymSTARVED_rest">STARVED_rest</a>          .eq     $02    {const}
                   <a name="SymPLAYER_Charn">PLAYER_Charn</a>          .eq     $04    {const}
                   <a name="Symitem_pan_bread">item_pan_bread</a>        .eq     $05    {const}
                   <a name="Symitem_fruit_nuts">item_fruit_nuts</a>       .eq     $06    {const}
                   <a name="Symitem_shuba">item_shuba</a>            .eq     $07    {const}
                   <a name="Symitem_berries">item_berries</a>          .eq     $0a    {const}
                   <a name="Symitem_fallaKey">item_fallaKey</a>         .eq     $0d    {const}
                   <a name="Symtile_brambles">tile_brambles</a>         .eq     $1c    {const}
                   <a name="Symtile_water">tile_water</a>            .eq     $20    {const}
                   <a name="SymLASTKEY">LASTKEY</a>               .eq     $02    {addr/1}         ;last key pressed via checkkey
                   <a name="SymTXTPTR">TXTPTR</a>                .eq     $03    {addr/2}         ;current tile position on text page 1
                   <a name="SymTXTCOL">TXTCOL</a>                .eq     $05    {addr/1}         ;prob col on 40x24 scrn
                   <a name="SymTXTROW">TXTROW</a>                .eq     $06    {addr/1}         ;prob row on 40x24 scrn
                   <a name="Symtemp08">temp08</a>                .eq     $08
                   <a name="Symtemp09">temp09</a>                .eq     $09
                   <a name="Symtemp0a">temp0a</a>                .eq     $0a
                   <a name="Symtemp11_textlo">temp11_textlo</a>         .eq     $11                     ; often used to hold text page address of tile (lo)
                   <a name="Symtemp12_texthi">temp12_texthi</a>         .eq     $12                     ; often used to hold text page address of tile (lo)
                   <a name="Symhires_addr">hires_addr</a>            .eq     $14    {addr/2}
                   <a name="Symtileptr">tileptr</a>               .eq     $16    {addr/2}         ;pointer to current tile data
                   <a name="SymMASK">MASK</a>                  .eq     $18    {addr/1}         ;may or may not be global
                   <a name="SymplayerX">playerX</a>               .eq     $19                     ; tile X of player
                   <a name="SymplayerY">playerY</a>               .eq     $1a                     ; tile Y of player
                   <a name="SymMAPPOS">MAPPOS</a>                .eq     $1b                     ; playfield position
                   <a name="SymMAPHALF">MAPHALF</a>               .eq     $1c                     ; playfield half (top/bottom); like top bit of MAPPOS
                   <a name="Symzp1d">zp1d</a>                  .eq     $1d    {addr/2}         ; used as a read ptr when drawing player; may be anim frame via $A3
                   <a name="Symzp1f">zp1f</a>                  .eq     $1f
                   <a name="SymPLAYER">PLAYER</a>                .eq     $20                     ;active player (0-4)
                   <a name="SymtimeOfDay">timeOfDay</a>             .eq     $21                     ; 0 (early morning) .. 7 (late night)
                   <a name="SymdayNum">dayNum</a>                .eq     $22                     ; day number (1-based)
                   <a name="SymlevelSpirit">levelSpirit</a>           .eq     $23                     ; level of spirit
                   <a name="SymlevelFood">levelFood</a>             .eq     $24                     ; level of food, max limit-1
                   <a name="SymlevelRest">levelRest</a>             .eq     $25                     ; level of rest, max limit-1
                   <a name="SymlevelStamina">levelStamina</a>          .eq     $26                     ; level of stamina
                   <a name="SymlimitSpirit">limitSpirit</a>           .eq     $27                     ; spirit limit
                   <a name="SymlimitFood">limitFood</a>             .eq     $2a                     ; not shown, levelStamina/2 + 1
                   <a name="SymlimitRest">limitRest</a>             .eq     $2b                     ; not shown, levelStamina/2 + 1
                   <a name="SymmaxWeight">maxWeight</a>             .eq     $2c                     ; max weight you can carry
                   <a name="SymhomePos">homePos</a>               .eq     $2d                     ; used when teleporting player home
                   <a name="SymhomeHalf">homeHalf</a>              .eq     $2e                     ; used when teleporting player home
                   <a name="SymhomeX">homeX</a>                 .eq     $2f                     ; used when teleporting player home
                   <a name="SymhomeY">homeY</a>                 .eq     $30                     ; used when teleporting player home
                   <a name="SymMON_INVFLAG">MON_INVFLAG</a>           .eq     $32                     ;text mask (255=normal, 127=flash, 63=inv)
                   <a name="Symtemp34_npctype">temp34_npctype</a>        .eq     $34                     ; holds NPC type when $e0..$ef? Not really a temp.
                   <a name="SymdoorNeshom">doorNeshom</a>            .eq     $35                     ; FF = door goes to Neshom house, 01 = Neshom realm
                   <a name="SymspokeTo">spokeTo</a>               .eq     $37                     ; spoke to or bought from NPC while on this screen
                   <a name="SymfallaKeyOffered">fallaKeyOffered</a>       .eq     $38                     ; if D'Ol Falla's key has been offered (?)
                   <a name="SymsuppressSound0">suppressSound0</a>        .eq     $39                     ; $FF=suppress sound 0 for 1 call, set on inventory menu entry
                   <a name="SymlitLamp">litLamp</a>               .eq     $3a                     ; slot number of lit lamp, or 0 if unlit
                   <a name="SymMON_PCH">MON_PCH</a>               .eq     $3b                     ;program counter save
                   <a name="SymSTARVED">STARVED</a>               .eq     $3c                     ; 0 = ok, 1 = out of food, 2 = out of rest
                   <a name="SymGAMEOVER">GAMEOVER</a>              .eq     $3d                     ;game over bool (0/1)
                   <a name="SymvisionNum">visionNum</a>             .eq     $3e                     ; vision number to have next, 0..5
                   <a name="SymgainSpirit">gainSpirit</a>            .eq     $3f                     ; spirit gained so far, modulo 5
                   <a name="SymMON_A3H">MON_A3H</a>               .eq     $41                     ;general purpose
                   <a name="SymMON_A4L">MON_A4L</a>               .eq     $42                     ;general purpose
                   <a name="SymlampFuel">lampFuel</a>              .eq     $44                     ; number of rooms left in lamp; 00..13
                   <a name="SymMON_A5H">MON_A5H</a>               .eq     $45                     ;general purpose
                   <a name="SymSOUNDFLG">SOUNDFLG</a>              .eq     $4a                     ;0 = sound off, 1 = on
                   <a name="SymNINEIDX">NINEIDX</a>               .eq     $55                     ;cur index into $900 block
                   <a name="SymODDLINE_MASK">ODDLINE_MASK</a>          .eq     $5f    {addr/1}         ;and mask odd tile lines ($00 disables)
                   <a name="Symtileset">tileset</a>               .eq     $60    {addr/1}         ;which tileset to use, 0 or 1
                   <a name="SymHTAB">HTAB</a>                  .eq     $64                     ; horiz text pos (next line at +$28)
                   <a name="SymINVTEXT">INVTEXT</a>               .eq     $66    {addr/1}         ;0=normal,1=inverse
                   <a name="SymINSIDE">INSIDE</a>                .eq     $67                     ; Are we inside? Toggled when entering a door, or set manually on teleport.
                   <a name="Symzp6b_npcHere">zp6b_npcHere</a>          .eq     $6b                     ; NPC is on this screen? (0=no, 1=yes)
                   <a name="SymnpcX">npcX</a>                  .eq     $6c                     ; NPC X location on this screen
                   <a name="SymnpcY">npcY</a>                  .eq     $6d                     ; NPC Y location on this screen
                   <a name="Symzp6e">zp6e</a>                  .eq     $6e                     ; set in NPC code; initial from RWTSBUF+227 &amp; 0x0F
                   <a name="SymnpcFacing">npcFacing</a>             .eq     $6f                     ; NPC facing direction on this screen
                   <a name="SymWEIGHT">WEIGHT</a>                .eq     $70                     ; current item weight carried (&lt; limitWeight)
                   <a name="SymMENUCOL">MENUCOL</a>               .eq     $71                     ;menu column (0..4)
                   <a name="SymMENUROW">MENUROW</a>               .eq     $72                     ;menu row (0..3)
                   <a name="SymMENUCOL_NEXT">MENUCOL_NEXT</a>          .eq     $73                     ;next menu col, used only during movement
                   <a name="SymMENUROW_NEXT">MENUROW_NEXT</a>          .eq     $74                     ;next menu row, used only during movement
                   <a name="Symtemp75">temp75</a>                .eq     $75
                   <a name="Symtemp76">temp76</a>                .eq     $76
                   <a name="SymselItemSlot">selItemSlot</a>           .eq     $77                     ; last selected item slot (00..FE or FF)
                   <a name="SymselItemNum">selItemNum</a>            .eq     $78                     ; last selected item number (01..0E)
                   <a name="Symtemp79">temp79</a>                .eq     $79
                   <a name="Symtemp7a">temp7a</a>                .eq     $7a
                   <a name="Symtemp7b">temp7b</a>                .eq     $7b
                   <a name="SymTICKS">TICKS</a>                 .eq     $7c                     ; number of ticks until next minute (0..$FF)
                   <a name="SymMINUTES">MINUTES</a>               .eq     $7d                     ; number of minutes until next time period (0..$25)
                   <a name="Symtemp7e">temp7e</a>                .eq     $7e                     ; only used in $84CC sub
                   <a name="Symtemp7f">temp7f</a>                .eq     $7f                     ; only used in $84CC sub
                   <a name="SymtouchedWater">touchedWater</a>          .eq     $80                     ; we touched water and will pass out
                   <a name="Symtemp82">temp82</a>                .eq     $82
                   <a name="SymwaitMelody">waitMelody</a>            .eq     $83                     ; always 0, but could be interrupt placeholder
                   <a name="SymVIRTBTN">VIRTBTN</a>               .eq     $84                     ; virtual button press, used only in kbd handler
                   <a name="SymXDIR">XDIR</a>                  .eq     $85                     ;last x dir pressed, -1 (left) or 1 (right)
                   <a name="SymYDIR">YDIR</a>                  .eq     $86                     ;last y dir pressed, -1 (up) or 1 (down)
                   <a name="SymTICKING">TICKING</a>               .eq     $87                     ; 1 if timer is ticking, 0 if paused
                   <a name="SymanimTimer">animTimer</a>             .eq     $88                     ; counts up to animDelay
                   <a name="Symtemp89">temp89</a>                .eq     $89    {addr/2}
                   <a name="Symtemp8b">temp8b</a>                .eq     $8b
                   <a name="SymjumpFlag">jumpFlag</a>              .eq     $8c                     ; 1=jumping, 0=not
                   <a name="SymjumpFrame">jumpFrame</a>             .eq     $8d                     ; frame 1..4 (when jumpFlag=1)
                   <a name="SymnextRoomDir">nextRoomDir</a>           .eq     $8f                     ; 00,01,02,03,04 -- next map room direction
                   <a name="SymanimDelay">animDelay</a>             .eq     $90                     ; ticks to hold current player animation frame
                   <a name="SymFALLCNT">FALLCNT</a>               .eq     $92                     ;# of tiles we've fallen; $0A head bonked
                   <a name="SymbonkFrame">bonkFrame</a>             .eq     $93
                   <a name="SymflyFlag">flyFlag</a>               .eq     $94                     ; # 1 when flying (button pressed in air after &gt; 2 tiles fell)
                   <a name="SymFACING">FACING</a>                .eq     $95                     ;FF=left, 01=right facing
                   <a name="SymtakingStep">takingStep</a>            .eq     $96                     ; 0 or 1 depending on taking step in cycle
                   <a name="SymrunFlag">runFlag</a>               .eq     $99                     ; 1=running, 0=not
                   <a name="SymcrawlFlag">crawlFlag</a>             .eq     $9a                     ; 1=crawling, 0=not
                   <a name="SymcrouchFlag">crouchFlag</a>            .eq     $9b                     ; 1=crouching; reset on next frame
                   <a name="SymplayerXold">playerXold</a>            .eq     $9c
                   <a name="SymplayerYold">playerYold</a>            .eq     $9d
                   <a name="SymdoorTransit">doorTransit</a>           .eq     $9e                     ; 1..3 (entering onscreen door #) or 0
                   <a name="SymenterMenu">enterMenu</a>             .eq     $9f                     ; show menu on next frame
                   <a name="SymbonkAlt">bonkAlt</a>               .eq     $a1                     ; 0 or 1 to alternate bonk frames
                   <a name="SymMOVING">MOVING</a>                .eq     $a2                     ;1=moving,0=stationary
                   <a name="SymanimFrame">animFrame</a>             .eq     $a3                     ; character anim frame (see $6ED6)
                   <a name="SymanimFrame_unused">animFrame_unused</a>      .eq     $a4                     ; always $A3+1; never read, seems unused
                   <a name="SymXMOVFLG">XMOVFLG</a>               .eq     $af
                   <a name="SymYMOVFLG">YMOVFLG</a>               .eq     $b0                     ;FF=up,01=down (edge at end of action)
                   <a name="SymJOYFLG">JOYFLG</a>                .eq     $b1                     ;01 = joystick, 00 = kbd
                   <a name="SymerasePlayer">erasePlayer</a>           .eq     $b2                     ; flag to erase player on next frame
                   <a name="SymlongJump">longJump</a>              .eq     $b4                     ; 2 (stamina &gt;= 20) or 1 (stamina &lt; 20); if 2, prolongs jump in frame 3
                   <a name="SymtempB7">tempB7</a>                .eq     $b7                     ; temp used only in handle_food_rest
                   <a name="SymfoodRestTimer">foodRestTimer</a>         .eq     $b8                     ; remaining time until food/rest decreases
                   <a name="SymzpBC_bellrings">zpBC_bellrings</a>        .eq     $bc                     ; if 1, spirit bell rings, if 0, get attacked
                   <a name="SymDEMOWAIT">DEMOWAIT</a>              .eq     $c0                     ; number of frames to wait
                   <a name="SymDEMOPTR">DEMOPTR</a>               .eq     $c2                     ; ptr to current demo byte
                   <a name="SymDEMOFLG">DEMOFLG</a>               .eq     $c4                     ; 00 = game, 01 = demo mode
                   <a name="SymDEMOTEXT">DEMOTEXT</a>              .eq     $c8                     ; demo text to show (1..5, or 0 = none)
                   <a name="SymtileFeet">tileFeet</a>              .eq     $e0                     ;  0, 0 tile at player's feet
                   <a name="SymtileFeetLeft">tileFeetLeft</a>          .eq     $e1                     ; -1, 0 tile left of player's feet
                   <a name="SymtileFeetRight">tileFeetRight</a>         .eq     $e2                     ;  1, 0 tile right of player's feet
                   <a name="SymtileUnder">tileUnder</a>             .eq     $e3                     ;  0, 1 tile under player's feet
                   <a name="SymtileUnderLeft">tileUnderLeft</a>         .eq     $e4                     ; -1, 1 left tile under player's feet
                   <a name="SymtileUnderRight">tileUnderRight</a>        .eq     $e5                     ;  1, 1 right tile under player's feet
                   <a name="SymtileKnee">tileKnee</a>              .eq     $e6                     ;  0,-1 tile 1 above player's feet
                   <a name="SymtileArm">tileArm</a>               .eq     $e7                     ;  0,-2 tile 2 at arm height (item on table/shelf)
                   <a name="SymtileShoulder">tileShoulder</a>          .eq     $e8                     ;  0,-3 tile at shoulder height
                   <a name="SymtileArmLeft">tileArmLeft</a>           .eq     $e9                     ; -1,-2 tile left at arm level (table/shelf)
                   <a name="SymtileArmRight">tileArmRight</a>          .eq     $ea                     ;  1,-2 tile right at arm level (table/shelf)
                   <a name="SymySolid">ySolid</a>                .eq     $f0                     ; selected tile is solid ground
                   <a name="SymxSolid">xSolid</a>                .eq     $f1                     ; selected tile prevents x motion
                   <a name="Symclimbable">climbable</a>             .eq     $f2                     ; selected tile is a ladder/vine
                   <a name="Symdigits">digits</a>                .eq     $f9    {addr/5}         ; decimal digit output of num_to_str
                   <a name="SymRWTSBUF">RWTSBUF</a>               .eq     $0200  {addr/256}       ; 256-byte sector r/w buffer
                   <a name="SymRWTSBUF_npc">RWTSBUF_npc</a>           .eq     $02e1                   ; nonzero if NPC is present; may contain data in top 4 bits
                   <a name="SymRWTSBUF_npcX">RWTSBUF_npcX</a>          .eq     $02e4                   ; NPC initial X location
                   <a name="SymRWTSBUF_npcY">RWTSBUF_npcY</a>          .eq     $02e5                   ; NPC initial Y location
                   <a name="SymRWTSBUF_npcnum">RWTSBUF_npcnum</a>        .eq     $02f1                   ; NPC number (00..??)  ; $49 raamo
                   <a name="SymRWTSBUF_npctype">RWTSBUF_npctype</a>       .eq     $02f2                   ; 0 offers item, 1 animal, $d0 dol falla, $40 gain level, $20-$2f ??, $c0 door 1, $c1 door 2, $e0-$ef,
                   <a name="SymRWTS_IOB_track">RWTS_IOB_track</a>        .eq     $0304
                   <a name="SymRWTS_IOB_sector">RWTS_IOB_sector</a>       .eq     $0305
                   <a name="SymRWTS_IOB_buf">RWTS_IOB_buf</a>          .eq     $0308
                   <a name="SymRWTS_IOB_command">RWTS_IOB_command</a>      .eq     $030c
                   <a name="SymDIRECT_RWTS">DIRECT_RWTS</a>           .eq     $0315
                   <a name="SymSCREEN_0900">SCREEN_0900</a>           .eq     $0900
                   <a name="SymGAME1_player_names">GAME1_player_names</a>    .eq     $1ad0
                   <a name="SymGAME1_tileset_bitmap">GAME1_tileset_bitmap</a>  .eq     $1d00
                   <a name="SymGAME1_hireslo">GAME1_hireslo</a>         .eq     $1d40
                   <a name="SymGAME1_hireshi">GAME1_hireshi</a>         .eq     $1d60
                   <a name="SymGAME1_texthi">GAME1_texthi</a>          .eq     $1d80
                   <a name="SymGAME1_textlo">GAME1_textlo</a>          .eq     $1da0
                   <a name="SymGAME1_BITTAB0">GAME1_BITTAB0</a>         .eq     $1db8
                   <a name="SymGAME1_BITTAB1">GAME1_BITTAB1</a>         .eq     $1db9
                   <a name="SymGAME1_BITTAB2">GAME1_BITTAB2</a>         .eq     $1dba
                   <a name="SymGAME1_BITTAB3">GAME1_BITTAB3</a>         .eq     $1dbb
                   <a name="SymGAME1_BITTAB4">GAME1_BITTAB4</a>         .eq     $1dbc
                   <a name="SymGAME1_BITTAB5">GAME1_BITTAB5</a>         .eq     $1dbd
                   <a name="SymGAME1_BITTAB6">GAME1_BITTAB6</a>         .eq     $1dbe
                   <a name="SymGAME1_BITTAB7">GAME1_BITTAB7</a>         .eq     $1dbf
                   <a name="SymGAME1_player_stats">GAME1_player_stats</a>    .eq     $1dc0
                   <a name="SymGAME1_odd_col_mask">GAME1_odd_col_mask</a>    .eq     $1fa0
                   <a name="SymGAME1_even_col_mask">GAME1_even_col_mask</a>   .eq     $1fb0
                   <a name="SymGAME1_odd_col_even_line_mask">GAME1_odd_col_even_line_mask</a> .eq $1fc0
                   <a name="SymGAME1_even_col_even_line_mask">GAME1_even_col_even_line_mask</a> .eq $1fd0
                   <a name="SymGAME1_odd_col_odd_line_mask">GAME1_odd_col_odd_line_mask</a> .eq $1fe0
                   <a name="SymGAME1_even_col_odd_line_mask">GAME1_even_col_odd_line_mask</a> .eq $1ff0
                   <a name="SymGAME1_chardata">GAME1_chardata</a>        .eq     $2c00
                   <a name="SymGAME1_tileset1_masks">GAME1_tileset1_masks</a>  .eq     $2e00
                   <a name="SymGAME1_tileset0_masks">GAME1_tileset0_masks</a>  .eq     $3700
                   <a name="SymSCRN_demo_handler">SCRN_demo_handler</a>     .eq     $9600
                   <a name="SymSCRN_show_demo_text">SCRN_show_demo_text</a>   .eq     $9603
                   <a name="SymSCRN_heal">SCRN_heal</a>             .eq     $9c00
                   <a name="SymSCRN_grunspreke">SCRN_grunspreke</a>       .eq     $9c03
                   <a name="SymSCRN_kiniport">SCRN_kiniport</a>         .eq     $9c06
                   <a name="SymSCRN_speak">SCRN_speak</a>            .eq     $9c0c
                   <a name="SymSCRN_pense">SCRN_pense</a>            .eq     $9c0f
                   <a name="SymSCRN_sell">SCRN_sell</a>             .eq     $9c15
                   <a name="SymSCRN_offer">SCRN_offer</a>            .eq     $9c18
                   <a name="SymSCRN_triumph_melody">SCRN_triumph_melody</a>   .eq     $9c1e
                   <a name="SymSCRN_warm_start">SCRN_warm_start</a>       .eq     $a840
                   <a name="SymSCRN_sound_status">SCRN_sound_status</a>     .eq     $a849
                   <a name="Symstate_npc1">state_npc1</a>            .eq     $b200
                   <a name="Symstate_npc">state_npc</a>             .eq     $b280                   ; per npc bitfield; 7=gained a level from this NPC; 0..6=last spoken daynum or 0..4=time of day (NPC $E0..$EF)
                   <a name="SymitemStatePos">itemStatePos</a>          .eq     $b300  {addr/256}       ; 256 map positions, one per item
                   <a name="SymitemStateCol">itemStateCol</a>          .eq     $b400  {addr/256}       ; 256 column tile positions, one per item
                   <a name="SymitemState">itemState</a>             .eq     $b500  {addr/256}       ; 7=mappos high bit, 6=in world, 5=in inv, 4..0=map row
                   <a name="Syminv_shuba">inv_shuba</a>             .eq     $b558  {addr/20}
                   <a name="Syminv_token">inv_token</a>             .eq     $b56c  {addr/75}
                   <a name="SymSCRN_play_melody">SCRN_play_melody</a>      .eq     $b600
                   <a name="SymSCRN_play_sound">SCRN_play_sound</a>       .eq     $b603
                   <a name="SymSCRN_play_sound_0">SCRN_play_sound_0</a>     .eq     $b606
                   <a name="SymSCRN_chkkey">SCRN_chkkey</a>           .eq     $b609
                   <a name="SymBUTN0">BUTN0</a>                 .eq     $c061                   ;R switch input 0 / open-apple
                   <a name="SymBUTN1">BUTN1</a>                 .eq     $c062                   ;R switch input 1 / closed-apple
                   <a name="SymMON_PREAD">MON_PREAD</a>             .eq     $fb1e                   ;read paddle specifed by X-reg, return in Y-reg

                                         .org    $6000
6000: 4c 00 5b                           jmp     $5b00

                   ; Common external entry vectors for intermodule jumps.
6003: 4c a9 67     <a name="SymGAME2_drawtile">GAME2_drawtile</a>        jmp     <a href="#Symdrawtile">drawtile</a>

6006: 4c e6 63     <a name="SymGAME2_cleartext">GAME2_cleartext</a>       jmp     <a href="#Symcleartext">cleartext</a>

                   <a name="SymGAME2_write_tiles_to_text">GAME2_write_tiles_to_text</a>
6009: 4c 8b 64                           jmp     <a href="#Symwrite_tiles_to_text">write_tiles_to_text</a>     ;local only

600c: 4c d6 66     <a name="SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>         jmp     <a href="#SymPRNTSTR">PRNTSTR</a>

600f: 4c 09 67     <a name="SymGAME2_printchar">GAME2_printchar</a>       jmp     <a href="#Symprintchar">printchar</a>

6012: 4c e1 69     <a name="SymGAME2_delayXtimes256">GAME2_delayXtimes256</a>  jmp     <a href="#SymdelayXtimes256">delayXtimes256</a>

6015: 4c a2 69     <a name="SymGAME2_swapzp8">GAME2_swapzp8</a>         jmp     <a href="#Symswapzp8">swapzp8</a>

6018: 4c 6c 67                           jmp     <a href="#Symdrawfield">drawfield</a>               ;vector never used

601b: 4c a3 66     <a name="SymGAME2_teleport_home">GAME2_teleport_home</a>   jmp     <a href="#Symteleport_home">teleport_home</a>           ;local only

601e: 4c 3c 64     <a name="SymGAME2_read_playfield">GAME2_read_playfield</a>  jmp     <a href="#Symread_playfield">read_playfield</a>

6021: 4c 63 61     <a name="SymGAME2_read_0900">GAME2_read_0900</a>       jmp     <a href="#Symread_0900_next">read_0900_next</a>          ;read next byte at $0900

6024: 4c 00 b6     <a name="SymGAME2_play_melody">GAME2_play_melody</a>     jmp     <a href="#SymSCRN_play_melody">SCRN_play_melody</a>

6027: 4c 57 60     <a name="SymGAME2_intro">GAME2_intro</a>           jmp     <a href="#Symintro">intro</a>?

602a: 4c a3 61                           jmp     <a href="#Symmove_room">move_room</a>

602d: 4c 52 61                           jmp     @cont

6030: 4c b6 69     <a name="SymGAME2_copypages">GAME2_copypages</a>       jmp     <a href="#Symcopypages">copypages</a>

6033: 4c cf 69     <a name="SymGAME2_clearpages">GAME2_clearpages</a>      jmp     <a href="#Symclearpages">clearpages</a>

6036: 4c ea 69     <a name="SymGAME2_delay2">GAME2_delay2</a>          jmp     <a href="#Symdelay2">delay2</a>

6039: 4c 6f 61     <a name="SymGAME2_player_init">GAME2_player_init</a>     jmp     <a href="#Symplayer_init">player_init</a>             ;vector never used

603c: 4c 77 60                           jmp     <a href="#SymL6077">L6077</a>

603f: 4c bf 6a     <a name="SymGAME2_init_item_state">GAME2_init_item_state</a> jmp     <a href="#Syminit_item_state">init_item_state</a>         ;Read T22,S00..02 into $B300..$B5FF

                   <a name="SymGAME2_calc_hires_textpos">GAME2_calc_hires_textpos</a>
6042: 4c 5b 68                           jmp     <a href="#Symcalc_hires_textpos">calc_hires_textpos</a>

6045: 4c b3 67     <a name="SymGAME2_writetile">GAME2_writetile</a>       jmp     <a href="#Symwritetile">writetile</a>

6048: 4c 82 60                           jmp     <a href="#Symgame_loop">game_loop</a>?

604b: 4c 7f 64     <a name="SymL604B">L604B</a>                 jmp     <a href="#SymL647F">L647F</a>                   ;might redraw screen after drop/take lamp

                   ; MENUFLG is non-zero. Pop up menu, await selection, and return.
604e: 20 00 77     <a name="Symenter_menu">enter_menu</a>            jsr     <a href="#SymGAME2_action_menu">GAME2_action_menu</a>
6051: a9 00                              lda     #$00
6053: 85 9f                              sta     <a href="#SymenterMenu">enterMenu</a>
6055: f0 2b                              beq     <a href="#Symgame_loop">game_loop</a>?              ;always

6057: 20 8e 62     <a name="Symintro">intro?</a>                jsr     <a href="#SymL628E">L628E</a>                   ;might be general game loop
605a: a5 c9                              lda     $c9
605c: c9 0d                              cmp     #$0d                    ;$c9 == #$0d during intro
605e: d0 17                              bne     <a href="#SymL6077">L6077</a>
6060: 20 e6 63                           jsr     <a href="#Symcleartext">cleartext</a>
6063: a9 01                              lda     #$01                    ;set demo mode
6065: 85 c4                              sta     <a href="#SymDEMOFLG">DEMOFLG</a>
6067: a5 d0                              lda     $d0
6069: 10 09                              bpl     <a href="#SymL6074">L6074</a>                   ;if in gameplay mode (??)
606b: 20 e8 62                           jsr     <a href="#SymL62E8">L62E8</a>
606e: 20 8e 62                           jsr     <a href="#SymL628E">L628E</a>
6071: 4c 77 60                           jmp     <a href="#SymL6077">L6077</a>

6074: 20 b2 62     <a name="SymL6074">L6074</a>                 jsr     <a href="#SymL62B2">L62B2</a>
6077: 20 9f 62     <a name="SymL6077">L6077</a>                 jsr     <a href="#SymL629F">L629F</a>
607a: a9 00                              lda     #$00
607c: 85 88                              sta     <a href="#SymanimTimer">animTimer</a>
607e: a9 08                              lda     #$08
6080: 85 90                              sta     <a href="#SymanimDelay">animDelay</a>
                   <span style="background-color: #cbcb00">NOTE: Multiple entries</span>
6082: a9 01        <a name="Symgame_loop">game_loop?</a>            lda     #$01                    ;start game timer
6084: 85 87                              sta     <a href="#SymTICKING">TICKING</a>
6086: 20 00 6b     <a name="Symtick0">tick0</a>                 jsr     <a href="#SymGAME2_next_frame">GAME2_next_frame</a>        ;entered from multiple subs
6089: a2 0a                              ldx     #$0a
608b: a5 6b                              lda     <a href="#Symzp6b_npcHere">zp6b_npcHere</a>            ;check $6b
608d: f0 02                              beq     @delay                  ;0, delay $0A * 256
608f: a2 06                              ldx     #$06                    ;!0, delay $06 * 256, allowing more time for NPC CPU?
6091: 20 e1 69     @delay                jsr     <a href="#SymdelayXtimes256">delayXtimes256</a>          ;delay X * 256
6094: a5 87                              lda     <a href="#SymTICKING">TICKING</a>
6096: d0 ee                              bne     <a href="#Symtick0">tick0</a>
6098: a5 8f                              lda     <a href="#SymnextRoomDir">nextRoomDir</a>
609a: d0 48                              bne     <a href="#Symmove_next_room">move_next_room</a>
                   ; Below is a state machine which checks several flags/values in zero page in
                   ; order, and performs the first non-zero action it finds.
609c: a5 9e                              lda     <a href="#SymdoorTransit">doorTransit</a>             ;transiting a door? (1..3)
609e: f0 03                              beq     @check_menu_entry
60a0: 4c d6 61                           jmp     <a href="#SymenterDoor">enterDoor</a>

60a3: a5 9f        @check_menu_entry     lda     <a href="#SymenterMenu">enterMenu</a>               ;enter menu on this frame?
60a5: f0 03                              beq     @no
60a7: 4c 4e 60                           jmp     <a href="#Symenter_menu">enter_menu</a>

60aa: a5 80        @no                   lda     <a href="#SymtouchedWater">touchedWater</a>
60ac: f0 06                              beq     <a href="#SymL60B4">L60B4</a>
60ae: 4c 6c 66                           jmp     <a href="#Symfound_near_water">found_near_water</a>

60b1: 4c                                 .dd1    $4c
60b2: 86                                 .dd1    $86
60b3: 60                                 .dd1    $60

60b4: a5 c6        <a name="SymL60B4">L60B4</a>                 lda     $c6
60b6: f0 03                              beq     <a href="#SymL60BB">L60BB</a>
60b8: 4c 0e 63                           jmp     <a href="#SymL630E">L630E</a>

                   ; Show demo text on this frame if DEMOTEXT is 1..5. Otherwise continue.
                   ; Note that demo text 5 is clears text; 0 simply checks the next action.
60bb: a5 c8        <a name="SymL60BB">L60BB</a>                 lda     <a href="#SymDEMOTEXT">DEMOTEXT</a>                ;demo text to show 1..5, or 0 for not demo
60bd: f0 0a                              beq     <a href="#Symcheck_gameover">check_gameover</a>
60bf: 20 03 96                           jsr     <a href="#SymSCRN_show_demo_text">SCRN_show_demo_text</a>
60c2: a9 00                              lda     #$00                    ;do not update on next frame
60c4: 85 c8                              sta     <a href="#SymDEMOTEXT">DEMOTEXT</a>
60c6: 4c 82 60                           jmp     <a href="#Symgame_loop">game_loop</a>?

60c9: a5 3d        <a name="Symcheck_gameover">check_gameover</a>        lda     <a href="#SymGAMEOVER">GAMEOVER</a>
60cb: f0 03                              beq     <a href="#Symcheck_starvation">check_starvation</a>
60cd: 4c 36 6a                           jmp     <a href="#Symgame_over">game_over</a>

60d0: a5 3c        <a name="Symcheck_starvation">check_starvation</a>      lda     <a href="#SymSTARVED">STARVED</a>
60d2: f0 03                              beq     <a href="#Symcheck_spirit_bell_rings">check_spirit_bell_rings</a> ;we're fine
60d4: 4c 66 63                           jmp     <a href="#Symspent_a_day_recovering">spent_a_day_recovering</a>  ;starved of food or rest

                   <a name="Symcheck_spirit_bell_rings">check_spirit_bell_rings</a>
60d7: a5 bc                              lda     <a href="#SymzpBC_bellrings">zpBC_bellrings</a>
60d9: f0 03                              beq     @get_attacked
60db: 4c f4 69                           jmp     <a href="#Symspirit_bell_rings">spirit_bell_rings</a>

60de: 20 1e 77     @get_attacked         jsr     <a href="#SymGAME2_attacked">GAME2_attacked</a>          ;unclear when this happens
60e1: 4c 82 60                           jmp     <a href="#Symgame_loop">game_loop</a>?

                   ; Based on the value in nextRoomDir, update the user's map position by 1 offset
                   ; to the top (01), right (02), bottom (03) or left (04). Then load the new room
                   ; and continue.
60e4: a5 8f        <a name="Symmove_next_room">move_next_room</a>        lda     <a href="#SymnextRoomDir">nextRoomDir</a>             ;this was already in A, in fact
60e6: c9 01                              cmp     #$01
60e8: d0 15                              bne     <a href="#SymL60FF">L60FF</a>
60ea: 38                                 sec
60eb: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>
60ed: e9 20                              sbc     #$20
60ef: 85 1b                              sta     <a href="#SymMAPPOS">MAPPOS</a>
60f1: b0 02                              bcs     <a href="#SymL60F5">L60F5</a>
60f3: c6 1c                              dec     <a href="#SymMAPHALF">MAPHALF</a>
60f5: 20 a3 61     <a name="SymL60F5">L60F5</a>                 jsr     <a href="#Symmove_room">move_room</a>
60f8: a9 12                              lda     #$12
60fa: 85 1a                              sta     <a href="#SymplayerY">playerY</a>
60fc: 4c 52 61                           jmp     @cont

60ff: c9 02        <a name="SymL60FF">L60FF</a>                 cmp     #$02
6101: d0 1d                              bne     <a href="#SymL6120">L6120</a>
6103: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>
6105: 29 1f                              and     #$1f
6107: c9 1f                              cmp     #$1f
6109: d0 09                              bne     <a href="#SymL6114">L6114</a>
610b: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>
610d: 29 e0                              and     #$e0
610f: 85 1b                              sta     <a href="#SymMAPPOS">MAPPOS</a>
6111: 4c 16 61                           jmp     <a href="#SymL6116">L6116</a>

6114: e6 1b        <a name="SymL6114">L6114</a>                 inc     <a href="#SymMAPPOS">MAPPOS</a>
6116: 20 a3 61     <a name="SymL6116">L6116</a>                 jsr     <a href="#Symmove_room">move_room</a>
6119: a9 00                              lda     #$00
611b: 85 19                              sta     <a href="#SymplayerX">playerX</a>
611d: 4c 52 61                           jmp     @cont

6120: c9 03        <a name="SymL6120">L6120</a>                 cmp     #$03
6122: d0 15                              bne     <a href="#SymL6139">L6139</a>
6124: 18                                 clc
6125: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>
6127: 69 20                              adc     #$20
6129: 85 1b                              sta     <a href="#SymMAPPOS">MAPPOS</a>
612b: 90 02                              bcc     <a href="#SymL612F">L612F</a>
612d: e6 1c                              inc     <a href="#SymMAPHALF">MAPHALF</a>
612f: 20 a3 61     <a name="SymL612F">L612F</a>                 jsr     <a href="#Symmove_room">move_room</a>
6132: a9 00                              lda     #$00
6134: 85 1a                              sta     <a href="#SymplayerY">playerY</a>
6136: 4c 52 61                           jmp     @cont

6139: a5 1b        <a name="SymL6139">L6139</a>                 lda     <a href="#SymMAPPOS">MAPPOS</a>
613b: 29 1f                              and     #$1f
613d: d0 0a                              bne     <a href="#SymL6149">L6149</a>
613f: 18                                 clc
6140: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>
6142: 69 1f                              adc     #$1f
6144: 85 1b                              sta     <a href="#SymMAPPOS">MAPPOS</a>
6146: 4c 4b 61                           jmp     <a href="#SymL614B">L614B</a>

6149: c6 1b        <a name="SymL6149">L6149</a>                 dec     <a href="#SymMAPPOS">MAPPOS</a>
614b: 20 a3 61     <a name="SymL614B">L614B</a>                 jsr     <a href="#Symmove_room">move_room</a>
614e: a9 27                              lda     #$27
6150: 85 19                              sta     <a href="#SymplayerX">playerX</a>
6152: a9 00        @cont                 lda     #$00
6154: 85 8f                              sta     <a href="#SymnextRoomDir">nextRoomDir</a>
6156: 20 03 6b                           jsr     <a href="#SymGAME2_draw_player">GAME2_draw_player</a>
6159: 20 82 68                           jsr     <a href="#Symhandle_npc2">handle_npc2</a>?
615c: a9 01                              lda     #$01                    ;resume tick, stopped when we started room transition
615e: 85 87                              sta     <a href="#SymTICKING">TICKING</a>
6160: 4c 86 60                           jmp     <a href="#Symtick0">tick0</a>

                   ; Read next byte in $0900 block (pointed to by $55) and return it in A.
                   ; The $55 ptr is (pre)incremented. All access to $55 is encapsulated here.
                   xsav                  .var    $1e    {addr/1}         ;save x

6163: 86 1e        <a name="Symread_0900_next">read_0900_next</a>        stx     xsav
6165: e6 55                              inc     <a href="#SymNINEIDX">NINEIDX</a>
6167: a6 55                              ldx     <a href="#SymNINEIDX">NINEIDX</a>
6169: bd 00 09                           lda     <a href="#SymSCREEN_0900">SCREEN_0900</a>,x
616c: a6 1e                              ldx     xsav
616e: 60                                 rts

                   ; Init player. Copies player's starting stats to active stats, resets the time,
                   ; and sets carry weight to 0 (note: inventory is not zeroed out here). The demo
                   ; player (5) has a shuba added.
616f: a6 20        <a name="Symplayer_init">player_init</a>           ldx     <a href="#SymPLAYER">PLAYER</a>
6171: a5 c4                              lda     <a href="#SymDEMOFLG">DEMOFLG</a>
6173: f0 07                              beq     @notdemo
6175: a2 05                              ldx     #$05                    ;phantom character 5 during demo
6177: a9 60                              lda     #%01100000              ;give the demo player a shuba
6179: 8d 58 b5                           sta     <a href="#Syminv_shuba">inv_shuba</a>
617c: bc 9d 61     @notdemo              ldy     <a href="#Symplayer_stat_offsets">player_stat_offsets</a>,x
617f: a2 0d                              ldx     #$0d                    ;copy $0E bytes from player stats to cur stats
6181: b9 c0 1d     @loop                 lda     <a href="#SymGAME1_player_stats">GAME1_player_stats</a>,y    ;pointer to END of player's stats
6184: 95 23                              sta     <a href="#SymlevelSpirit">levelSpirit</a>,x
6186: 88                                 dey                             ;copy from end to beginning
6187: ca                                 dex
6188: 10 f7                              bpl     @loop
618a: a9 00                              lda     #$00
618c: 85 21                              sta     <a href="#SymtimeOfDay">timeOfDay</a>
618e: 85 70                              sta     <a href="#SymWEIGHT">WEIGHT</a>
6190: 85 3e                              sta     <a href="#SymvisionNum">visionNum</a>
6192: 85 3f                              sta     <a href="#SymgainSpirit">gainSpirit</a>
6194: a9 01                              lda     #$01
6196: 85 22                              sta     <a href="#SymdayNum">dayNum</a>
6198: a9 23                              lda     #$23
619a: 85 7d                              sta     <a href="#SymMINUTES">MINUTES</a>
619c: 60                                 rts

                   ; Offset to END of player stats. E.g. $0D = $00..$0D, $1B = $0E..$1B.
619d: 0d           <a name="Symplayer_stat_offsets">player_stat_offsets</a>   .dd1    $0d
619e: 1b                                 .dd1    $1b
619f: 29                                 .dd1    $29
61a0: 37                                 .dd1    $37
61a1: 45                                 .dd1    $45
61a2: 53                                 .dd1    $53

                   ; Called when moving to another room. This will expend 1 lamp fuel (if the lamp
                   ; is lit), destroy your lit lamp if it runs out of fuel, and then read the new
                   ; room data from disk.
61a3: a5 44        <a name="Symmove_room">move_room</a>             lda     <a href="#SymlampFuel">lampFuel</a>
61a5: f0 14                              beq     <a href="#SymL61BB">L61BB</a>                   ;already out of fuel
61a7: c6 44                              dec     <a href="#SymlampFuel">lampFuel</a>
61a9: d0 10                              bne     <a href="#SymL61BB">L61BB</a>                   ;still has fuel left
61ab: a6 3a                              ldx     <a href="#SymlitLamp">litLamp</a>                 ;lamp goes out
61ad: a9 00                              lda     #$00
61af: 85 3a                              sta     <a href="#SymlitLamp">litLamp</a>
61b1: 9d 00 b5                           sta     <a href="#SymitemState">itemState</a>,x             ;destroy lamp item
61b4: 8a                                 txa
61b5: 20 03 77                           jsr     <a href="#SymGAME2_slot_to_item">GAME2_slot_to_item</a>
61b8: 20 12 77                           jsr     <a href="#SymGAME2_lose_weight">GAME2_lose_weight</a>       ;remove its weight
61bb: 20 06 6b     <a name="SymL61BB">L61BB</a>                 jsr     <a href="#SymGAME2_erase_player">GAME2_erase_player</a>
61be: a5 67                              lda     <a href="#SymINSIDE">INSIDE</a>
61c0: d0 05                              bne     @light
61c2: 20 15 64                           jsr     <a href="#Symselect_tileset_harder">select_tileset_harder</a>
61c5: f0 04                              beq     @dark
61c7: 20 3c 64     @light                jsr     <a href="#Symread_playfield">read_playfield</a>
61ca: 60                                 rts

61cb: a9 00        @dark                 lda     #$00
61cd: 8d e1 02                           sta     <a href="#SymRWTSBUF_npc">RWTSBUF_npc</a>             ;remove NPC presence by overwriting read map data
61d0: 20 c1 63                           jsr     <a href="#Symclearfield">clearfield</a>
61d3: 4c 82 68                           jmp     <a href="#Symhandle_npc2">handle_npc2</a>?

                   ********************************************************************************
                   * $9E is non-zero here, implying we are transiting a door. The next 2          *
                   * subroutines are special teleports, based on whether $35 is FF or 01. That's  *
                   * because when you sleep in D'Ol Neshom's house, the door changes to send you  *
                   * to the cloud realm (01), and the return door sends you back to her house     *
                   * (FF). (It's possible the return door must be handled specially because it's  *
                   * not a standard door tile, so can't use normal door teleporting, but          *
                   * uncertain.)                                                                  *
                   *                                                                              *
                   * If $35 is 0, branch to the 3rd sub, which handles doors and repositioning    *
                   * more generally.                                                              *
                   ********************************************************************************
61d6: a5 35        <a name="SymenterDoor">enterDoor</a>             lda     <a href="#SymdoorNeshom">doorNeshom</a>
61d8: f0 2e                              beq     @normal_door            ;zero, handle regular doors
                   ; 01 sends you to the cloud realm where D'Ol Neshom gives you the spirit bell.
61da: 30 17                              bmi     @to_dol_neshom          ;FF, go to her house
61dc: a9 be                              lda     #$be                    ;otherwise, teleport
61de: 85 1b                              sta     <a href="#SymMAPPOS">MAPPOS</a>
61e0: a9 12                              lda     #$12
61e2: 85 19                              sta     <a href="#SymplayerX">playerX</a>
61e4: a9 0e                              lda     #$0e
61e6: 85 1a                              sta     <a href="#SymplayerY">playerY</a>
61e8: a9 00                              lda     #$00
61ea: 85 67                              sta     <a href="#SymINSIDE">INSIDE</a>
61ec: a9 ff                              lda     #$ff                    ;next door takes you back
61ee: 85 35                              sta     <a href="#SymdoorNeshom">doorNeshom</a>              ;to her house
61f0: 4c 68 62                           jmp     <a href="#Symdo_door_entry">do_door_entry</a>

                   ; FF sends you to the D'Ol Neshom's small house in the high trees where if you
                   ; sleep, you are transported to a cloud realm and she grants you the spirit
                   ; bell.
61f3: a9 09        @to_dol_neshom        lda     #$09
61f5: 85 1b                              sta     <a href="#SymMAPPOS">MAPPOS</a>
61f7: a9 18                              lda     #$18
61f9: 85 19                              sta     <a href="#SymplayerX">playerX</a>
61fb: a9 0d                              lda     #$0d
61fd: 85 1a                              sta     <a href="#SymplayerY">playerY</a>
61ff: a9 00                              lda     #$00
6201: 85 67                              sta     <a href="#SymINSIDE">INSIDE</a>
6203: 85 35                              sta     <a href="#SymdoorNeshom">doorNeshom</a>
6205: 4c 68 62                           jmp     <a href="#Symdo_door_entry">do_door_entry</a>

                   <span style="background-color: #72be72">NOTE: Handles, I think, entering doors. Checks $02F2 for $C0/C1, which I think</span>
                   <span style="background-color: #72be72">signify 2 types of locked doors. Then checks a location in game storage,</span>
                   <span style="background-color: #72be72">probably whether the player has one of 2 keys, and a final zp location which is</span>
                   <span style="background-color: #72be72">unknown. </span>
                   <span style="background-color: #72be72"></span>
                   <span style="background-color: #72be72">If the door is unlocked, OR $02F2 is any other value, then teleports the user to</span>
                   <span style="background-color: #72be72">the new map position. It's unclear what the other values mean.</span>
                   <span style="background-color: #72be72"></span>
                   <span style="background-color: #72be72">From 02F3..F5, 02F6..8, or 02F9..B are a position triple consisting of the new</span>
                   <span style="background-color: #72be72">map position (including high bit), and probably character X and Y. Which one to</span>
                   <span style="background-color: #72be72">use is determined by $9E (unclear why).</span>
6208: ad f2 02     @normal_door          lda     <a href="#SymRWTSBUF_npctype">RWTSBUF_npctype</a>
620b: c9 c0                              cmp     #$c0                    ;possibly locked door, or presence of certain NPC
620d: d0 2a                              bne     <a href="#SymL6239">L6239</a>
620f: ad 34 b2                           lda     $b234                   ;0=possibly locked (either has_key, or door_unlocked)
6212: d0 2e                              bne     <a href="#SymL6242">L6242</a>
6214: a5 42        <a name="SymL6214">L6214</a>                 lda     <a href="#SymMON_A4L">MON_A4L</a>                 ;0=locked (either has_key, or door_unlocked)
6216: d0 2a                              bne     <a href="#SymL6242">L6242</a>
6218: 20 d6 66                           jsr     <a href="#SymPRNTSTR">PRNTSTR</a>
621b: 01                                 .dd1    $01
621c: d4 c8 c5 a0+                       .str    THE DOOR IS LOCKED
622e: ff                                 .dd1    $ff
622f: 20 06 77                           jsr     <a href="#SymGAME2_message_wait">GAME2_message_wait</a>
6232: a9 00                              lda     #$00
6234: 85 9e                              sta     <a href="#SymdoorTransit">doorTransit</a>             ;note $9e is 1..3 below
6236: 4c 82 60                           jmp     <a href="#Symgame_loop">game_loop</a>?

6239: c9 c1        <a name="SymL6239">L6239</a>                 cmp     #$c1                    ;possibly locked door, or presence of certain NPC
623b: d0 05                              bne     <a href="#SymL6242">L6242</a>
623d: ad 35 b2                           lda     $b235                   ;possibly inventory check for this key
6240: f0 d2                              beq     <a href="#SymL6214">L6214</a>
6242: a4 9e        <a name="SymL6242">L6242</a>                 ldy     <a href="#SymdoorTransit">doorTransit</a>             ;Y is 1..3 here (on entry must be nonzero)
6244: be 8a 62                           ldx     @posptr-1,y
6247: bd 01 02                           lda     <a href="#SymRWTSBUF">RWTSBUF</a>+1,x
624a: 85 1b                              sta     <a href="#SymMAPPOS">MAPPOS</a>                  ;first byte is map position
624c: a0 00                              ldy     #$00
624e: bd 02 02                           lda     <a href="#SymRWTSBUF">RWTSBUF</a>+2,x             ;second byte is map side (bit 7) + something (0..6)
6251: 48                                 pha
6252: 29 80                              and     #$80                    ;check bit 7
6254: f0 01                              beq     <a href="#SymL6257">L6257</a>                   ;bit 7 unset, MAPSIDE=0
6256: c8                                 iny
6257: 84 1c        <a name="SymL6257">L6257</a>                 sty     <a href="#SymMAPHALF">MAPHALF</a>                 ;bit 7 set, MAPSIDE=1
6259: 68                                 pla
625a: 29 7f                              and     #$7f                    ;bits 0..6 of second byte
625c: 85 19                              sta     <a href="#SymplayerX">playerX</a>
625e: bd 03 02                           lda     <a href="#SymRWTSBUF">RWTSBUF</a>+3,x
6261: 29 7f                              and     #$7f                    ;bits 0..6 of third byte
6263: 85 1a                              sta     <a href="#SymplayerY">playerY</a>
6265: 20 06 6b                           jsr     <a href="#SymGAME2_erase_player">GAME2_erase_player</a>
6268: 20 3c 64     <a name="Symdo_door_entry">do_door_entry</a>         jsr     <a href="#Symread_playfield">read_playfield</a>          ;read new map screen from disk
626b: a9 00                              lda     #$00                    ;Toggle FACING between 01 and FF
626d: 38                                 sec                             ;so the player faces the opposite direction
626e: e5 95                              sbc     <a href="#SymFACING">FACING</a>                  ;when entering/exiting a door
6270: 85 95                              sta     <a href="#SymFACING">FACING</a>
6272: 20 21 6b                           jsr     <a href="#SymL6B21">L6B21</a>
6275: 20 03 6b                           jsr     <a href="#SymGAME2_draw_player">GAME2_draw_player</a>
6278: 20 82 68                           jsr     <a href="#Symhandle_npc2">handle_npc2</a>?
627b: a9 00                              lda     #$00                    ;reset triple posptr to 0
627d: 85 9e                              sta     <a href="#SymdoorTransit">doorTransit</a>
627f: a5 67                              lda     <a href="#SymINSIDE">INSIDE</a>
6281: 49 01                              eor     #$01                    ;bitflip
6283: 85 67                              sta     <a href="#SymINSIDE">INSIDE</a>
6285: 20 20 6a                           jsr     <a href="#SymL6A20">L6A20</a>
6288: 4c 82 60                           jmp     <a href="#Symgame_loop">game_loop</a>?

628b: f2           @posptr               .dd1    $f2                     ;$2f3,$2f4,$2f5
628c: f5                                 .dd1    $f5                     ;$2f6,$2f7,$2f8
628d: f8                                 .dd1    $f8                     ;$2f9,$2fa,$2fb

628e: 20 bf 6a     <a name="SymL628E">L628E</a>                 jsr     <a href="#Syminit_item_state">init_item_state</a>
6291: a9 b2                              lda     #$b2
6293: a2 01                              ldx     #$01
6295: 20 cf 69                           jsr     <a href="#Symclearpages">clearpages</a>
6298: a9 ff                              lda     #$ff
629a: 85 b8                              sta     <a href="#SymfoodRestTimer">foodRestTimer</a>
629c: 4c 6f 61                           jmp     <a href="#Symplayer_init">player_init</a>

629f: 20 21 6b     <a name="SymL629F">L629F</a>                 jsr     <a href="#SymL6B21">L6B21</a>
62a2: a5 31                              lda     $31
62a4: 85 19                              sta     <a href="#SymplayerX">playerX</a>
62a6: a5 32                              lda     <a href="#SymMON_INVFLAG">MON_INVFLAG</a>
62a8: 85 1a                              sta     <a href="#SymplayerY">playerY</a>
62aa: 20 03 6b                           jsr     <a href="#SymGAME2_draw_player">GAME2_draw_player</a>
62ad: a9 00                              lda     #$00
62af: 85 88                              sta     <a href="#SymanimTimer">animTimer</a>
62b1: 60                                 rts

62b2: a9 9d        <a name="SymL62B2">L62B2</a>                 lda     #$9d
62b4: 85 1b                              sta     <a href="#SymMAPPOS">MAPPOS</a>
62b6: a9 00                              lda     #$00
62b8: 85 1c                              sta     <a href="#SymMAPHALF">MAPHALF</a>
62ba: a9 01                              lda     #$01
62bc: 85 67                              sta     <a href="#SymINSIDE">INSIDE</a>
62be: 20 a3 61                           jsr     <a href="#Symmove_room">move_room</a>
62c1: a9 10                              lda     #$10
62c3: 85 c2                              sta     <a href="#SymDEMOPTR">DEMOPTR</a>
62c5: a9 9b                              lda     #$9b
62c7: 85 c3                              sta     $c3
62c9: a9 06                              lda     #$06
62cb: 85 31                              sta     $31
62cd: a9 0e                              lda     #$0e
62cf: 85 32                              sta     <a href="#SymMON_INVFLAG">MON_INVFLAG</a>
62d1: a9 01                              lda     #$01
62d3: 85 9a                              sta     <a href="#SymcrawlFlag">crawlFlag</a>
62d5: 85 c0                              sta     <a href="#SymDEMOWAIT">DEMOWAIT</a>
62d7: a9 ff                              lda     #$ff
62d9: 85 95                              sta     <a href="#SymFACING">FACING</a>
62db: 4c 8e 62                           jmp     <a href="#SymL628E">L628E</a>

62de: a0                                 .dd1    $a0
62df: b3                                 .dd1    $b3
62e0: a2                                 .dd1    $a2
62e1: 03                                 .dd1    $03
62e2: 4c                                 .dd1    $4c
62e3: b6                                 .dd1    $b6
62e4: 69                                 .dd1    $69
                   ; Pages that T22,S00..02 are read into
62e5: b3           <a name="Symitem_state_pages">item_state_pages</a>      .dd1    $b3
62e6: b4                                 .dd1    $b4
62e7: b5                                 .dd1    $b5

62e8: a9 e4        <a name="SymL62E8">L62E8</a>                 lda     #$e4
62ea: 85 1b                              sta     <a href="#SymMAPPOS">MAPPOS</a>
62ec: a9 00                              lda     #$00
62ee: 85 1c                              sta     <a href="#SymMAPHALF">MAPHALF</a>
62f0: 85 67                              sta     <a href="#SymINSIDE">INSIDE</a>
62f2: 20 a3 61                           jsr     <a href="#Symmove_room">move_room</a>
62f5: a9 00                              lda     #$00
62f7: 85 c2                              sta     <a href="#SymDEMOPTR">DEMOPTR</a>
62f9: a9 99                              lda     #$99
62fb: 85 c3                              sta     $c3
62fd: a9 18                              lda     #$18
62ff: 85 31                              sta     $31
6301: a9 0e                              lda     #$0e
6303: 85 32                              sta     <a href="#SymMON_INVFLAG">MON_INVFLAG</a>
6305: a9 01                              lda     #$01
6307: 85 c0                              sta     <a href="#SymDEMOWAIT">DEMOWAIT</a>
6309: a9 ff                              lda     #$ff
630b: 85 95                              sta     <a href="#SymFACING">FACING</a>
630d: 60                                 rts

630e: a2 00        <a name="SymL630E">L630E</a>                 ldx     #$00
6310: 86 c6                              stx     $c6
6312: c9 ff                              cmp     #$ff
6314: d0 03                              bne     <a href="#SymL6319">L6319</a>
6316: 4c 40 a8     <a name="SymL6316">L6316</a>                 jmp     <a href="#SymSCRN_warm_start">SCRN_warm_start</a>

6319: c9 9d        <a name="SymL6319">L6319</a>                 cmp     #$9d
631b: d0 06                              bne     <a href="#SymL6323">L6323</a>
631d: 20 b2 62                           jsr     <a href="#SymL62B2">L62B2</a>
6320: 4c 77 60                           jmp     <a href="#SymL6077">L6077</a>

6323: a5 d0        <a name="SymL6323">L6323</a>                 lda     $d0
6325: c9 01                              cmp     #$01
6327: f0 ed                              beq     <a href="#SymL6316">L6316</a>
6329: 20 e8 62                           jsr     <a href="#SymL62E8">L62E8</a>
632c: 4c 77 60                           jmp     <a href="#SymL6077">L6077</a>

                   tileset_tmp           .var    $5c    {addr/1}

632f: a9 00        <a name="Symselect_tileset">select_tileset</a>        lda     #$00
6331: 85 5c                              sta     tileset_tmp             ;tileset 0 (temp var?)
6333: a5 1c                              lda     <a href="#SymMAPHALF">MAPHALF</a>
6335: f0 0a                              beq     @choose                 ;top half, choose tileset
6337: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>                  ;bottom half, check pos
6339: c9 80                              cmp     #$80                    ;test pos top bit
633b: 90 04                              bcc     @choose                 ;side 1 pos 00..7F, choose tileset
633d: e6 5c        @tileset1             inc     tileset_tmp             ;set tileset 1 ($5C=1)
633f: d0 17                              bne     @set_tileset            ;always
6341: a5 1b        @choose               lda     <a href="#SymMAPPOS">MAPPOS</a>
                   ; Special treatment for side 0 pos $9d,$9e, and side 0/1 pos $7d,$7e -- always
                   ; use tileset 0.
6343: c9 9d                              cmp     #$9d
6345: f0 11                              beq     @set_tileset
6347: c9 9e                              cmp     #$9e
6349: f0 0d                              beq     @set_tileset
634b: c9 7d                              cmp     #$7d
634d: f0 09                              beq     @set_tileset
634f: c9 7e                              cmp     #$7e
6351: f0 05                              beq     @set_tileset
                   ; Choose tileset for remaining positions -- 000..0FF and 100..17F -- using the
                   ; tileset bitmap. (Minus 4 special positions above.) Note that 0160..017F is
                   ; ground level.
6353: 20 15 64                           jsr     <a href="#Symselect_tileset_harder">select_tileset_harder</a>
6356: f0 e5                              beq     @tileset1               ;Z clear, use tileset 1
6358: a5 5c        @set_tileset          lda     tileset_tmp
635a: c5 60                              cmp     <a href="#Symtileset">tileset</a>                 ;looks useless; does set Z if tileset differed
635c: f0 02                              beq     @rts                    ;however Z is unused by caller
635e: 85 60                              sta     <a href="#Symtileset">tileset</a>
6360: 60           @rts                  rts

6361: a6 5d                              ldx     $5d
6363: 4c 82 60                           jmp     <a href="#Symgame_loop">game_loop</a>?

                   <a name="Symspent_a_day_recovering">spent_a_day_recovering</a>
6366: 20 a3 66                           jsr     <a href="#Symteleport_home">teleport_home</a>
6369: a9 04                              lda     #$04
636b: 20 d6 66                           jsr     <a href="#SymPRNTSTR">PRNTSTR</a>
636e: 01                                 .dd1    $01
636f: d9 cf d5 a0+                       .str    YOU SPENT A DAY RECOVERING
6389: ff                                 .dd1    $ff
638a: 20 d6 66                           jsr     <a href="#SymPRNTSTR">PRNTSTR</a>
638d: 29                                 .dd1    $29
638e: c6 d2 cf cd+                       .str    FROM LACK OF 
639b: ff                                 .dd1    $ff
639c: a5 3c                              lda     <a href="#SymSTARVED">STARVED</a>
639e: c9 01                              cmp     #<a href="#SymSTARVED_food">STARVED_food</a>           ;01 = lack of food
63a0: d0 0c                              bne     @of_rest
63a2: 20 d6 66                           jsr     <a href="#SymPRNTSTR">PRNTSTR</a>
63a5: 36                                 .dd1    $36
63a6: c6 cf cf c4                        .str    FOOD
63aa: ff                                 .dd1    $ff
63ab: 4c b7 63                           jmp     @end

63ae: 20 d6 66     @of_rest              jsr     <a href="#SymPRNTSTR">PRNTSTR</a>
63b1: 36                                 .dd1    $36
63b2: d2 c5 d3 d4                        .str    REST
63b6: ff                                 .dd1    $ff
63b7: a9 00        @end                  lda     #$00                    ;clear starved attr
63b9: 85 3c                              sta     <a href="#SymSTARVED">STARVED</a>
63bb: 20 06 77                           jsr     <a href="#SymGAME2_message_wait">GAME2_message_wait</a>
63be: 4c 82 60                           jmp     <a href="#Symgame_loop">game_loop</a>?

63c1: a9 00        <a name="Symclearfield">clearfield</a>            lda     #$00
63c3: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>
63c5: 85 06                              sta     <a href="#SymTXTROW">TXTROW</a>
63c7: aa                                 tax
63c8: 20 93 67     @loop                 jsr     <a href="#Symgettextaddr">gettextaddr</a>
63cb: a9 00                              lda     #$00
63cd: 81 03                              sta     (<a href="#SymTXTPTR">TXTPTR</a>,x)
63cf: e6 05                              inc     <a href="#SymTXTCOL">TXTCOL</a>
63d1: a5 05                              lda     <a href="#SymTXTCOL">TXTCOL</a>
63d3: c9 28                              cmp     #40
63d5: d0 f1                              bne     @loop
63d7: a9 00                              lda     #$00
63d9: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>
63db: e6 06                              inc     <a href="#SymTXTROW">TXTROW</a>
63dd: a5 06                              lda     <a href="#SymTXTROW">TXTROW</a>
63df: c9 14                              cmp     #20
63e1: d0 e5                              bne     @loop
63e3: 4c 6c 67                           jmp     <a href="#Symdrawfield">drawfield</a>

                   coltmp                .var    $08    {addr/1}         ;column counter (+216)
                   rowtmp                .var    $65    {addr/1}         ;row counter (+252)

63e6: a9 14        <a name="Symcleartext">cleartext</a>             lda     #$14                    ;from $6006 vec
63e8: 85 06                              sta     <a href="#SymTXTROW">TXTROW</a>
63ea: a9 fc                              lda     #252                    ;256 - 252 = 4 (rows)
63ec: 85 65                              sta     rowtmp
63ee: a9 d8        @row                  lda     #216                    ;256 - 16 = 40 (cols)
63f0: 85 08                              sta     coltmp
63f2: a9 00                              lda     #$00
63f4: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>
63f6: a9 00        @col                  lda     #$00
63f8: 20 e6 67                           jsr     <a href="#Symcalc_tile">calc_tile</a>
63fb: 20 5b 68                           jsr     <a href="#Symcalc_hires_textpos">calc_hires_textpos</a>
63fe: 20 b3 67                           jsr     <a href="#Symwritetile">writetile</a>
6401: e6 05                              inc     <a href="#SymTXTCOL">TXTCOL</a>                  ;next column
6403: e6 08                              inc     coltmp                  ;40 times (counting up from 216!)
6405: d0 ef                              bne     @col
6407: e6 06                              inc     <a href="#SymTXTROW">TXTROW</a>                  ;next row
6409: e6 65                              inc     rowtmp                  ;4 times (counting up from 252!)
640b: d0 e1                              bne     @row
640d: 60                                 rts

640e: 20                                 .dd1    $20
640f: e6                                 .dd1    $e6
6410: 63 20 6c 67+                       .str    c lg`

                   ********************************************************************************
                   * Use the tileset bitmap to select tileset 0 or 1 based on the 9-bit map       *
                   * position. The top 6 bits select the bitmap byte, and the bottom 3 bits       *
                   * select the bit in that byte. This code is not called for certain positions   *
                   * (see select_tileset).                                                        *
                   *                                                                              *
                   * Clears Z for tileset 1, sets for tileset 0. (The bits are the opposite of    *
                   * the tileset #.)                                                              *
                   ********************************************************************************
                   maptmp                .var    $11    {addr/1}

6415: a5 1c        <a name="Symselect_tileset_harder">select_tileset_harder</a> lda     <a href="#SymMAPHALF">MAPHALF</a>
6417: 85 11                              sta     maptmp                  ;0 or 1 ($11=0000000S)
6419: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>                  ;A=PPPPPPPP
641b: a2 03                              ldx     #$03
641d: 46 11        @loop                 lsr     maptmp                  ;divide 16-bit value in $11/A by 8
641f: 6a                                 ror     A
6420: ca                                 dex
6421: d0 fa                              bne     @loop                   ;A=00SPPPPP (lowest 3 bits discarded)
6423: aa                                 tax                             ;X=00..3F
6424: bd 00 1d                           lda     <a href="#SymGAME1_tileset_bitmap">GAME1_tileset_bitmap</a>,x  ;get byte from tileset bitmap
6427: 85 11                              sta     maptmp
6429: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>                  ;now handle the lower 3 bits (0..7) of pos
642b: 29 07                              and     #$07
642d: aa                                 tax
642e: bd 34 64                           lda     <a href="#Symtileset_bittab">tileset_bittab</a>,x        ;each pos 0..7 corresponds to 1 bit in tileset byte
6431: 24 11                              bit     maptmp
6433: 60                                 rts

                   ; Used in previous subroutine to test bits 7..0 of $11 based on X=0..7.
6434: 80           <a name="Symtileset_bittab">tileset_bittab</a>        .dd1    $80                     ;test bit 7 (x=0)
6435: 40                                 .dd1    $40
6436: 20                                 .dd1    $20
6437: 10                                 .dd1    $10
6438: 08                                 .dd1    $08
6439: 04                                 .dd1    $04
643a: 02                                 .dd1    $02
643b: 01                                 .dd1    $01                     ;test bit 0 (x=7)

643c: a9 00        <a name="Symread_playfield">read_playfield</a>        lda     #$00
643e: 85 37                              sta     <a href="#SymspokeTo">spokeTo</a>
6440: 85 42                              sta     <a href="#SymMON_A4L">MON_A4L</a>
6442: 85 6b                              sta     <a href="#Symzp6b_npcHere">zp6b_npcHere</a>
6444: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>                  ;lower 4 bits: sector
6446: 29 0f                              and     #$0f
6448: 8d 05 03                           sta     <a href="#SymRWTS_IOB_sector">RWTS_IOB_sector</a>
644b: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>                  ;upper 4 bits: track (-1)
644d: 4a                                 lsr     A
644e: 4a                                 lsr     A
644f: 4a                                 lsr     A
6450: 4a                                 lsr     A
6451: 8d 04 03                           sta     <a href="#SymRWTS_IOB_track">RWTS_IOB_track</a>          ;track $01..$10
6454: ee 04 03                           inc     <a href="#SymRWTS_IOB_track">RWTS_IOB_track</a>          ;track + 1
6457: a5 1c                              lda     <a href="#SymMAPHALF">MAPHALF</a>                 ;high byte 
6459: f0 09                              beq     <a href="#SymL6464">L6464</a>                   ;0, track unchanged
645b: ad 04 03                           lda     <a href="#SymRWTS_IOB_track">RWTS_IOB_track</a>          ;1, tracks $11..$20
645e: 18                                 clc
645f: 69 10                              adc     #$10                    ;(add $10 to track)
6461: 8d 04 03                           sta     <a href="#SymRWTS_IOB_track">RWTS_IOB_track</a>
6464: a9 01        <a name="SymL6464">L6464</a>                 lda     #<a href="#SymRWTSCMD_read">RWTSCMD_read</a>
6466: 8d 0c 03                           sta     <a href="#SymRWTS_IOB_command">RWTS_IOB_command</a>
6469: 20 a2 69                           jsr     <a href="#Symswapzp8">swapzp8</a>                 ;save ZP
646c: 20 15 03                           jsr     <a href="#SymDIRECT_RWTS">DIRECT_RWTS</a>
646f: 20 a2 69                           jsr     <a href="#Symswapzp8">swapzp8</a>                 ;restore ZP
6472: 20 2f 63                           jsr     <a href="#Symselect_tileset">select_tileset</a>
6475: 20 8b 64                           jsr     <a href="#Symwrite_tiles_to_text">write_tiles_to_text</a>
6478: 20 6c 67                           jsr     <a href="#Symdrawfield">drawfield</a>
647b: 20 e6 63                           jsr     <a href="#Symcleartext">cleartext</a>
647e: 60                                 rts

647f: 20 8b 64     <a name="SymL647F">L647F</a>                 jsr     <a href="#Symwrite_tiles_to_text">write_tiles_to_text</a>
6482: 20 6c 67                           jsr     <a href="#Symdrawfield">drawfield</a>
6485: 20 03 6b                           jsr     <a href="#SymGAME2_draw_player">GAME2_draw_player</a>
6488: 4c 15 6b                           jmp     <a href="#SymL6B15">L6B15</a>

                   ********************************************************************************
                   * Write tiles to text page, copying them from the run-length encoded RWTS      *
                   * buffer starting at $201. Continues until all text rows are written.          *
                   *                                                                              *
                   * Then, reads more data from RWTS and processes it (so it is kind of a         *
                   * misnomer to say it writes tiles). This is really the start point for reading *
                   * and handling all data for a new map screen.                                  *
                   *                                                                              *
                   * $09/$0A are temp vars but $09 at least is used through several subroutines   *
                   * here.                                                                        *
                   ********************************************************************************
                   tiletmp               .var    $08    {addr/1}
                   rwtsbuf_idx           .var    $09    {addr/1}
                   tilecnt               .var    $0a    {addr/1}         ;RLE

648b: a2 03        <a name="Symwrite_tiles_to_text">write_tiles_to_text</a>   ldx     #$03                    ;copy from RWTSBUF into ZP
648d: bd fc 02     @loop                 lda     <a href="#SymRWTSBUF">RWTSBUF</a>+252,x           ;&lt;- $2ff,$2fe,$2fd
6490: 95 0b                              sta     $0b,x                   ;-&gt; $0e,$0d,$0c
6492: ca                                 dex
6493: 10 f8                              bpl     @loop
6495: a9 00                              lda     #$00
6497: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>                  ;text col 0
6499: 85 06                              sta     <a href="#SymTXTROW">TXTROW</a>                  ;text row 0
649b: 20 93 67                           jsr     <a href="#Symgettextaddr">gettextaddr</a>             ;get address on text page 1
649e: a9 01                              lda     #$01                    ;start with $201
64a0: 85 09                              sta     rwtsbuf_idx
64a2: a6 09        @next_tile            ldx     rwtsbuf_idx
64a4: e6 09                              inc     rwtsbuf_idx
64a6: bd 00 02                           lda     <a href="#SymRWTSBUF">RWTSBUF</a>,x               ;get tile
64a9: 30 0a                              bmi     @rle                    ;repeating tile 80..FF, branch
64ab: a0 00                              ldy     #$00
64ad: 91 03                              sta     (<a href="#SymTXTPTR">TXTPTR</a>),y              ;write tile byte to text screen
64af: 20 d4 64                           jsr     @next_text_pos          ;does not return if all rows written
64b2: 4c a2 64                           jmp     @next_tile

                   ; When the tile byte has the high bit set, the next byte is a repeat count of
                   ; tile &amp; 0x7F. In other words this is run-length encoded.
64b5: 29 7f        @rle                  and     #$7f                    ;tile 80..FF, strip high bit
64b7: 85 08                              sta     tiletmp                 ;tile 00..7F
64b9: a6 09                              ldx     rwtsbuf_idx
64bb: e6 09                              inc     rwtsbuf_idx
64bd: bd 00 02                           lda     <a href="#SymRWTSBUF">RWTSBUF</a>,x               ;read next tile byte
64c0: 85 0a                              sta     tilecnt
64c2: e6 0a                              inc     tilecnt
64c4: a0 00        @repeat_tile          ldy     #$00
64c6: a5 08                              lda     tiletmp
64c8: 91 03                              sta     (<a href="#SymTXTPTR">TXTPTR</a>),y              ;write tile byte to text screen
64ca: 20 d4 64                           jsr     @next_text_pos          ;does not return if done
64cd: c6 0a                              dec     tilecnt
64cf: d0 f3                              bne     @repeat_tile            ;repeat tilecnt times
64d1: 4c a2 64                           jmp     @next_tile

64d4: 20 5e 65     @next_text_pos        jsr     <a href="#Symbump_text_pos">bump_text_pos</a>           ;check if done
64d7: d0 01                              bne     @read_combo_section     ;1 = finish up
64d9: 60                                 rts                             ;0 = more tiles

                   <span style="background-color: #cb9099">NOTE: $08, $11 and possibly $0a change meanings below.</span>
                   ; Once the screen has been filled with tiles, read additional "combo" bytes
                   ; consisting of a command and a repeat count, followed by a tiled screen
                   ; position. 5 combos write a hardcoded tile triple N times, 1 writes a tile and
                   ; tile+1, and the last terminates the section (in practice, $E0).
64da: 68           @read_combo_section   pla                             ;remove caller address from stack
64db: 68                                 pla                             ;(we jsr'ed here)
64dc: a6 09        <a name="Symread_combo_byte">read_combo_byte</a>       ldx     rwtsbuf_idx
64de: bd 00 02                           lda     <a href="#SymRWTSBUF">RWTSBUF</a>,x               ;read another byte
64e1: 48                                 pha                             ;save it temporarily
64e2: 29 1f                              and     #$1f
64e4: 85 0a                              sta     tilecnt                 ;save lower 5 bits in $0a
64e6: 68                                 pla                             ;restore the read byte
64e7: 29 e0                              and     #$e0                    ;check the top 3 bits only
64e9: c9 e0                              cmp     #$e0                    ;are all 3 top bits set? (in practice byte is $E0)
64eb: d0 07                              bne     @other_combos           ;no, check other combos
64ed: 20 b2 65                           jsr     <a href="#Symdisplay_map_items">display_map_items</a>       ;yep, display items
64f0: 20 fc 65                           jsr     <a href="#SymL65FC">L65FC</a>
64f3: 60                                 rts

                   ; Write 3 tiles (specified by top 3 bits in last RWTS byte), repeated N rows
                   ; (the low 5 bits in this byte). In other words, %TTTNNNNN. The starting
                   ; position is specified by the next two bytes (to be read).
                   ; 
                   ; Check for various combos of TTT (we handled 111 above, which terminates). 5 of
                   ; 6 combos map to hardcoded tile triples. If the tile is b4 or b7, it will write
                   ; b4,b5,b6 or b7,b8,b9. If ba, bb or bc, it will write ba,ba,ba (etc.) These are
                   ; for ladders, vines and doors, which are all 3 tiles across repeated for some
                   ; distance down the screen.
                   ; 
                   ; The last combo (011) writes double-wide tiles (letters) at the specified
                   ; position. Here N is the number of tile bytes to read from the stream, written
                   ; as consecutive double-wide tiles.
                    Clear variables

64f4: c9 20        @other_combos         cmp     #%00100000              ;001 -&gt; b4,b5,b6 -&gt; outside green ladder
64f6: d0 02                              bne     <a href="#SymL64FA">L64FA</a>
64f8: a0 b4                              ldy     #$b4
64fa: c9 40        <a name="SymL64FA">L64FA</a>                 cmp     #%01000000              ;010 -&gt; b7,b8,b9 -&gt; inside brown ladder
64fc: d0 02                              bne     <a href="#SymL6500">L6500</a>
64fe: a0 b7                              ldy     #$b7
6500: c9 80        <a name="SymL6500">L6500</a>                 cmp     #%10000000              ;100 -&gt; ba,ba,ba -&gt; outside blue door
6502: d0 02                              bne     <a href="#SymL6506">L6506</a>
6504: a0 ba                              ldy     #$ba
6506: c9 a0        <a name="SymL6506">L6506</a>                 cmp     #%10100000              ;101 -&gt; bb,bb,bb -&gt; outside purple door
6508: d0 02                              bne     <a href="#SymL650C">L650C</a>
650a: a0 bb                              ldy     #$bb
650c: c9 c0        <a name="SymL650C">L650C</a>                 cmp     #%11000000              ;110 -&gt; bc,bc,bc -&gt; inside green / outside black door
650e: d0 02                              bne     <a href="#SymL6512">L6512</a>
6510: a0 bc                              ldy     #$bc
6512: c9 60        <a name="SymL6512">L6512</a>                 cmp     #%01100000              ;011 -&gt; read more data
6514: f0 28                              beq     @combo_011
6516: 84 11                              sty     <a href="#Symtemp11_textlo">temp11_textlo</a>           ;store computed tile
6518: 20 7d 65                           jsr     <a href="#SymreadTilePos">readTilePos</a>
651b: 86 09                              stx     <a href="#Symtemp09">temp09</a>
651d: a0 00        @outer_loop           ldy     #$00
651f: a6 11                              ldx     <a href="#Symtemp11_textlo">temp11_textlo</a>           ;computed tile
6521: a9 03                              lda     #$03
6523: 85 08                              sta     <a href="#Symtemp08">temp08</a>
6525: 8a           @inner_loop           txa                             ;get tile in A
6526: 91 03                              sta     (<a href="#SymTXTPTR">TXTPTR</a>),y              ;write tile to text screen
6528: e0 ba                              cpx     #$ba                    ;check tile number
652a: b0 01                              bcs     @no_inctile             ;&gt;= $ba, repeat same tile
652c: e8                                 inx                             ;otherwise, increment tile
652d: c8           @no_inctile           iny                             ;next column
652e: c6 08                              dec     <a href="#Symtemp08">temp08</a>
6530: d0 f3                              bne     @inner_loop             ;3 times
6532: e6 06                              inc     <a href="#SymTXTROW">TXTROW</a>                  ;next row
6534: 20 93 67                           jsr     <a href="#Symgettextaddr">gettextaddr</a>
6537: c6 0a                              dec     <a href="#Symtemp0a">temp0a</a>                  ;repeat %NNNNN rows
6539: d0 e2                              bne     @outer_loop
653b: 4c dc 64                           jmp     <a href="#Symread_combo_byte">read_combo_byte</a>

                   ; Combo 011 reads the next 2 position bytes (as normal),
653e: 20 7d 65     @combo_011            jsr     <a href="#SymreadTilePos">readTilePos</a>
                   ; and then reads NNNNN more bytes, each of which is a tile number of a double-
                   ; wide tile. It writes tile and tile+1 to the screen for each tile byte.
                   ; 
                   ; This is used, for example, when there are text banners on the screen such as
                   ; "TO TEMPLE GRUND". Each letter is double-width, and each word is (may be)
                   ; written as a separate command block, on top of the background. For example, TO
                   ; TEMPLE GRUND is 3 commands: 62, 66 and 65. (Command $60 with 2, 6, and 5
                   ; letters.)
6541: a0 00        @loop                 ldy     #$00
6543: bd 00 02                           lda     <a href="#SymRWTSBUF">RWTSBUF</a>,x
6546: e8                                 inx
6547: 91 03                              sta     (<a href="#SymTXTPTR">TXTPTR</a>),y
6549: 18                                 clc
654a: 69 01                              adc     #$01
654c: c8                                 iny
654d: 91 03                              sta     (<a href="#SymTXTPTR">TXTPTR</a>),y
654f: 20 5e 65                           jsr     <a href="#Symbump_text_pos">bump_text_pos</a>
6552: 20 5e 65                           jsr     <a href="#Symbump_text_pos">bump_text_pos</a>
6555: c6 0a                              dec     <a href="#Symtemp0a">temp0a</a>
6557: d0 e8                              bne     @loop
6559: 86 09                              stx     <a href="#Symtemp09">temp09</a>
655b: 4c dc 64                           jmp     <a href="#Symread_combo_byte">read_combo_byte</a>         ;more rwts data

                   ; Bump text page 1 position for writing tiles. If we have not written a full
                   ; screen, return 0; if we have, return 1, which is the end condition for reading
                   ; tiles from the RWTS RLE tile buffer.
655e: e6 05        <a name="Symbump_text_pos">bump_text_pos</a>         inc     <a href="#SymTXTCOL">TXTCOL</a>
6560: e6 03                              inc     <a href="#SymTXTPTR">TXTPTR</a>
6562: a5 05                              lda     <a href="#SymTXTCOL">TXTCOL</a>
6564: c9 28                              cmp     #$28
6566: d0 12                              bne     @ret00
6568: a9 00                              lda     #$00
656a: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>
656c: e6 06                              inc     <a href="#SymTXTROW">TXTROW</a>
656e: 20 93 67                           jsr     <a href="#Symgettextaddr">gettextaddr</a>
6571: a5 06                              lda     <a href="#SymTXTROW">TXTROW</a>
6573: c9 14                              cmp     #$14
6575: d0 03                              bne     @ret00
6577: a9 01                              lda     #$01
6579: 60                                 rts

657a: a9 00        @ret00                lda     #$00                    ;we are not done
657c: 60                                 rts

                   <span style="background-color: #cb9099">NOTE: Unclear why we subtract $40 (or mask top bit) from 16-bit tile position in</span>
                   <span style="background-color: #cb9099">combo byte data. If it is for metadata, there are 3 bits left with a simple 2</span>
                   <span style="background-color: #cb9099">byte ROW (6 bits) and COL (7 bits) representation.</span>
                   <span style="background-color: #cb9099"></span>
                   <span style="background-color: #cb9099">Since this game was multiplatform, they may have (sanely) assumed contiguous</span>
                   <span style="background-color: #cb9099">memory for a 40x20 screen, and kept that representation. The function of the</span>
                   <span style="background-color: #cb9099">upper bit is unknown (an actual address?) but the real question is the</span>
                   <span style="background-color: #cb9099">subtraction of $40 instead of ANDing it out.</span>
                   ; Called just before any tile combo is written. Reads 2 position bytes from
                   ; RWTSBUF which become a 16-bit address into a 40x20 matrix. Converts that
                   ; address into a (row,col) tuple and returns the resulting address on text page
                   ; 1, where the tile will be written.
                   ; 
                   ; First, do some initial munging of the top byte, masking off its top bit, and
                   ; subtracting $40 (for some reason, instead of AND #$3F).
                   ; 
                   ; Then, divide the 16-bit value in $03/04 by the 8 bit value #40 (cols/row),
                   ; placing the quotient (row) in TXTROW and the remainder (col) in TXTCOL.
                   ; 
                   ; E.g. $A9 $C1 -&gt; $A9 $01 -&gt; $01A9
                   ;      $01A9 // 40 = 10 (row 10, 0..23)
                   ;      $01A9 %  40 = 25 (col 25, 0..39)
                   ; 
                   ; Last, call gettextaddr to compute the screen address of TXTROW/TXTCOL and
                   ; place it in TXTPTR for the caller. Note TXTPTR was used as a temp for the
                   ; divide, and is overwritten.
                   ; 
                   ; A simple 2-byte ROW/COL representation would have been easier to deal with and
                   ; still left 3 bits for metadata. This representation looks geared toward the
                   ; contiguous screen memory of other platforms this game was released for.
657d: e8           <a name="SymreadTilePos">readTilePos</a>           inx
657e: bd 00 02                           lda     <a href="#SymRWTSBUF">RWTSBUF</a>,x               ;read rwts byte into TXTPTR (temp) lo
6581: 85 03                              sta     <a href="#SymTXTPTR">TXTPTR</a>                  ;used as a 16-bit temporary, overwritten at end
6583: e8                                 inx
6584: bd 00 02                           lda     <a href="#SymRWTSBUF">RWTSBUF</a>,x               ;read rwts byte into TXTPTR (temp) hi
6587: 29 7f                              and     #$7f                    ;ignoring top bit of second byte
6589: 38                                 sec
658a: e9 40                              sbc     #$40                    ;and subtracting $40 from second byte
658c: 85 04                              sta     <a href="#SymTXTPTR">TXTPTR</a>+1
658e: e8                                 inx
658f: a9 00                              lda     #$00
6591: 85 06                              sta     <a href="#SymTXTROW">TXTROW</a>
6593: a5 03        @loop                 lda     <a href="#SymTXTPTR">TXTPTR</a>                  ;16-bit subtract of #$0028 from tmpaddr
6595: 38                                 sec
6596: e9 28                              sbc     #40
6598: 85 03                              sta     <a href="#SymTXTPTR">TXTPTR</a>
659a: a5 04                              lda     <a href="#SymTXTPTR">TXTPTR</a>+1
659c: e9 00                              sbc     #$00                    ;propagate low-byte borrow to high byte
659e: 30 07                              bmi     @done                   ;finish up
65a0: 85 04                              sta     <a href="#SymTXTPTR">TXTPTR</a>+1
65a2: e6 06                              inc     <a href="#SymTXTROW">TXTROW</a>
65a4: 4c 93 65                           jmp     @loop

65a7: a9 28        @done                 lda     #40
65a9: 18                                 clc
65aa: 65 03                              adc     <a href="#SymTXTPTR">TXTPTR</a>                  ;overshot $03 by 40, add back in (didn't update $04)
65ac: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>
65ae: 20 93 67                           jsr     <a href="#Symgettextaddr">gettextaddr</a>             ;wipes out $03/04
65b1: 60                                 rts                             ;return to caller

                   ********************************************************************************
                   * Display all the free-standing items in this room, called after the           *
                   * background is displayed. These are all the items from $b500-$b5ff with bit 6 *
                   * set and bit 5 clear. For item x (00..ff),                                    *
                   *                                                                              *
                   * $b300,x is the item's map position (room)                                    *
                   * $b500,x bit 7 is the map position high bit                                   *
                   * $b500,x bit 6 must be set (unknown purpose)                                  *
                   * $b500,x bit 5 must be clear (used to indicate item is in your inventory)     *
                   * $b500,x bits 0..4 are the screen tile row 0..20                              *
                   * $b400,x is the screen tile column 0..39                                      *
                   *                                                                              *
                   * All items are 2 tiles in width and the tile number is $fd - (item * 2).      *
                   * Items are duplicated in both tilesets.                                       *
                   ********************************************************************************
65b2: a2 00        <a name="Symdisplay_map_items">display_map_items</a>     ldx     #$00
65b4: bd 00 b3     @loop                 lda     <a href="#SymitemStatePos">itemStatePos</a>,x          ;256 possible item positions (map rooms)
65b7: c5 1b                              cmp     <a href="#SymMAPPOS">MAPPOS</a>
65b9: d0 3d                              bne     @next_item
65bb: bd 00 b5                           lda     <a href="#SymitemState">itemState</a>,x
65be: 0a                                 asl     A
65bf: a9 00                              lda     #$00
65c1: 2a                                 rol     A                       ;bit 7 -- high bit of map position
65c2: c5 1c                              cmp     <a href="#SymMAPHALF">MAPHALF</a>
65c4: d0 32                              bne     @next_item
65c6: bd 00 b5                           lda     <a href="#SymitemState">itemState</a>,x
65c9: 2c be 1d                           bit     <a href="#SymGAME1_BITTAB6">GAME1_BITTAB6</a>           ;bit 6 -- unknown (must be set here)
65cc: f0 2a                              beq     @next_item
65ce: 2c bd 1d                           bit     <a href="#SymGAME1_BITTAB5">GAME1_BITTAB5</a>           ;bit 5 -- item in inventory
65d1: d0 25                              bne     @next_item
65d3: 29 1f                              and     #$1f                    ;bits 0..4 (tile row)
65d5: a8                                 tay
65d6: b9 a0 1d                           lda     <a href="#SymGAME1_textlo">GAME1_textlo</a>,y          ;Y is the text row
65d9: 85 11                              sta     <a href="#Symtemp11_textlo">temp11_textlo</a>
65db: b9 80 1d                           lda     <a href="#SymGAME1_texthi">GAME1_texthi</a>,y
65de: 85 12                              sta     <a href="#Symtemp12_texthi">temp12_texthi</a>
65e0: 8a                                 txa
65e1: 20 03 77                           jsr     <a href="#SymGAME2_slot_to_item">GAME2_slot_to_item</a>
65e4: 84 08                              sty     <a href="#Symtemp08">temp08</a>
65e6: 06 08                              asl     <a href="#Symtemp08">temp08</a>                  ;because tiles are double-wide?
65e8: a9 fd                              lda     #$fd                    ;convert item num to tile ($fd-item*2)
65ea: 38                                 sec
65eb: e5 08                              sbc     <a href="#Symtemp08">temp08</a>
65ed: bc 00 b4                           ldy     <a href="#SymitemStateCol">itemStateCol</a>,x          ;item tile column
65f0: 91 11                              sta     (<a href="#Symtemp11_textlo">temp11_textlo</a>),y
65f2: c8                                 iny
65f3: 18                                 clc
65f4: 69 01                              adc     #$01                    ;right half of tile
65f6: 91 11                              sta     (<a href="#Symtemp11_textlo">temp11_textlo</a>),y
65f8: e8           @next_item            inx
65f9: d0 b9                              bne     @loop
65fb: 60                                 rts

65fc: a2 04        <a name="SymL65FC">L65FC</a>                 ldx     #$04
65fe: 86 08                              stx     <a href="#Symtemp08">temp08</a>
6600: 20 4f 66                           jsr     <a href="#SymL664F">L664F</a>
6603: a5 60                              lda     <a href="#Symtileset">tileset</a>
6605: d0 0b                              bne     <a href="#SymL6612">L6612</a>
6607: a9 00                              lda     #$00
6609: 85 11                              sta     <a href="#Symtemp11_textlo">temp11_textlo</a>
660b: a9 37                              lda     #$37
660d: 85 12                              sta     <a href="#Symtemp12_texthi">temp12_texthi</a>
660f: 4c 1a 66                           jmp     <a href="#SymL661A">L661A</a>

6612: a9 00        <a name="SymL6612">L6612</a>                 lda     #$00
6614: 85 11                              sta     <a href="#Symtemp11_textlo">temp11_textlo</a>
6616: a9 2e                              lda     #$2e
6618: 85 12                              sta     <a href="#Symtemp12_texthi">temp12_texthi</a>
661a: a9 59        <a name="SymL661A">L661A</a>                 lda     #$59
661c: 85 03                              sta     <a href="#SymTXTPTR">TXTPTR</a>
661e: a0 52                              ldy     #$52
6620: a5 0c                              lda     $0c
6622: 20 47 66                           jsr     <a href="#SymL6647">L6647</a>
6625: a9 73                              lda     #$73
6627: 85 03                              sta     <a href="#SymTXTPTR">TXTPTR</a>
6629: a0 59                              ldy     #$59
662b: a5 0d                              lda     $0d
662d: 20 47 66                           jsr     <a href="#SymL6647">L6647</a>
6630: a9 77                              lda     #$77
6632: 85 03                              sta     <a href="#SymTXTPTR">TXTPTR</a>
6634: a0 73                              ldy     #$73
6636: a5 0e                              lda     $0e
6638: 20 47 66                           jsr     <a href="#SymL6647">L6647</a>
663b: a9 b4                              lda     #$b4
663d: 85 03                              sta     <a href="#SymTXTPTR">TXTPTR</a>
663f: a0 77                              ldy     #$77
6641: a5 0b                              lda     $0b
6643: 20 47 66                           jsr     <a href="#SymL6647">L6647</a>
6646: 60                                 rts

6647: 91 11        <a name="SymL6647">L6647</a>                 sta     (<a href="#Symtemp11_textlo">temp11_textlo</a>),y
6649: c8                                 iny
664a: c4 03                              cpy     <a href="#SymTXTPTR">TXTPTR</a>
664c: d0 f9                              bne     <a href="#SymL6647">L6647</a>
664e: 60                                 rts

664f: a2 00        <a name="SymL664F">L664F</a>                 ldx     #$00
6651: a5 1c                              lda     <a href="#SymMAPHALF">MAPHALF</a>
6653: f0 14                              beq     <a href="#SymL6669">L6669</a>
6655: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>
6657: c9 80                              cmp     #$80
6659: 90 0e                              bcc     <a href="#SymL6669">L6669</a>
665b: ad 01 b5                           lda     <a href="#SymitemState">itemState</a>+1
665e: 2c bd 1d                           bit     <a href="#SymGAME1_BITTAB5">GAME1_BITTAB5</a>
6661: d0 06                              bne     <a href="#SymL6669">L6669</a>
6663: a5 3a                              lda     <a href="#SymlitLamp">litLamp</a>
6665: d0 02                              bne     <a href="#SymL6669">L6669</a>
6667: a2 01                              ldx     #$01
6669: 86 5e        <a name="SymL6669">L6669</a>                 stx     $5e
666b: 60                                 rts

666c: 20 a3 66     <a name="Symfound_near_water">found_near_water</a>      jsr     <a href="#Symteleport_home">teleport_home</a>
666f: 20 d6 66                           jsr     <a href="#SymPRNTSTR">PRNTSTR</a>
6672: 29                                 .dd1    $29
6673: d9 cf d5 a0+                       .str    YOU WERE FOUND NEAR THE WATER.
6691: ff                                 .dd1    $ff
6692: 20 09 77                           jsr     <a href="#SymL7709">L7709</a>
6695: 20 06 77                           jsr     <a href="#SymGAME2_message_wait">GAME2_message_wait</a>
6698: a9 00                              lda     #$00
669a: 85 80                              sta     <a href="#SymtouchedWater">touchedWater</a>
669c: a9 01                              lda     #$01                    ;start the clock
669e: 85 87                              sta     <a href="#SymTICKING">TICKING</a>
66a0: 4c 86 60                           jmp     <a href="#Symtick0">tick0</a>

66a3: a9 00        <a name="Symteleport_home">teleport_home</a>         lda     #$00
66a5: 85 6b                              sta     <a href="#Symzp6b_npcHere">zp6b_npcHere</a>
66a7: a5 2d                              lda     <a href="#SymhomePos">homePos</a>
66a9: 85 1b                              sta     <a href="#SymMAPPOS">MAPPOS</a>
66ab: a5 2e                              lda     <a href="#SymhomeHalf">homeHalf</a>
66ad: 85 1c                              sta     <a href="#SymMAPHALF">MAPHALF</a>
66af: a9 01                              lda     #$01
66b1: 85 67                              sta     <a href="#SymINSIDE">INSIDE</a>
66b3: 20 3c 64                           jsr     <a href="#Symread_playfield">read_playfield</a>
66b6: a5 2f                              lda     <a href="#SymhomeX">homeX</a>
66b8: 85 19                              sta     <a href="#SymplayerX">playerX</a>
66ba: a5 30                              lda     <a href="#SymhomeY">homeY</a>
66bc: 85 1a                              sta     <a href="#SymplayerY">playerY</a>
66be: a2 2e                              ldx     #$2e
66c0: 86 a3                              stx     <a href="#SymanimFrame">animFrame</a>
66c2: e8                                 inx
66c3: 86 a4                              stx     <a href="#SymanimFrame_unused">animFrame_unused</a>
66c5: 20 03 6b                           jsr     <a href="#SymGAME2_draw_player">GAME2_draw_player</a>
66c8: e6 22                              inc     <a href="#SymdayNum">dayNum</a>                  ;lose a day
66ca: a5 27                              lda     <a href="#SymlimitSpirit">limitSpirit</a>             ;restore spirit
66cc: 85 23                              sta     <a href="#SymlevelSpirit">levelSpirit</a>
66ce: a6 2a                              ldx     <a href="#SymlimitFood">limitFood</a>               ;limitFood and limitRest are always identical, so
66d0: ca                                 dex                             ;I guess they realized checking 2 vars was pointless
66d1: 86 24                              stx     <a href="#SymlevelFood">levelFood</a>               ;restore food and rest (to limit - 1)
66d3: 86 25                              stx     <a href="#SymlevelRest">levelRest</a>
66d5: 60                                 rts

                   ********************************************************************************
                   * Print inline string to hires text area (last 4 lines). The inline data is:   *
                   *    1 byte -- hpos, the horizontal position of the string                     *
                   *    x bytes - high ascii string data                                          *
                   *  $ff       - string terminator                                               *
                   *                                                                              *
                   * The hpos byte starts from $00 (col 1, row 1) and wraps at $28 (col 1, row    *
                   * 2), $50 and $78, so it encodes vertical position as well. In practice,       *
                   * strings are indented by 1 so $01, $29 etc are typical. Strings will wrap at  *
                   * end of screen.                                                               *
                   *                                                                              *
                   * The use of $ff instead of $00 to terminate strings could be a cross-platform *
                   * concession, although platforms where $00 is a valid character would not be   *
                   * using high-ascii anyway.                                                     *
                   ********************************************************************************
                   inlinedata            .var    $61    {addr/2}
                   ysav                  .var    $63    {addr/1}

66d6: 68           <a name="SymPRNTSTR">PRNTSTR</a>               pla                             ;inline data; store addr-1 in $61/$62
66d7: 85 61                              sta     inlinedata
66d9: 68                                 pla
66da: 85 62                              sta     inlinedata+1
66dc: a0 01                              ldy     #$01                    ;addr-1+1
66de: b1 61                              lda     (inlinedata),y
66e0: 85 64                              sta     <a href="#SymHTAB">HTAB</a>                    ;first byte of inline data is indent
66e2: c8                                 iny
66e3: b1 61        @loop                 lda     (inlinedata),y          ;A=char
66e5: c9 ff                              cmp     #$ff                    ;end of string?
66e7: f0 0e                              beq     @continue
66e9: 84 63                              sty     ysav                    ;save y
66eb: 20 09 67                           jsr     <a href="#Symprintchar">printchar</a>
66ee: e6 05                              inc     <a href="#SymTXTCOL">TXTCOL</a>                  ;??
66f0: e6 64                              inc     <a href="#SymHTAB">HTAB</a>
66f2: a4 63                              ldy     ysav                    ;restore y
66f4: c8                                 iny
66f5: d0 ec                              bne     @loop                   ;always, effectively
                   ; Offset the return address in $61/$62 with the inline data length, then jump to
                   ; it to continue.
66f7: c8           @continue             iny
66f8: 98                                 tya
66f9: 18                                 clc
66fa: 65 61                              adc     inlinedata
66fc: 85 61                              sta     inlinedata
66fe: 90 02                              bcc     @nowrap                 ;check for page wrap
6700: e6 62                              inc     inlinedata+1            ;and wrap page
6702: a9 00        @nowrap               lda     #$00
6704: 85 66                              sta     <a href="#SymINVTEXT">INVTEXT</a>
6706: 6c 61 00                           jmp     ($0061)

                   ; Print char in A at horiz pos htab in text area. Converts position to
                   ; fullscreen TXTROW/COL. Indexes the char ($00..$3F) into hires char bitmap
                   ; $2C00 at 8 bytes per char. Then draws the char on the hires screen.
6709: 48           <a name="Symprintchar">printchar</a>             pha                             ;save char
670a: a9 13                              lda     #19                     ;screen line 19 (will be 20)
670c: 85 06                              sta     <a href="#SymTXTROW">TXTROW</a>
670e: a5 64                              lda     <a href="#SymHTAB">HTAB</a>
                   ; Add quotient(htab,40)+1 to TXTROW -- implement wrapping.
6710: 38           @incrow               sec                             ;subtract 40 cols from htab
6711: e9 28                              sbc     #40
6713: e6 06                              inc     <a href="#SymTXTROW">TXTROW</a>
6715: b0 f9                              bcs     @incrow                 ;add 1 to TXTROW until htab &lt; 0
6717: 18                                 clc
6718: 69 28                              adc     #40
671a: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>                  ;adjust +40 (we overshot 1 iter of -40)
671c: 68                                 pla                             ;restore char
671d: 29 3f                              and     #$3f                    ;convert $C0..DF to $00..1F, $A0..BF to $20..3F (?)
671f: 85 16                              sta     <a href="#Symtileptr">tileptr</a>                 ;store char # in $16/17
6721: a9 00                              lda     #$00
6723: 85 17                              sta     <a href="#Symtileptr">tileptr</a>+1
6725: 06 16                              asl     <a href="#Symtileptr">tileptr</a>                 ;mult $16 (addr/2) by 8 bytes (per char data)
6727: 26 17                              rol     <a href="#Symtileptr">tileptr</a>+1
6729: 06 16                              asl     <a href="#Symtileptr">tileptr</a>
672b: 26 17                              rol     <a href="#Symtileptr">tileptr</a>+1
672d: 06 16                              asl     <a href="#Symtileptr">tileptr</a>
672f: 26 17                              rol     <a href="#Symtileptr">tileptr</a>+1
6731: a5 16                              lda     <a href="#Symtileptr">tileptr</a>
6733: 18                                 clc
6734: 69 00                              adc     #&lt;<a href="#SymGAME1_chardata">GAME1_chardata</a>
6736: 85 16                              sta     <a href="#Symtileptr">tileptr</a>
6738: a5 17                              lda     <a href="#Symtileptr">tileptr</a>+1
673a: 69 2c                              adc     #&gt;<a href="#SymGAME1_chardata">GAME1_chardata</a>
673c: 85 17                              sta     <a href="#Symtileptr">tileptr</a>+1
673e: 20 5b 68                           jsr     <a href="#Symcalc_hires_textpos">calc_hires_textpos</a>      ;calc hires addr in $14
6741: 20 45 67                           jsr     <a href="#Symdrawchar">drawchar</a>                ;draw ($16) data at ($14)
6744: 60                                 rts

                   ; Draw 8 lines of character data at ($16) to the hires screen at ($14).
                   ; Actually, the first written line is blank, and then the first 7 lines of
                   ; actual data are written; the 8th line is ignored. This creates line spacing by
                   ; shifting everything down a pixel. This is a little odd, but perhaps let them
                   ; switch to top-spacing (which offsets text from the playfield) without changing
                   ; the char data.
                   lines                 .var    $07    {addr/1}         ;lines left to draw

6745: a2 00        <a name="Symdrawchar">drawchar</a>              ldx     #$00                    ;this will draw normal pixels
6747: a5 66                              lda     <a href="#SymINVTEXT">INVTEXT</a>                 ;inverse text?
6749: f0 02                              beq     @draw
674b: a2 7f                              ldx     #$7f                    ;this will flip (XOR) pixels (inverse?)
674d: 86 18        @draw                 stx     <a href="#SymMASK">MASK</a>                    ;mask. may be global var
674f: a9 08                              lda     #$08                    ;8 lines
6751: 85 07                              sta     lines
6753: a2 00                              ldx     #$00
6755: a0 00                              ldy     #$00
6757: a9 80                              lda     #$80                    ;first line empty (note bit 7 color set)
6759: 45 18        @loop                 eor     <a href="#SymMASK">MASK</a>                    ;possibly invert text
                   <span style="background-color: #cb8300">NOTE: Is $14/15 global?  Is $16/17?</span>
675b: 81 14                              sta     (<a href="#Symhires_addr">hires_addr</a>,x)          ;$14 (addr/2) prob hires screen, unsure where set
675d: a5 15                              lda     <a href="#Symhires_addr">hires_addr</a>+1
675f: 18                                 clc
6760: 69 04                              adc     #$04                    ;next hires line (+$0400)
6762: 85 15                              sta     <a href="#Symhires_addr">hires_addr</a>+1
6764: b1 16                              lda     (<a href="#Symtileptr">tileptr</a>),y
6766: c8                                 iny
6767: c6 07                              dec     lines
6769: d0 ee                              bne     @loop
676b: 60                                 rts

                   <span style="background-color: #72be72">NOTE: Draws 20 lines of text, sourced from text page 1, to hires screen. This</span>
                   <span style="background-color: #72be72">looks like 40x20 tiled graphics data stored as text, made further apparent by</span>
                   <span style="background-color: #72be72">NOPing out the 4 instructions at $A857 to set HIRES2, leaving GR active. This</span>
                   <span style="background-color: #72be72">shows lores colored blocks in the obvious shape of game screens.</span>
                   text1                 .var    $03    {addr/2}         ;FIXME: this is TXTPTR

676c: a9 00        <a name="Symdrawfield">drawfield</a>             lda     #$00
676e: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>
6770: 85 06                              sta     <a href="#SymTXTROW">TXTROW</a>
6772: 20 93 67     @line                 jsr     <a href="#Symgettextaddr">gettextaddr</a>
6775: a0 00        @char                 ldy     #$00
6777: b1 03                              lda     (text1),y               ;load from text page 1
6779: 20 a9 67                           jsr     <a href="#Symdrawtile">drawtile</a>
677c: e6 03                              inc     text1                   ;page aligned, so no high byte inc
677e: e6 05                              inc     <a href="#SymTXTCOL">TXTCOL</a>                  ;next col
6780: a5 05                              lda     <a href="#SymTXTCOL">TXTCOL</a>
6782: c9 28                              cmp     #40                     ;comp $05 with 40; def looks like a column now
6784: d0 ef                              bne     @char
6786: a9 00                              lda     #$00
6788: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>                  ;reset to column 1
678a: e6 06                              inc     <a href="#SymTXTROW">TXTROW</a>                  ;and bump row
678c: a5 06                              lda     <a href="#SymTXTROW">TXTROW</a>
678e: c9 14                              cmp     #20                     ;reached row 21?
6790: d0 e0                              bne     @line                   ;no, keep going
6792: 60                                 rts

                   ; Converting a col/row ($05/$06) to an address on text page 1. Output address is
                   ; in $03/04. X is preserved.
6793: 8a           <a name="Symgettextaddr">gettextaddr</a>           txa
6794: 48                                 pha
6795: a6 06                              ldx     <a href="#SymTXTROW">TXTROW</a>
6797: bd a0 1d                           lda     <a href="#SymGAME1_textlo">GAME1_textlo</a>,x          ;low byte of text page line
679a: 18                                 clc
679b: 65 05                              adc     <a href="#SymTXTCOL">TXTCOL</a>
679d: 85 03                              sta     text1
679f: bd 80 1d                           lda     <a href="#SymGAME1_texthi">GAME1_texthi</a>,x          ;high byte of text page line
67a2: 69 00                              adc     #$00
67a4: 85 04                              sta     text1+1
67a6: 68                                 pla
67a7: aa                                 tax
67a8: 60                                 rts

                   ; Input: A = tile number.
67a9: 20 e6 67     <a name="Symdrawtile">drawtile</a>              jsr     <a href="#Symcalc_tile">calc_tile</a>
67ac: 20 5b 68                           jsr     <a href="#Symcalc_hires_textpos">calc_hires_textpos</a>
67af: 20 b3 67                           jsr     <a href="#Symwritetile">writetile</a>
67b2: 60                                 rts

67b3: a5 5e        <a name="Symwritetile">writetile</a>             lda     $5e
67b5: f0 05                              beq     <a href="#SymL67BC">L67BC</a>
67b7: a9 00                              lda     #$00
67b9: 20 e6 67                           jsr     <a href="#Symcalc_tile">calc_tile</a>
67bc: a9 00        <a name="SymL67BC">L67BC</a>                 lda     #$00
67be: a2 00                              ldx     #$00
67c0: a9 08                              lda     #$08                    ;8 lines in a tile
67c2: 85 07                              sta     lines
67c4: a0 00                              ldy     #$00
67c6: b1 16        @line                 lda     (<a href="#Symtileptr">tileptr</a>),y             ;read tile data
67c8: 25 18                              and     <a href="#SymMASK">MASK</a>                    ;apply global mask
67ca: 81 14                              sta     (<a href="#Symhires_addr">hires_addr</a>,x)          ;write tile data
67cc: a5 07                              lda     lines
67ce: 6a                                 ror     A                       ;check if A (lines) is odd
67cf: 90 08                              bcc     @no_and                 ;ignore odd line mask on even lines
67d1: a5 5f                              lda     <a href="#SymODDLINE_MASK">ODDLINE_MASK</a>
67d3: f0 04                              beq     @no_and                 ;ignore odd line mask when zero
                   ; If the sta to $14 is removed, the purple odd-line hatching on the title screen
                   ; is gone, and houses are now a single color. The odd line mask is a clever way
                   ; to add shading/hatching. Note that odd lines are written twice if masked; the
                   ; second write clobbers the first.
67d5: 31 16                              and     (<a href="#Symtileptr">tileptr</a>),y
67d7: 81 14                              sta     (<a href="#Symhires_addr">hires_addr</a>,x)
67d9: c8           @no_and               iny                             ;next line
67da: a5 15                              lda     <a href="#Symhires_addr">hires_addr</a>+1            ;next hires line (+$0400)
67dc: 18                                 clc
67dd: 69 04                              adc     #$04
67df: 85 15                              sta     <a href="#Symhires_addr">hires_addr</a>+1
67e1: c6 07                              dec     lines
67e3: d0 e1                              bne     @line                   ;write 8 lines
67e5: 60                                 rts

                   ********************************************************************************
                   * Calculate tile data. A is the tile number. There appear to be 2 tilesets,    *
                   * tileset 1 at $2E00 ($2F00), and tileset 0 at $3700 ($3800), selected by the  *
                   * value of $60.                                                                *
                   *                                                                              *
                   * The tile mask and odd line mask are retrieved from 6 possible 16-element     *
                   * mask arrays; the first $100 bytes of data are mask indices. Tiles $00-$49    *
                   * and $75..$ff use one mask array for even columns and a second array for odd  *
                   * columns; their oddline mask is disabled. Tiles $4a-$74 use a mask array for  *
                   * even columns/even lines, one for odd columns/even lines, one for even        *
                   * columns/odd lines, and one for odd columns/odd lines.                        *
                   *                                                                              *
                   * Finally, tileptr ($16) is set to the hires tile bitmap.                      *
                   ********************************************************************************
67e6: 85 16        <a name="Symcalc_tile">calc_tile</a>             sta     <a href="#Symtileptr">tileptr</a>
67e8: a8                                 tay                             ;Y used in L681A
67e9: a9 00                              lda     #$00
67eb: 85 5f                              sta     <a href="#SymODDLINE_MASK">ODDLINE_MASK</a>            ;disable oddline mask by default
67ed: a5 60                              lda     <a href="#Symtileset">tileset</a>
67ef: d0 29                              bne     <a href="#Symtileset_1">tileset_1</a>
67f1: b9 00 37                           lda     <a href="#SymGAME1_tileset0_masks">GAME1_tileset0_masks</a>,y  ;note very close to $3800
67f4: aa                                 tax
67f5: a5 16                              lda     <a href="#Symtileptr">tileptr</a>
67f7: c9 4a                              cmp     #$4a                    ;is tile between $4a and $74?
67f9: 90 23                              bcc     @mask_tileset           ;no, use simple tileset mask
67fb: c9 75                              cmp     #$75
67fd: b0 1f                              bcs     @mask_tileset
67ff: a5 05                              lda     <a href="#SymTXTCOL">TXTCOL</a>
6801: 6a                                 ror     A
6802: 90 0b                              bcc     @evencol                ;branch if column even
6804: bd e0 1f                           lda     <a href="#SymGAME1_odd_col_odd_line_mask">GAME1_odd_col_odd_line_mask</a>,x ;apply odd column odd line mask
6807: 85 5f                              sta     <a href="#SymODDLINE_MASK">ODDLINE_MASK</a>
6809: bd c0 1f                           lda     <a href="#SymGAME1_odd_col_even_line_mask">GAME1_odd_col_even_line_mask</a>,x
680c: 4c 29 68                           jmp     @finalize

680f: bd f0 1f     @evencol              lda     <a href="#SymGAME1_even_col_odd_line_mask">GAME1_even_col_odd_line_mask</a>,x ;apply even column odd line mask
6812: 85 5f                              sta     <a href="#SymODDLINE_MASK">ODDLINE_MASK</a>
6814: bd d0 1f                           lda     <a href="#SymGAME1_even_col_even_line_mask">GAME1_even_col_even_line_mask</a>,x
6817: 4c 29 68                           jmp     @finalize

681a: b9 00 2e     <a name="Symtileset_1">tileset_1</a>             lda     <a href="#SymGAME1_tileset1_masks">GAME1_tileset1_masks</a>,y  ;note very close to $2F00 (see just below)
681d: aa                                 tax
681e: a5 05        @mask_tileset         lda     <a href="#SymTXTCOL">TXTCOL</a>
6820: 6a                                 ror     A
6821: bd b0 1f                           lda     <a href="#SymGAME1_even_col_mask">GAME1_even_col_mask</a>,x   ;even column mask
6824: 90 03                              bcc     @finalize
6826: bd a0 1f                           lda     <a href="#SymGAME1_odd_col_mask">GAME1_odd_col_mask</a>,x    ;odd column mask
                   ; Everything ends up here to write A to MASK and calculate tileptr.
6829: 85 18        @finalize             sta     <a href="#SymMASK">MASK</a>
682b: a9 00                              lda     #$00
682d: 85 17                              sta     <a href="#Symtileptr">tileptr</a>+1
682f: 06 16                              asl     <a href="#Symtileptr">tileptr</a>                 ;16-bit mul $16 by 8
6831: 26 17                              rol     <a href="#Symtileptr">tileptr</a>+1
6833: 06 16                              asl     <a href="#Symtileptr">tileptr</a>
6835: 26 17                              rol     <a href="#Symtileptr">tileptr</a>+1
6837: 06 16                              asl     <a href="#Symtileptr">tileptr</a>
6839: 26 17                              rol     <a href="#Symtileptr">tileptr</a>+1
683b: a5 60                              lda     <a href="#Symtileset">tileset</a>
683d: d0 0e                              bne     <a href="#Symadd_2F00_to_zp16">add_2F00_to_zp16</a>        ;*$16 += $2F00 (when $60 is nonzero)
683f: a5 16                              lda     <a href="#Symtileptr">tileptr</a>                 ;*$16 += $3800 (when $60 is zero)
6841: 18                                 clc
6842: 69 00                              adc     #$00
6844: 85 16                              sta     <a href="#Symtileptr">tileptr</a>
6846: a5 17                              lda     <a href="#Symtileptr">tileptr</a>+1
6848: 69 38                              adc     #$38
684a: 85 17                              sta     <a href="#Symtileptr">tileptr</a>+1
684c: 60                                 rts

                   ; Add $2F00 to the 16-bit address in $16.
684d: a5 16        <a name="Symadd_2F00_to_zp16">add_2F00_to_zp16</a>      lda     <a href="#Symtileptr">tileptr</a>
684f: 18                                 clc
6850: 69 00                              adc     #$00
6852: 85 16                              sta     <a href="#Symtileptr">tileptr</a>
6854: a5 17                              lda     <a href="#Symtileptr">tileptr</a>+1
6856: 69 2f                              adc     #$2f
6858: 85 17                              sta     <a href="#Symtileptr">tileptr</a>+1
685a: 60                                 rts

                   ; Convert TEXTROW/TEXTCOL to hires address and stores addr in $14.
685b: a2 20        <a name="Symcalc_hires_textpos">calc_hires_textpos</a>    ldx     #$20                    ;offset into hireshi ($20+$20 will be page 2)
685d: 86 15                              stx     <a href="#Symhires_addr">hires_addr</a>+1
685f: a9 00                              lda     #$00
6861: 85 14                              sta     <a href="#Symhires_addr">hires_addr</a>
6863: a4 06                              ldy     <a href="#SymTXTROW">TXTROW</a>
6865: b9 40 1d                           lda     <a href="#SymGAME1_hireslo">GAME1_hireslo</a>,y         ;hires line table
6868: 18                                 clc
6869: 65 14                              adc     <a href="#Symhires_addr">hires_addr</a>
686b: 85 14                              sta     <a href="#Symhires_addr">hires_addr</a>
686d: b9 60 1d                           lda     <a href="#SymGAME1_hireshi">GAME1_hireshi</a>,y         ;hires page 2
6870: 65 15                              adc     <a href="#Symhires_addr">hires_addr</a>+1
6872: 85 15                              sta     <a href="#Symhires_addr">hires_addr</a>+1
6874: a5 05                              lda     <a href="#SymTXTCOL">TXTCOL</a>
6876: 18                                 clc
6877: 65 14                              adc     <a href="#Symhires_addr">hires_addr</a>
6879: 85 14                              sta     <a href="#Symhires_addr">hires_addr</a>
687b: a9 00                              lda     #$00
687d: 65 15                              adc     <a href="#Symhires_addr">hires_addr</a>+1
687f: 85 15                              sta     <a href="#Symhires_addr">hires_addr</a>+1
6881: 60                                 rts

                   <span style="background-color: #cbcb00">NOTE: There's already a handle_npc? so this is another temp name.</span>
6882: a9 00        <a name="Symhandle_npc2">handle_npc2?</a>          lda     #$00
6884: 85 6b                              sta     <a href="#Symzp6b_npcHere">zp6b_npcHere</a>
6886: a9 32                              lda     #$32
6888: 85 6c                              sta     <a href="#SymnpcX">npcX</a>
688a: 85 6d                              sta     <a href="#SymnpcY">npcY</a>
688c: ae f1 02                           ldx     <a href="#SymRWTSBUF_npcnum">RWTSBUF_npcnum</a>
688f: bd 00 b2                           lda     <a href="#Symstate_npc1">state_npc1</a>,x            ;differs from state_npc
6892: 2c bf 1d                           bit     <a href="#SymGAME1_BITTAB7">GAME1_BITTAB7</a>           ;test bit 7
6895: f0 01                              beq     @check_npc_present      ;if 0
6897: 60                                 rts

6898: ad e1 02     @check_npc_present    lda     <a href="#SymRWTSBUF_npc">RWTSBUF_npc</a>
689b: d0 01                              bne     @npc_present
689d: 60                                 rts

689e: ad f2 02     @npc_present          lda     <a href="#SymRWTSBUF_npctype">RWTSBUF_npctype</a>
68a1: 29 f0                              and     #$f0
68a3: c9 e0                              cmp     #$e0
68a5: d0 1b                              bne     <a href="#SymL68C2">L68C2</a>
68a7: bd 80 b2                           lda     <a href="#Symstate_npc">state_npc</a>,x             ;npctype $e0..$ef -- check state bits 0..4
68aa: 29 1f                              and     #$1f
68ac: c5 21                              cmp     <a href="#SymtimeOfDay">timeOfDay</a>
68ae: f0 12                              beq     <a href="#SymL68C2">L68C2</a>
68b0: 20 63 61                           jsr     <a href="#Symread_0900_next">read_0900_next</a>          ;probably pseudo-randomness
68b3: 29 03                              and     #$03                    ;test lowest 2 bits
68b5: f0 01                              beq     <a href="#SymL68B8">L68B8</a>                   ;25% chance?
68b7: 60                                 rts

                   <span style="background-color: #cbcb00">NOTE: May handle periodic NPC behavior... walking?</span>
68b8: bd 80 b2     <a name="SymL68B8">L68B8</a>                 lda     <a href="#Symstate_npc">state_npc</a>,x
68bb: 29 e0                              and     #$e0
68bd: 05 21                              ora     <a href="#SymtimeOfDay">timeOfDay</a>               ;update NPC's state with current time of day
68bf: 9d 80 b2                           sta     <a href="#Symstate_npc">state_npc</a>,x
68c2: ad e1 02     <a name="SymL68C2">L68C2</a>                 lda     <a href="#SymRWTSBUF_npc">RWTSBUF_npc</a>             ;the only place where the value (not bool) of NPC is used
68c5: 4a                                 lsr     A
68c6: 4a                                 lsr     A
68c7: 4a                                 lsr     A
68c8: 4a                                 lsr     A
68c9: 85 6a                              sta     $6a                     ;store top 4 bits (shifted to low bits)
68cb: aa                                 tax
68cc: bd 86 69                           lda     <a href="#SymL6986">L6986</a>,x
68cf: 85 11                              sta     <a href="#Symtemp11_textlo">temp11_textlo</a>
68d1: bd 91 69                           lda     <a href="#SymL6991">L6991</a>,x
68d4: 85 12                              sta     <a href="#Symtemp12_texthi">temp12_texthi</a>
68d6: a9 02                              lda     #$02
68d8: 85 08                              sta     <a href="#Symtemp08">temp08</a>
68da: a6 08        <a name="SymL68DA">L68DA</a>                 ldx     <a href="#Symtemp08">temp08</a>
68dc: bd 8b 69                           lda     <a href="#SymL698B">L698B</a>,x
68df: 85 09                              sta     <a href="#Symtemp09">temp09</a>
68e1: bd 9c 69                           lda     <a href="#SymL699C">L699C</a>,x
68e4: 85 0a                              sta     <a href="#Symtemp0a">temp0a</a>
68e6: bd 8e 69                           lda     <a href="#SymL698E">L698E</a>,x
68e9: 85 68                              sta     $68
68eb: bd 9f 69                           lda     <a href="#SymL699F">L699F</a>,x
68ee: 85 69                              sta     $69
68f0: a0 7e                              ldy     #$7e
68f2: a2 08        <a name="SymL68F2">L68F2</a>                 ldx     #$08
68f4: b1 11                              lda     (<a href="#Symtemp11_textlo">temp11_textlo</a>),y
68f6: 91 09                              sta     (<a href="#Symtemp09">temp09</a>),y
68f8: 0a           <a name="SymL68F8">L68F8</a>                 asl     A
68f9: 66 65                              ror     $65
68fb: ca                                 dex
68fc: d0 fa                              bne     <a href="#SymL68F8">L68F8</a>
68fe: a5 65                              lda     $65
6900: 91 68                              sta     ($68),y
6902: 88                                 dey
6903: 10 ed                              bpl     <a href="#SymL68F2">L68F2</a>
6905: a0 7e                              ldy     #$7e
6907: b1 68        <a name="SymL6907">L6907</a>                 lda     ($68),y
6909: 48                                 pha
690a: 88                                 dey
690b: 88                                 dey
690c: b1 68                              lda     ($68),y
690e: c8                                 iny
690f: c8                                 iny
6910: 91 68                              sta     ($68),y
6912: 88                                 dey
6913: 88                                 dey
6914: 68                                 pla
6915: 91 68                              sta     ($68),y
6917: c0 40                              cpy     #$40
6919: d0 01                              bne     <a href="#SymL691C">L691C</a>
691b: 88                                 dey
691c: 88           <a name="SymL691C">L691C</a>                 dey
691d: 10 e8                              bpl     <a href="#SymL6907">L6907</a>
691f: 18                                 clc
6920: a5 11                              lda     <a href="#Symtemp11_textlo">temp11_textlo</a>
6922: 69 80                              adc     #$80
6924: 90 02                              bcc     <a href="#SymL6928">L6928</a>
6926: e6 12                              inc     <a href="#Symtemp12_texthi">temp12_texthi</a>
6928: 85 11        <a name="SymL6928">L6928</a>                 sta     <a href="#Symtemp11_textlo">temp11_textlo</a>
692a: c6 08                              dec     <a href="#Symtemp08">temp08</a>
692c: 10 ac                              bpl     <a href="#SymL68DA">L68DA</a>
692e: ad e4 02                           lda     <a href="#SymRWTSBUF_npcX">RWTSBUF_npcX</a>
6931: 85 6c                              sta     <a href="#SymnpcX">npcX</a>
6933: ad e5 02                           lda     <a href="#SymRWTSBUF_npcY">RWTSBUF_npcY</a>
6936: 85 6d                              sta     <a href="#SymnpcY">npcY</a>
6938: ad e3 02                           lda     <a href="#SymRWTSBUF">RWTSBUF</a>+227
693b: 48                                 pha
693c: 29 0f                              and     #$0f
693e: 85 6e                              sta     <a href="#Symzp6e">zp6e</a>
6940: 68                                 pla
6941: 4a                                 lsr     A
6942: 4a                                 lsr     A
6943: 4a                                 lsr     A
6944: 4a                                 lsr     A
6945: 85 08                              sta     <a href="#Symtemp08">temp08</a>
6947: 20 63 61     <a name="SymL6947">L6947</a>                 jsr     <a href="#Symread_0900_next">read_0900_next</a>
694a: 29 1f                              and     #$1f
694c: c5 08                              cmp     <a href="#Symtemp08">temp08</a>
694e: b0 f7                              bcs     <a href="#SymL6947">L6947</a>
6950: 18                                 clc
6951: 65 6c                              adc     <a href="#SymnpcX">npcX</a>
6953: 85 6c                              sta     <a href="#SymnpcX">npcX</a>
6955: 20 63 61                           jsr     <a href="#Symread_0900_next">read_0900_next</a>
6958: 29 01                              and     #$01
695a: d0 02                              bne     <a href="#SymL695E">L695E</a>
695c: a9 ff                              lda     #$ff
695e: 85 6f        <a name="SymL695E">L695E</a>                 sta     <a href="#SymnpcFacing">npcFacing</a>
6960: 20 18 6b                           jsr     <a href="#SymL6B18">L6B18</a>
6963: 20 15 6b                           jsr     <a href="#SymL6B15">L6B15</a>
6966: a9 00                              lda     #$00
6968: 85 50                              sta     $50
696a: 85 51                              sta     $51
696c: 85 52                              sta     $52
696e: 85 53                              sta     $53
6970: a9 04                              lda     #$04
6972: 85 54                              sta     $54
6974: ad e2 02                           lda     <a href="#SymRWTSBUF">RWTSBUF</a>+226
6977: 48                                 pha
6978: 29 0f                              and     #$0f                    ;lower 4 bits in $45
697a: 85 45                              sta     <a href="#SymMON_A5H">MON_A5H</a>                 ;used only in LA065 in combo with $28
697c: 68                                 pla
697d: 4a                                 lsr     A
697e: 4a                                 lsr     A
697f: 4a                                 lsr     A
6980: 4a                                 lsr     A
6981: 85 46                              sta     $46                     ;upper 4 bits in $46 (shifted right 4)
6983: e6 6b                              inc     <a href="#Symzp6b_npcHere">zp6b_npcHere</a>
6985: 60                                 rts

6986: 80           <a name="SymL6986">L6986</a>                 .dd1    $80
6987: 00                                 .dd1    $00
6988: 80                                 .dd1    $80
6989: 00                                 .dd1    $00
698a: 80                                 .dd1    $80
698b: 00           <a name="SymL698B">L698B</a>                 .dd1    $00
698c: 80                                 .dd1    $80
698d: 00                                 .dd1    $00
698e: 80           <a name="SymL698E">L698E</a>                 .dd1    $80
698f: 00                                 .dd1    $00
6990: 80                                 .dd1    $80
6991: 85           <a name="SymL6991">L6991</a>                 .dd1    $85
6992: 87                                 .dd1    $87
6993: 88                                 .dd1    $88
6994: 8a                                 .dd1    $8a
6995: 8b                                 .dd1    $8b
6996: 8d                                 .dd1    $8d
6997: 8e                                 .dd1    $8e
6998: 90                                 .dd1    $90
6999: 91                                 .dd1    $91
699a: 93                                 .dd1    $93
699b: 94                                 .dd1    $94
699c: b0           <a name="SymL699C">L699C</a>                 .dd1    $b0
699d: af                                 .dd1    $af
699e: af                                 .dd1    $af
699f: b1           <a name="SymL699F">L699F</a>                 .dd1    $b1
69a0: b1                                 .dd1    $b1
69a1: b0                                 .dd1    $b0

                   ; Swap $0000..00FF with $0800..08FF. Generally called to save/restore
                   ; zero page when reading a new sector (screen) from disk.
69a2: a2 00        <a name="Symswapzp8">swapzp8</a>               ldx     #$00
69a4: bd 00 00     @loop                 lda     a:$0000,x
69a7: 48                                 pha
69a8: bd 00 08                           lda     $0800,x
69ab: 9d 00 00                           sta     a:$0000,x
69ae: 68                                 pla
69af: 9d 00 08                           sta     $0800,x
69b2: e8                                 inx
69b3: d0 ef                              bne     @loop
69b5: 60                                 rts

                   ; Copy X pages of data from page A ($AA00) to page Y ($YY00).
                   dst                   .var    $09    {addr/2}
                   src                   .var    $11    {addr/2}

69b6: 85 12        <a name="Symcopypages">copypages</a>             sta     src+1
69b8: 84 0a                              sty     dst+1
69ba: a0 00                              ldy     #$00
69bc: 84 11                              sty     src
69be: 84 09                              sty     dst
69c0: b1 11        @loop                 lda     (src),y
69c2: 91 09                              sta     (dst),y
69c4: c8                                 iny
69c5: d0 f9                              bne     @loop
69c7: e6 12                              inc     src+1                   ;next page
69c9: e6 0a                              inc     dst+1
69cb: ca                                 dex
69cc: d0 f2                              bne     @loop
69ce: 60                                 rts

                   ; Zero out X pages starting from page A ($AA00).
                   dst                   .var    $11    {addr/2}

69cf: 85 12        <a name="Symclearpages">clearpages</a>            sta     dst+1
69d1: a9 00                              lda     #$00
69d3: 85 11                              sta     dst
69d5: a8                                 tay                             ;A and Y are now 0
69d6: 91 11        @loop                 sta     (dst),y
69d8: c8                                 iny
69d9: d0 fb                              bne     @loop
69db: e6 12                              inc     dst+1
69dd: ca                                 dex
69de: d0 f6                              bne     @loop
69e0: 60                                 rts

                   ; Delay loop. Decrement Y 256 times, X times. X and Y are 0 on exit.
69e1: a0 00        <a name="SymdelayXtimes256">delayXtimes256</a>        ldy     #$00
69e3: 88           @dey                  dey
69e4: d0 fd                              bne     @dey
69e6: ca                                 dex
69e7: d0 f8                              bne     <a href="#SymdelayXtimes256">delayXtimes256</a>
69e9: 60                                 rts

                   ; Delay loop. Decrement Y 512 times, X times. X and Y are 0 on exit.
69ea: 88           <a name="Symdelay2">delay2</a>                dey
69eb: d0 fd                              bne     <a href="#Symdelay2">delay2</a>
69ed: 88           @dey                  dey
69ee: d0 fd                              bne     @dey
69f0: ca                                 dex
69f1: d0 f7                              bne     <a href="#Symdelay2">delay2</a>
69f3: 60                                 rts

69f4: 20 e6 63     <a name="Symspirit_bell_rings">spirit_bell_rings</a>     jsr     <a href="#Symcleartext">cleartext</a>
69f7: 20 d6 66                           jsr     <a href="#SymPRNTSTR">PRNTSTR</a>
69fa: 01                                 .dd1    $01
69fb: d4 c8 c5 a0+                       .str    THE SPIRIT BELL RINGS
6a10: ff                                 .dd1    $ff
6a11: a2 0c                              ldx     #$0c
6a13: 20 03 b6                           jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>
6a16: 20 06 77                           jsr     <a href="#SymGAME2_message_wait">GAME2_message_wait</a>
6a19: a9 00                              lda     #$00
6a1b: 85 bc                              sta     <a href="#SymzpBC_bellrings">zpBC_bellrings</a>
6a1d: 4c 82 60                           jmp     <a href="#Symgame_loop">game_loop</a>?

6a20: a5 1c        <a name="SymL6A20">L6A20</a>                 lda     <a href="#SymMAPHALF">MAPHALF</a>
6a22: d0 0a                              bne     <a href="#SymL6A2E">L6A2E</a>
6a24: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>
6a26: c9 be                              cmp     #$be
6a28: d0 03                              bne     <a href="#SymL6A2D">L6A2D</a>
6a2a: 20 1e 9c     <a name="SymL6A2A">L6A2A</a>                 jsr     <a href="#SymSCRN_triumph_melody">SCRN_triumph_melody</a>
6a2d: 60           <a name="SymL6A2D">L6A2D</a>                 rts

6a2e: a5 1b        <a name="SymL6A2E">L6A2E</a>                 lda     <a href="#SymMAPPOS">MAPPOS</a>
6a30: c9 80                              cmp     #$80
6a32: d0 f9                              bne     <a href="#SymL6A2D">L6A2D</a>
6a34: f0 f4                              beq     <a href="#SymL6A2A">L6A2A</a>

6a36: 20 d6 66     <a name="Symgame_over">game_over</a>             jsr     <a href="#SymPRNTSTR">PRNTSTR</a>
6a39: 01                                 .dd1    $01
6a3a: d4 c8 c5 a0+                       .str    THE LIGHT FADES INTO DARKNESS...
6a5a: ff                                 .dd1    $ff
6a5b: 20 d6 66                           jsr     <a href="#SymPRNTSTR">PRNTSTR</a>
6a5e: 29                                 .dd1    $29
6a5f: d4 c8 c5 a0+                       .str    THE TIME FOR YOUR QUEST HAS ENDED.
6a81: ff                                 .dd1    $ff
6a82: 20 d6 66                           jsr     <a href="#SymPRNTSTR">PRNTSTR</a>
6a85: 51                                 .dd1    $51
6a86: c7 d2 c5 c5+                       .str    GREEN-SKY AWAITS ANOTHER QUESTER.
6aa7: ff                                 .dd1    $ff
6aa8: a9 00                              lda     #$00
6aaa: 20 00 b6                           jsr     <a href="#SymSCRN_play_melody">SCRN_play_melody</a>
6aad: a5 83        <a name="SymL6AAD">L6AAD</a>                 lda     <a href="#SymwaitMelody">waitMelody</a>
6aaf: d0 fc                              bne     <a href="#SymL6AAD">L6AAD</a>
6ab1: 20 09 6b     <a name="SymL6AB1">L6AB1</a>                 jsr     <a href="#SymGAME2_ongoing_input">GAME2_ongoing_input</a>
6ab4: f0 fb                              beq     <a href="#SymL6AB1">L6AB1</a>
6ab6: a9 00                              lda     #$00
6ab8: 85 3d                              sta     <a href="#SymGAMEOVER">GAMEOVER</a>                ;unset gameover
6aba: 85 ba                              sta     $ba
6abc: 4c 40 a8                           jmp     <a href="#SymSCRN_warm_start">SCRN_warm_start</a>

                   ; Read T22,S00..02 into $B300..$B5FF. This sets the initial item state from the
                   ; game disk. Note the RWTS IOB r/w buffer points to $0200 by default, and that
                   ; is temporarily changed during this read.
6abf: a9 22        <a name="Syminit_item_state">init_item_state</a>       lda     #$22
6ac1: 8d 04 03                           sta     <a href="#SymRWTS_IOB_track">RWTS_IOB_track</a>
6ac4: a9 00                              lda     #$00
6ac6: 85 41                              sta     <a href="#SymMON_A3H">MON_A3H</a>
6ac8: 85 35                              sta     <a href="#SymdoorNeshom">doorNeshom</a>
6aca: 85 44                              sta     <a href="#SymlampFuel">lampFuel</a>
6acc: 85 3a                              sta     <a href="#SymlitLamp">litLamp</a>
6ace: 85 38                              sta     <a href="#SymfallaKeyOffered">fallaKeyOffered</a>
6ad0: 8d 05 03                           sta     <a href="#SymRWTS_IOB_sector">RWTS_IOB_sector</a>
6ad3: a9 01                              lda     #<a href="#SymRWTSCMD_read">RWTSCMD_read</a>
6ad5: 8d 0c 03                           sta     <a href="#SymRWTS_IOB_command">RWTS_IOB_command</a>
6ad8: ae 05 03     <a name="SymL6AD8">L6AD8</a>                 ldx     <a href="#SymRWTS_IOB_sector">RWTS_IOB_sector</a>
6adb: bd e5 62                           lda     <a href="#Symitem_state_pages">item_state_pages</a>,x      ;override page to read into
6ade: 8d 09 03                           sta     <a href="#SymRWTS_IOB_buf">RWTS_IOB_buf</a>+1
6ae1: 20 a2 69                           jsr     <a href="#Symswapzp8">swapzp8</a>
6ae4: 20 15 03                           jsr     <a href="#SymDIRECT_RWTS">DIRECT_RWTS</a>
6ae7: 20 a2 69                           jsr     <a href="#Symswapzp8">swapzp8</a>
6aea: ee 05 03                           inc     <a href="#SymRWTS_IOB_sector">RWTS_IOB_sector</a>
6aed: ad 05 03                           lda     <a href="#SymRWTS_IOB_sector">RWTS_IOB_sector</a>
6af0: c9 03                              cmp     #$03
6af2: d0 e4                              bne     <a href="#SymL6AD8">L6AD8</a>                   ;read sectors 00..02
6af4: a9 02                              lda     #$02                    ;restore read buffer to page $02
6af6: 8d 09 03                           sta     <a href="#SymRWTS_IOB_buf">RWTS_IOB_buf</a>+1
6af9: 60                                 rts

6afa: 05                                 .dd1    $05
6afb: 03                                 .dd1    $03
6afc: ad                                 .dd1    $ad
6afd: 05                                 .dd1    $05
6afe: 03                                 .dd1    $03
6aff: c9                                 .dd1    $c9

                   <span style="background-color: #cbcb00">NOTE: Jump vectors at $6b00</span>
6b00: 4c 30 6b     <a name="SymGAME2_next_frame">GAME2_next_frame</a>      jmp     <a href="#Symframe">frame</a>                   ;game tick

6b03: 4c 4f 74     <a name="SymGAME2_draw_player">GAME2_draw_player</a>     jmp     <a href="#Symdraw_player">draw_player</a>

6b06: 4c 20 75     <a name="SymGAME2_erase_player">GAME2_erase_player</a>    jmp     <a href="#Symerase_old_player">erase_old_player</a>

6b09: 4c c3 75     <a name="SymGAME2_ongoing_input">GAME2_ongoing_input</a>   jmp     <a href="#Symget_ongoing_input">get_ongoing_input</a>

6b0c: 4c 4c 74     <a name="SymGAME2_redraw_player">GAME2_redraw_player</a>   jmp     <a href="#Symredraw_player">redraw_player</a>

6b0f: 4c 2a 72     <a name="SymGAME2_adjacent_tiles">GAME2_adjacent_tiles</a>  jmp     <a href="#Symget_adjacent_tiles">get_adjacent_tiles</a>

6b12: 4c 7e 72     <a name="SymL6B12">L6B12</a>                 jmp     <a href="#Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>

6b15: 4c 79 75     <a name="SymL6B15">L6B15</a>                 jmp     <a href="#Symdraw_npc">draw_npc</a>?               ;called in SCREEN

6b18: 4c 62 75     <a name="SymL6B18">L6B18</a>                 jmp     <a href="#SymL7562">L7562</a>

6b1b: 4c                                 .dd1    $4c                     ;called in SCREEN
6b1c: a6                                 .dd1    $a6
6b1d: 75                                 .dd1    $75

6b1e: 4c 60 72     <a name="SymGAME2_tile_at_xy">GAME2_tile_at_xy</a>      jmp     <a href="#Symget_tile_at_xy">get_tile_at_xy</a>          ;get_tile_at_xy

6b21: 4c d6 72     <a name="SymL6B21">L6B21</a>                 jmp     <a href="#Symstop_frame_ground">stop_frame_ground</a>

6b24: 4c f6 72     <a name="SymGAME2_win_game">GAME2_win_game</a>        jmp     <a href="#Symwin_game">win_game</a>

6b27: 4c 09 b6     <a name="SymGAME2_chkkey">GAME2_chkkey</a>          jmp     <a href="#SymSCRN_chkkey">SCRN_chkkey</a>             ;external entry point

6b2a: 4c b1 75     <a name="SymGAME2_menu_input">GAME2_menu_input</a>      jmp     <a href="#Symget_menu_input">get_menu_input</a>

6b2d: 4c                                 .dd1    $4c
6b2e: 7d                                 .dd1    $7d
6b2f: 71                                 .dd1    $71

6b30: 20 57 6b     <a name="Symframe">frame</a>                 jsr     <a href="#Symmaybe_tick">maybe_tick</a>
6b33: a5 b3                              lda     $b3
6b35: f0 03                              beq     <a href="#SymL6B3A">L6B3A</a>
6b37: 20 a6 75                           jsr     <a href="#SymL75A6">L75A6</a>
6b3a: a5 b2        <a name="SymL6B3A">L6B3A</a>                 lda     <a href="#SymerasePlayer">erasePlayer</a>             ;May indicate player needs to be erased
6b3c: d0 05                              bne     @erase_and_draw
6b3e: a5 b3                              lda     $b3
6b40: d0 04                              bne     <a href="#SymL6B46">L6B46</a>
6b42: 60                                 rts

6b43: 20 20 75     @erase_and_draw       jsr     <a href="#Symerase_old_player">erase_old_player</a>
6b46: a5 6b        <a name="SymL6B46">L6B46</a>                 lda     <a href="#Symzp6b_npcHere">zp6b_npcHere</a>
6b48: f0 03                              beq     @draw
6b4a: 20 79 75                           jsr     <a href="#Symdraw_npc">draw_npc</a>?               ;?
6b4d: 20 4f 74     @draw                 jsr     <a href="#Symdraw_player">draw_player</a>
6b50: a9 00                              lda     #$00
6b52: 85 b3                              sta     $b3
6b54: 85 b2                              sta     <a href="#SymerasePlayer">erasePlayer</a>
6b56: 60                                 rts

                   ; Tick if the game timer is running.
6b57: a5 87        <a name="Symmaybe_tick">maybe_tick</a>            lda     <a href="#SymTICKING">TICKING</a>
6b59: d0 01                              bne     <a href="#Symtick">tick</a>
6b5b: 60                                 rts

6b5c: 20 1b 77     <a name="Symtick">tick</a>                  jsr     <a href="#SymGAME2_next_tick">GAME2_next_tick</a>
6b5f: 20 a9 6f                           jsr     <a href="#Symhandle_npc">handle_npc</a>?
6b62: e6 88                              inc     <a href="#SymanimTimer">animTimer</a>
6b64: a5 88                              lda     <a href="#SymanimTimer">animTimer</a>               ;? timer counting up until animDelay to update player frame
6b66: c5 90                              cmp     <a href="#SymanimDelay">animDelay</a>               ;why not just dec animDelay
6b68: f0 01                              beq     @update
6b6a: 60                                 rts

6b6b: a9 00        @update               lda     #$00
6b6d: 85 88                              sta     <a href="#SymanimTimer">animTimer</a>
6b6f: 20 2a 72                           jsr     <a href="#Symget_adjacent_tiles">get_adjacent_tiles</a>
6b72: a5 e3                              lda     <a href="#SymtileUnder">tileUnder</a>
6b74: 20 7e 72                           jsr     <a href="#Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>
6b77: a5 9b                              lda     <a href="#SymcrouchFlag">crouchFlag</a>
6b79: f0 03                              beq     <a href="#SymL6B7E">L6B7E</a>
6b7b: 4c cf 6e                           jmp     <a href="#Symuncrouch">uncrouch</a>                ;resets $9b and returns -- noop frame?

6b7e: a5 f0        <a name="SymL6B7E">L6B7E</a>                 lda     <a href="#SymySolid">ySolid</a>
6b80: f0 14                              beq     <a href="#SymL6B96">L6B96</a>
6b82: a5 92                              lda     <a href="#SymFALLCNT">FALLCNT</a>
6b84: f0 10                              beq     <a href="#SymL6B96">L6B96</a>                   ;not falling, branch
6b86: c9 06                              cmp     #$06                    ;did we fall less than 6 tiles?
6b88: 90 03                              bcc     @footfall
6b8a: 20 0e 6e                           jsr     <a href="#Symfell_6_or_more">fell_6_or_more</a>          ;&gt;=6 tiles, jsr
6b8d: a2 02        @footfall             ldx     #$02                    ;landing noise
6b8f: 20 03 b6                           jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>
6b92: a9 00                              lda     #$00                    ;reset fall count
6b94: 85 92                              sta     <a href="#SymFALLCNT">FALLCNT</a>
6b96: a5 96        <a name="SymL6B96">L6B96</a>                 lda     <a href="#SymtakingStep">takingStep</a>
6b98: f0 03                              beq     <a href="#Symcheck_bonk">check_bonk</a>
6b9a: 4c d6 6e                           jmp     <a href="#Symwalk_crawl_cycle">walk_crawl_cycle</a>

6b9d: a5 93        <a name="Symcheck_bonk">check_bonk</a>            lda     <a href="#SymbonkFrame">bonkFrame</a>
6b9f: f0 03                              beq     <a href="#Symcheck_jumping">check_jumping</a>
6ba1: 4c cf 6d                           jmp     <a href="#Symbonking">bonking</a>

6ba4: a5 8c        <a name="Symcheck_jumping">check_jumping</a>         lda     <a href="#SymjumpFlag">jumpFlag</a>
6ba6: f0 03                              beq     <a href="#Symcheck_flying">check_flying</a>
6ba8: 4c 12 6d                           jmp     <a href="#Symjumping">jumping</a>

6bab: a5 94        <a name="Symcheck_flying">check_flying</a>          lda     <a href="#SymflyFlag">flyFlag</a>
6bad: f0 03                              beq     @notflying_check_x
6baf: 4c 66 6e                           jmp     <a href="#Symflying">flying</a>

6bb2: a5 85        @notflying_check_x    lda     <a href="#SymXDIR">XDIR</a>
6bb4: 85 91                              sta     $91                     ;save old xdir ?
6bb6: 20 c3 75                           jsr     <a href="#Symget_ongoing_input">get_ongoing_input</a>
6bb9: f0 54                              beq     <a href="#Symcheck_non_door_tile">check_non_door_tile</a>     ;no button pressed
6bbb: a5 92                              lda     <a href="#SymFALLCNT">FALLCNT</a>                 ;(virtual) button press
6bbd: c9 02                              cmp     #$02                    ;have we fallen &gt;= 2 tiles?
6bbf: 90 0b                              bcc     <a href="#Symbutton_check_x">button_check_x</a>
6bc1: a5 f0                              lda     <a href="#SymySolid">ySolid</a>                  ;and no solid ground below us?
6bc3: d0 07                              bne     <a href="#Symbutton_check_x">button_check_x</a>
6bc5: a5 a0                              lda     $a0                     ;and ???
6bc7: d0 03                              bne     <a href="#Symbutton_check_x">button_check_x</a>
6bc9: 4c 40 6e                           jmp     <a href="#Symcheck_has_shuba">check_has_shuba</a>         ;then do shuba check, we may fly

                   ; Reached here after (virtual) button press, and not trying to deploy shuba.
                   ; Check X motion.
6bcc: a5 85        <a name="Symbutton_check_x">button_check_x</a>        lda     <a href="#SymXDIR">XDIR</a>
6bce: f0 1a                              beq     <a href="#Symbutton_check_y">button_check_y</a>
6bd0: a5 f0                              lda     <a href="#SymySolid">ySolid</a>                  ;ignore x motion if we are standing on air
6bd2: f0 3b                              beq     <a href="#Symcheck_non_door_tile">check_non_door_tile</a>     ;this tile will be handled as air
6bd4: a5 85                              lda     <a href="#SymXDIR">XDIR</a>
6bd6: c5 95                              cmp     <a href="#SymFACING">FACING</a>
6bd8: f0 0d                              beq     @jump
6bda: 85 95                              sta     <a href="#SymFACING">FACING</a>                  ;face the way we are moving
6bdc: 20 2e 6e                           jsr     <a href="#Symis_climbing">is_climbing</a>
6bdf: b0 06                              bcs     @jump                   ;when climbing, allow jump in opposite direction
6be1: 20 d6 72                           jsr     <a href="#Symstop_frame_ground">stop_frame_ground</a>
6be4: 4c c0 6c                           jmp     <a href="#Symfinish_move">finish_move</a>

6be7: 4c 8a 6d     @jump                 jmp     <a href="#Symtry_jump">try_jump</a>

                   ; Virtual button press, check Y motion. (Remember, keyboard input is translated
                   ; into the joystick API, so SPACE -&gt; JOY DOWN + BUTTON, which enters the menu
                   ; below.)
6bea: a5 86        <a name="Symbutton_check_y">button_check_y</a>        lda     <a href="#SymYDIR">YDIR</a>
6bec: f0 14                              beq     <a href="#Symcheck_door_tile">check_door_tile</a>         ;not moving, check door etc.
6bee: 30 12                              bmi     <a href="#Symcheck_door_tile">check_door_tile</a>         ;moving up, check door etc.
6bf0: a5 e3                              lda     <a href="#SymtileUnder">tileUnder</a>               ;moving down, check tile below us
6bf2: 20 7e 72                           jsr     <a href="#Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>
6bf5: a5 f0                              lda     <a href="#SymySolid">ySolid</a>
6bf7: f0 09                              beq     <a href="#Symcheck_door_tile">check_door_tile</a>         ;not solid, I guess we can enter doors while falling?
6bf9: a9 00                              lda     #$00                    ;solid ground, pressing button+down enters menu
6bfb: 85 87                              sta     <a href="#SymTICKING">TICKING</a>
6bfd: a9 01                              lda     #$01
6bff: 85 9f                              sta     <a href="#SymenterMenu">enterMenu</a>
6c01: 60                                 rts

                   ; Check the tile we are in front of, and if it is a door tile (BA,BB,BC) then
                   ; handle it as a door (1..3). We will only reach this when the (virtual) button
                   ; is pressed.
6c02: a5 e0        <a name="Symcheck_door_tile">check_door_tile</a>       lda     <a href="#SymtileFeet">tileFeet</a>
6c04: c9 ba                              cmp     #$ba
6c06: 90 07                              bcc     <a href="#Symcheck_non_door_tile">check_non_door_tile</a>     ;&lt; $BA
6c08: c9 bd                              cmp     #$bd
6c0a: b0 03                              bcs     <a href="#Symcheck_non_door_tile">check_non_door_tile</a>     ;&gt; $BC
6c0c: 4c 97 71                           jmp     <a href="#Symhandle_door">handle_door</a>             ;$E0 == BA..BC; becomes door pointer 1..3

                   ; The button may or may not be pressed when we arrive here, but the selected
                   ; tile ($F0..$F2) is always the one under our feet. If the button is pressed, we
                   ; know we're not entering a door or the menu, as that was handled earlier.
6c0f: a5 f0        <a name="Symcheck_non_door_tile">check_non_door_tile</a>   lda     <a href="#SymySolid">ySolid</a>                  ;the tile under our feet, checked above
6c11: d0 16                              bne     <a href="#Symcheck_on_ladder">check_on_ladder</a>         ;branch if on solid ground
6c13: e6 1a                              inc     <a href="#SymplayerY">playerY</a>                 ;only air below us, fall one tile
6c15: a9 04                              lda     #$04
6c17: 85 90                              sta     <a href="#SymanimDelay">animDelay</a>
6c19: e6 92                              inc     <a href="#SymFALLCNT">FALLCNT</a>
6c1b: a5 92                              lda     <a href="#SymFALLCNT">FALLCNT</a>
6c1d: c9 02                              cmp     #$02                    ;have we fallen 2 tiles
6c1f: d0 05                              bne     @cont
6c21: a2 09                              ldx     #$09                    ;yes, play this sound, which appears to make no sound
6c23: 20 03 b6                           jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>         ;change to #$01 to beep after falling 2 tiles
6c26: 4c c4 6c     @cont                 jmp     <a href="#Symfinish_move2">finish_move2</a>            ;(skips resetting FALLCNT to 0)

                   ; Check if the player is centered on a ladder/vine, with a center ladder/vine
                   ; tile both at their feet and just under them. This implies the player is on a
                   ; ladder, since both tiles wouldn't be present if you are at the top or the
                   ; bottom of a ladder. Since horizontal motion on a ladder is disallowed, skip
                   ; XDIR handling if on the ladder.
6c29: a5 e0        <a name="Symcheck_on_ladder">check_on_ladder</a>       lda     <a href="#SymtileFeet">tileFeet</a>
6c2b: c9 b5                              cmp     #$b5                    ;ladder middle tile
6c2d: f0 04                              beq     @atfeet
6c2f: c9 b8                              cmp     #$b8                    ;vine middle tile
6c31: d0 0d                              bne     @check_horiz_motion
6c33: a5 e3        @atfeet               lda     <a href="#SymtileUnder">tileUnder</a>
6c35: c9 b5                              cmp     #$b5
6c37: f0 04                              beq     @on_ladder
6c39: c9 b8                              cmp     #$b8
6c3b: d0 03                              bne     @check_horiz_motion
6c3d: 4c 5e 6c     @on_ladder            jmp     <a href="#Symcheck_vert_motion">check_vert_motion</a>       ;on ladder; skip horiz motion check

                   ; Check horizontal motion. If yes, and we are facing the opposite direction,
                   ; face the new direction and cancel motion.
6c40: a5 85        @check_horiz_motion   lda     <a href="#SymXDIR">XDIR</a>
6c42: f0 1a                              beq     <a href="#Symcheck_vert_motion">check_vert_motion</a>       ;no horiz motion; check vertical
6c44: c5 95                              cmp     <a href="#SymFACING">FACING</a>
6c46: f0 0c                              beq     @facing_same_dir
6c48: 85 95                              sta     <a href="#SymFACING">FACING</a>                  ;moved opposite dir we are facing
6c4a: a9 00                              lda     #$00                    ;update facing direction, and cancel movement
6c4c: 85 af                              sta     <a href="#SymXMOVFLG">XMOVFLG</a>
6c4e: 20 d6 72                           jsr     <a href="#Symstop_frame_ground">stop_frame_ground</a>
6c51: 4c c0 6c                           jmp     <a href="#Symfinish_move">finish_move</a>

6c54: 38           @facing_same_dir      sec                             ;toggle $97 between 0 and 2 (step frame offset)
6c55: a9 02                              lda     #$02                    ;2-2=0, 2-0=2
6c57: e5 97                              sbc     $97
6c59: 85 97                              sta     $97
6c5b: 4c d6 6e                           jmp     <a href="#Symwalk_crawl_cycle">walk_crawl_cycle</a>

                   ; Check vertical motion. If moving up, and the tile at our feet is climbable,
                   ; start climbing up; if it's not climbable then stand up from a crawl (if
                   ; needed).
                   ; 
                   ; (You can arrive here after already confirming we are on the ladder. The below
                   ; checks are more general though, since you don't need to be centered on the
                   ; ladder, and it may be above or below you.)
6c5e: 18           <a name="Symcheck_vert_motion">check_vert_motion</a>     clc
6c5f: a5 86                              lda     <a href="#SymYDIR">YDIR</a>
6c61: f0 54                              beq     @no_vert_motion         ;no vertical motion
6c63: 10 33                              bpl     @moving_down            ;moving down
6c65: a5 e0                              lda     <a href="#SymtileFeet">tileFeet</a>                ;we are moving up
6c67: 20 7e 72                           jsr     <a href="#Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>
6c6a: a5 f2                              lda     <a href="#Symclimbable">climbable</a>
6c6c: d0 0b                              bne     @climb_up
6c6e: a5 9a                              lda     <a href="#SymcrawlFlag">crawlFlag</a>
6c70: f0 4d                              beq     @rts
6c72: a9 00                              lda     #$00
6c74: 85 9a                              sta     <a href="#SymcrawlFlag">crawlFlag</a>
6c76: 4c bc 6e                           jmp     <a href="#Symcrouch">crouch</a>

                   ; Climb; move player up 1 tile. Snap to the center of the ladder or vine.
6c79: a9 0a        @climb_up             lda     #$0a
6c7b: 85 90                              sta     <a href="#SymanimDelay">animDelay</a>
6c7d: c6 1a                              dec     <a href="#SymplayerY">playerY</a>                 ;move up 1 tile
6c7f: a5 e0                              lda     <a href="#SymtileFeet">tileFeet</a>
6c81: c9 b4        @check_left_side      cmp     #$b4                    ;left ladder tile
6c83: f0 04                              beq     @adjust_right
6c85: c9 b7                              cmp     #$b7                    ;left vine tile
6c87: d0 02                              bne     @check_right_side
6c89: e6 19        @adjust_right         inc     <a href="#SymplayerX">playerX</a>
6c8b: c9 b6        @check_right_side     cmp     #$b6                    ;right ladder tile
6c8d: f0 04                              beq     @adjust_left
6c8f: c9 b9                              cmp     #$b9                    ;right vine tile
6c91: d0 02                              bne     @cont
6c93: c6 19        @adjust_left          dec     <a href="#SymplayerX">playerX</a>
6c95: 4c 4b 6f     @cont                 jmp     <a href="#SymL6F4B">L6F4B</a>

                   ; If moving down and the tile below us is climbable, start climbing down; if
                   ; it's not climbable, start crawling (if not already doing so).
6c98: a5 e3        @moving_down          lda     <a href="#SymtileUnder">tileUnder</a>
6c9a: 20 7e 72                           jsr     <a href="#Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>
6c9d: a5 f2                              lda     <a href="#Symclimbable">climbable</a>               ;is tile at knee climbable?
6c9f: d0 0b                              bne     @climb_down
6ca1: a5 9a                              lda     <a href="#SymcrawlFlag">crawlFlag</a>               ;no, try to crawl
6ca3: d0 1a                              bne     @rts                    ;already crawling, return
6ca5: a9 01                              lda     #$01
6ca7: 85 9a                              sta     <a href="#SymcrawlFlag">crawlFlag</a>               ;now set crawl flag
6ca9: 4c bc 6e                           jmp     <a href="#Symcrouch">crouch</a>

                   ; Climb down; move down one tile. Snap to the center of the ladder or vine.
6cac: a9 0a        @climb_down           lda     #$0a                    ;signal climb start?
6cae: 85 90                              sta     <a href="#SymanimDelay">animDelay</a>
6cb0: e6 1a                              inc     <a href="#SymplayerY">playerY</a>
6cb2: a5 e3                              lda     <a href="#SymtileUnder">tileUnder</a>
6cb4: 4c 81 6c                           jmp     @check_left_side

6cb7: a9 08        @no_vert_motion       lda     #$08
6cb9: 85 90                              sta     <a href="#SymanimDelay">animDelay</a>
6cbb: a9 00                              lda     #$00
6cbd: 85 99                              sta     <a href="#SymrunFlag">runFlag</a>
6cbf: 60           @rts                  rts

                   ********************************************************************************
                   * Finishes up player movement for this frame.                                  *
                   *                                                                              *
                   * Stops any falling motion; assumes called when on solid ground. In one case   *
                   * this is bypassed, when it is known the player is in the air.                 *
                   *                                                                              *
                   * Checks for collision with water and sets a flag handled next frame.          *
                   *                                                                              *
                   * Checks for collision with brambles or walls.                                 *
                   *                                                                              *
                   * Checks if the player is offscreen (presumably by one tile) in either or both *
                   * of the X or Y axes. The player is moved 1 tile in the onscreen X direction   *
                   * if needed (Y position is not modified), and zp $8f is set to                 *
                   *   01 -- was off top                                                          *
                   *   02 -- was off right                                                        *
                   *   03 -- was off bottom                                                       *
                   *   04 -- was off left                                                         *
                   * with the Y axis taking precedence.                                           *
                   *                                                                              *
                   * This is called via JMP, so we will continue in the caller's caller.          *
                   ********************************************************************************
                   tmp_offScreenFlag     .var    $81    {addr/1}         ;whether the player was offscreen

6cc0: a9 00        <a name="Symfinish_move">finish_move</a>           lda     #$00                    ;stop falling, unless you enter this just below
6cc2: 85 92                              sta     <a href="#SymFALLCNT">FALLCNT</a>
6cc4: 20 28 71     <a name="Symfinish_move2">finish_move2</a>          jsr     <a href="#Symcheck_brambles">check_brambles</a>
6cc7: 20 4a 71                           jsr     <a href="#Symcheck_walls">check_walls</a>             ;(implicitly populates tileFeet)
                   ; Check if we touched water. If so, stop time and set a flag which will teleport
                   ; us home on the next frame. This subroutine continues but its offscreen
                   ; computations are irrelevant; it could just return instead.
6cca: a5 e0                              lda     <a href="#SymtileFeet">tileFeet</a>
6ccc: c9 20                              cmp     #<a href="#Symtile_water">tile_water</a>
6cce: d0 08                              bne     @left
6cd0: a9 01                              lda     #$01
6cd2: 85 80                              sta     <a href="#SymtouchedWater">touchedWater</a>
6cd4: a9 00                              lda     #$00                    ;halt timer in prep for teleport
6cd6: 85 87                              sta     <a href="#SymTICKING">TICKING</a>
6cd8: a9 00        @left                 lda     #$00
6cda: 85 81                              sta     tmp_offScreenFlag
6cdc: a5 19                              lda     <a href="#SymplayerX">playerX</a>
6cde: 10 08                              bpl     @right
6ce0: a2 04                              ldx     #$04                    ;player offscreen to left
6ce2: e6 19                              inc     <a href="#SymplayerX">playerX</a>
6ce4: e6 81                              inc     tmp_offScreenFlag
6ce6: d0 0a                              bne     @top                    ;(always)
6ce8: c9 28        @right                cmp     #$28
6cea: d0 06                              bne     @top
6cec: a2 02                              ldx     #$02                    ;player offscreen to right
6cee: c6 19                              dec     <a href="#SymplayerX">playerX</a>
6cf0: e6 81                              inc     tmp_offScreenFlag
6cf2: a5 1a        @top                  lda     <a href="#SymplayerY">playerY</a>
6cf4: 10 04                              bpl     @bottom
6cf6: a2 01                              ldx     #$01                    ;player offscreen to top
6cf8: d0 0c                              bne     @offscreen              ;(always)

6cfa: c9 13        @bottom               cmp     #$13
6cfc: 90 04                              bcc     @is_onscreen
6cfe: a2 03                              ldx     #$03                    ;player offscreen to bottom
6d00: d0 04                              bne     @offscreen              ;(always)

6d02: a5 81        @is_onscreen          lda     tmp_offScreenFlag       ;was the player offscreen?
6d04: f0 07                              beq     @queue_erase            ;no, queue up player erase
                   ; X is guaranteed to be set to 01..04 when the offscreen flag is set.
6d06: 86 8f        @offscreen            stx     <a href="#SymnextRoomDir">nextRoomDir</a>             ;yes, record in which direction
6d08: a9 00                              lda     #$00                    ;and halt timer
6d0a: 85 87                              sta     <a href="#SymTICKING">TICKING</a>
6d0c: 60                                 rts

6d0d: a9 01        @queue_erase          lda     #$01
6d0f: 85 b2                              sta     <a href="#SymerasePlayer">erasePlayer</a>
6d11: 60                                 rts

                    Clear variables

6d12: a9 04        <a name="Symjumping">jumping</a>               lda     #$04
6d14: 85 90                              sta     <a href="#SymanimDelay">animDelay</a>
6d16: a2 18                              ldx     #$18                    ;left jump frame
6d18: a5 95                              lda     <a href="#SymFACING">FACING</a>
6d1a: 30 02                              bmi     @left
6d1c: a2 1c                              ldx     #$1c                    ;right jump frame
6d1e: 20 b2 6e     @left                 jsr     <a href="#Symset_anim_frame">set_anim_frame</a>
6d21: a5 8d                              lda     <a href="#SymjumpFrame">jumpFrame</a>
6d23: c9 01                              cmp     #$01
6d25: f0 18                              beq     <a href="#Symupdate_jump_pos">update_jump_pos</a>         ;start of jump, do not check x solidity
6d27: a5 e3                              lda     <a href="#SymtileUnder">tileUnder</a>               ;check tile under our feet
6d29: 20 7e 72                           jsr     <a href="#Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>
6d2c: a5 f1                              lda     <a href="#SymxSolid">xSolid</a>
6d2e: f0 0f                              beq     <a href="#Symupdate_jump_pos">update_jump_pos</a>
6d30: a9 00                              lda     #$00                    ;tile is solid, so land on it (?)
6d32: 85 8c                              sta     <a href="#SymjumpFlag">jumpFlag</a>
6d34: 20 d6 72                           jsr     <a href="#Symstop_frame_ground">stop_frame_ground</a>
6d37: a2 02                              ldx     #$02                    ;footstep (landing sound)?
6d39: 20 03 b6                           jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>
6d3c: 4c 6b 6b                           jmp     @update

                   ; Update player position during jump. Player moves 1 tile horizontally during
                   ; each of 4 jump frames. During each of frames 1 &amp; 2, player moves up 1 tile;
                   ; and down 1 tile during frames 3 &amp; 4. If the player's stamina is 20 or more,
                   ; they jump farther by adding an extra frame (frame 3 is repeated, but the
                   ; player only moves horizontally).
6d3f: 18           <a name="Symupdate_jump_pos">update_jump_pos</a>       clc
6d40: a5 95                              lda     <a href="#SymFACING">FACING</a>
6d42: 65 19                              adc     <a href="#SymplayerX">playerX</a>
6d44: 85 19                              sta     <a href="#SymplayerX">playerX</a>
6d46: a6 8d                              ldx     <a href="#SymjumpFrame">jumpFrame</a>
6d48: e0 03                              cpx     #$03                    ;third frame?
6d4a: d0 04                              bne     @yupdate
6d4c: c6 b4                              dec     <a href="#SymlongJump">longJump</a>                ;1 (stamina &lt;20) or 2 (&gt;=20), set at start of jump
6d4e: d0 1c                              bne     @finish                 ;if 2, keep player at same Y, repeat frame 3 (with longJump 1)
6d50: bd 85 6d     @yupdate              lda     <a href="#Symjump_frame_yoffset">jump_frame_yoffset</a>-1,x  ;up,up,down,down
6d53: 18                                 clc
6d54: 65 1a                              adc     <a href="#SymplayerY">playerY</a>
6d56: 85 1a                              sta     <a href="#SymplayerY">playerY</a>
6d58: e8                                 inx
6d59: 86 8d                              stx     <a href="#SymjumpFrame">jumpFrame</a>
6d5b: e0 04                              cpx     #$04                    ;was this the 3rd or 4th frame?
6d5d: b0 10                              bcs     <a href="#Symland_player">land_player</a>
6d5f: a6 8d        @chk_last_frame       ldx     <a href="#SymjumpFrame">jumpFrame</a>
6d61: e0 05                              cpx     #$05
6d63: d0 07                              bne     @finish
6d65: a9 00                              lda     #$00                    ;last jump frame, always finish jump now
6d67: 85 8c                              sta     <a href="#SymjumpFlag">jumpFlag</a>
6d69: 20 d6 72                           jsr     <a href="#Symstop_frame_ground">stop_frame_ground</a>
6d6c: 4c c0 6c     @finish               jmp     <a href="#Symfinish_move">finish_move</a>

6d6f: a5 95        <a name="Symland_player">land_player</a>           lda     <a href="#SymFACING">FACING</a>
6d71: 10 05                              bpl     @right
6d73: a5 e4                              lda     <a href="#SymtileUnderLeft">tileUnderLeft</a>
6d75: 4c 7a 6d                           jmp     @check_ground

6d78: a5 e5        @right                lda     <a href="#SymtileUnderRight">tileUnderRight</a>
6d7a: 20 7e 72     @check_ground         jsr     <a href="#Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>
6d7d: a5 f1                              lda     <a href="#SymxSolid">xSolid</a>
6d7f: f0 de                              beq     @chk_last_frame
6d81: c6 1a                              dec     <a href="#SymplayerY">playerY</a>
6d83: 4c 5f 6d                           jmp     @chk_last_frame

6d86: ff           <a name="Symjump_frame_yoffset">jump_frame_yoffset</a>    .dd1    $ff                     ;jump frame 1..4 y offset
6d87: ff                                 .dd1    $ff                     ;(move up 2, then down 2)
6d88: 01                                 .dd1    $01
6d89: 01                                 .dd1    $01

                   ; Underground, in the the bottom 4 map rows (positions $0180-$01FF), you cannot
                   ; jump while climbing. This is probably an easy way to handle most ladders being
                   ; surrounded by solid rock; the few that are not, you don't notice this.
6d8a: a5 1c        <a name="Symtry_jump">try_jump</a>              lda     <a href="#SymMAPHALF">MAPHALF</a>
6d8c: f0 0c                              beq     <a href="#Symjump">jump</a>
6d8e: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>
6d90: c9 80                              cmp     #$80
6d92: 90 06                              bcc     <a href="#Symjump">jump</a>
6d94: 20 2e 6e                           jsr     <a href="#Symis_climbing">is_climbing</a>
6d97: 90 01                              bcc     <a href="#Symjump">jump</a>
6d99: 60                                 rts                             ;maphalf=$1,mappos&gt;=$80,climbing

6d9a: a9 06        <a name="Symjump">jump</a>                  lda     #$06
6d9c: 85 90                              sta     <a href="#SymanimDelay">animDelay</a>
6d9e: a9 01                              lda     #$01
6da0: 85 8c                              sta     <a href="#SymjumpFlag">jumpFlag</a>
6da2: 85 8d                              sta     <a href="#SymjumpFrame">jumpFrame</a>
6da4: 85 99                              sta     <a href="#SymrunFlag">runFlag</a>
6da6: a9 00                              lda     #$00
6da8: 85 9a                              sta     <a href="#SymcrawlFlag">crawlFlag</a>
6daa: a2 16                              ldx     #$16                    ;left crouch frame (to start the jump)
6dac: a5 95                              lda     <a href="#SymFACING">FACING</a>
6dae: 30 02                              bmi     @set_frame
6db0: a2 1a                              ldx     #$1a                    ;right crouch frame
6db2: 86 a3        @set_frame            stx     <a href="#SymanimFrame">animFrame</a>
6db4: e8                                 inx
6db5: 86 a4                              stx     <a href="#SymanimFrame_unused">animFrame_unused</a>
6db7: a2 06                              ldx     #$06
6db9: 20 03 b6                           jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>
6dbc: a2 05                              ldx     #$05
6dbe: 20 a2 71                           jsr     <a href="#Symhandle_food_rest">handle_food_rest</a>
6dc1: a2 02                              ldx     #$02
6dc3: a5 26                              lda     <a href="#SymlevelStamina">levelStamina</a>
6dc5: c9 14                              cmp     #$14
6dc7: b0 01                              bcs     @long
6dc9: ca                                 dex
6dca: 86 b4        @long                 stx     <a href="#SymlongJump">longJump</a>                ;1 if stamina level &lt; 20, 2 if &gt;= 20
6dcc: 4c c0 6c                           jmp     <a href="#Symfinish_move">finish_move</a>

                   ; Handle frame of bonking head. Bonk frames 1..8 alternate frames $1E and $20
                   ; (rubbing head). Frame 9 is a crouch (getting up). Frame 10 stands up and
                   ; finishes.
6dcf: a5 93        <a name="Symbonking">bonking</a>               lda     <a href="#SymbonkFrame">bonkFrame</a>
6dd1: c9 02                              cmp     #$02
6dd3: d0 05                              bne     @nosound
6dd5: a2 07                              ldx     #$07                    ;Play bonk sound during frame 2
6dd7: 20 03 b6                           jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>
6dda: e6 93        @nosound              inc     <a href="#SymbonkFrame">bonkFrame</a>
6ddc: a5 93                              lda     <a href="#SymbonkFrame">bonkFrame</a>
6dde: c9 0a                              cmp     #$0a                    ;in frame 10, start getting up
6de0: f0 1f                              beq     @get_up
6de2: c9 0b                              cmp     #$0b
6de4: f0 0d                              beq     @end_bonk
6de6: a5 a1                              lda     <a href="#SymbonkAlt">bonkAlt</a>                 ;alternate frames (why not just AND $93 with #$01)
6de8: 49 01                              eor     #$01
6dea: 85 a1                              sta     <a href="#SymbonkAlt">bonkAlt</a>
6dec: a8                                 tay
6ded: be 0c 6e                           ldx     <a href="#Symbonk_frame">bonk_frame</a>,y            ;frame 0 ($1e) or 1 ($20)
6df0: 4c b2 6e                           jmp     <a href="#Symset_anim_frame">set_anim_frame</a>

6df3: a9 00        @end_bonk             lda     #$00
6df5: 85 93                              sta     <a href="#SymbonkFrame">bonkFrame</a>
6df7: a9 08                              lda     #$08
6df9: 85 90                              sta     <a href="#SymanimDelay">animDelay</a>
6dfb: 20 d6 72                           jsr     <a href="#Symstop_frame_ground">stop_frame_ground</a>
6dfe: 4c 06 60                           jmp     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>

6e01: a2 16        @get_up               ldx     #$16                    ;set left or right crouch frame to arise
6e03: a5 95                              lda     <a href="#SymFACING">FACING</a>
6e05: 30 02                              bmi     @ret
6e07: a2 1a                              ldx     #$1a
6e09: 4c b2 6e     @ret                  jmp     <a href="#Symset_anim_frame">set_anim_frame</a>

6e0c: 1e           <a name="Symbonk_frame">bonk_frame</a>            .dd1    $1e                     ;alternate bonk frames
6e0d: 20                                 .dd1    $20

6e0e: a9 01        <a name="Symfell_6_or_more">fell_6_or_more</a>        lda     #$01
6e10: 85 93                              sta     <a href="#SymbonkFrame">bonkFrame</a>
6e12: a2 1e                              ldx     #$1e                    ;bonk start frame
6e14: 20 b2 6e                           jsr     <a href="#Symset_anim_frame">set_anim_frame</a>
6e17: a9 00                              lda     #$00                    ;not falling any more!
6e19: 85 92                              sta     <a href="#SymFALLCNT">FALLCNT</a>
6e1b: 85 a0                              sta     $a0
6e1d: 85 af                              sta     <a href="#SymXMOVFLG">XMOVFLG</a>
6e1f: 20 7d 71                           jsr     <a href="#Symreset_after_hurt">reset_after_hurt</a>
6e22: a9 0f                              lda     #$0f
6e24: 85 90                              sta     <a href="#SymanimDelay">animDelay</a>
6e26: a2 40                              ldx     #$40
6e28: 20 a2 71                           jsr     <a href="#Symhandle_food_rest">handle_food_rest</a>
6e2b: 4c f2 71                           jmp     <a href="#Symmaybe_tear_shuba">maybe_tear_shuba</a>        ;and return to caller

                   ; Returns bool in carry. Returns true (set) if game timer is running AND $a3 is
                   ; between $10 and $15, implying player is climbing.
6e2e: a5 87        <a name="Symis_climbing">is_climbing</a>           lda     <a href="#SymTICKING">TICKING</a>
6e30: f0 0c                              beq     @clc                    ;game paused; clear carry
6e32: a5 a3                              lda     <a href="#SymanimFrame">animFrame</a>
6e34: c9 10                              cmp     #$10
6e36: 90 06                              bcc     @clc                    ;$a3 &lt; $10 or
6e38: c9 16                              cmp     #$16                    ;$a3 &gt; $15; clear carry
6e3a: b0 02                              bcs     @clc
6e3c: 38                                 sec
6e3d: 60                                 rts

6e3e: 18           @clc                  clc
6e3f: 60                                 rts

                   ; Check if we have a shuba in inventory. Reached when the button is pressed and
                   ; we have falled 2 or more tiles.
6e40: a2 13        <a name="Symcheck_has_shuba">check_has_shuba</a>       ldx     #$13                    ;check all shuba slots
6e42: bd 58 b5     @loop                 lda     <a href="#Syminv_shuba">inv_shuba</a>,x
6e45: 2c bd 1d                           bit     <a href="#SymGAME1_BITTAB5">GAME1_BITTAB5</a>
6e48: d0 06                              bne     @has_shuba
6e4a: ca                                 dex
6e4b: 10 f5                              bpl     @loop
6e4d: 4c 0f 6c                           jmp     <a href="#Symcheck_non_door_tile">check_non_door_tile</a>     ;no shuba, return to normal processing

                   ; If we did have a shuba, stop falling (and crawling, if we crawled off a ledge)
                   ; and fly!
6e50: a9 01        @has_shuba            lda     #$01
6e52: 85 94                              sta     <a href="#SymflyFlag">flyFlag</a>                 ;whee!
6e54: 20 aa 6e                           jsr     <a href="#SymL6EAA">L6EAA</a>
6e57: a9 00                              lda     #$00
6e59: 85 92                              sta     <a href="#SymFALLCNT">FALLCNT</a>
6e5b: 85 9a                              sta     <a href="#SymcrawlFlag">crawlFlag</a>
6e5d: a9 08                              lda     #$08
6e5f: 85 90                              sta     <a href="#SymanimDelay">animDelay</a>
6e61: a2 08                              ldx     #$08
6e63: 20 03 b6                           jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>
6e66: a5 e0        <a name="Symflying">flying</a>                lda     <a href="#SymtileFeet">tileFeet</a>                ;external entry, when already flying
6e68: 20 7e 72                           jsr     <a href="#Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>
6e6b: a5 f1                              lda     <a href="#SymxSolid">xSolid</a>
6e6d: f0 11                              beq     <a href="#SymL6E80">L6E80</a>
6e6f: c6 1a                              dec     <a href="#SymplayerY">playerY</a>
6e71: a9 00        @land                 lda     #$00
6e73: 85 94                              sta     <a href="#SymflyFlag">flyFlag</a>
6e75: 20 d6 72                           jsr     <a href="#Symstop_frame_ground">stop_frame_ground</a>
6e78: a2 02                              ldx     #$02
6e7a: 20 03 b6                           jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>
6e7d: 4c c0 6c                           jmp     <a href="#Symfinish_move">finish_move</a>

6e80: a5 e3        <a name="SymL6E80">L6E80</a>                 lda     <a href="#SymtileUnder">tileUnder</a>
6e82: 20 7e 72                           jsr     <a href="#Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>
6e85: a5 f1                              lda     <a href="#SymxSolid">xSolid</a>
6e87: d0 e8                              bne     @land
                   ; We are clear of obstacles.
6e89: 20 c3 75                           jsr     <a href="#Symget_ongoing_input">get_ongoing_input</a>
6e8c: a5 85                              lda     <a href="#SymXDIR">XDIR</a>
6e8e: f0 0e                              beq     <a href="#SymL6E9E">L6E9E</a>
                   ; We pressed left or right, so if we are changing direction, face that way and
                   ; play a sound.
6e90: c5 95                              cmp     <a href="#SymFACING">FACING</a>
6e92: f0 0a                              beq     <a href="#SymL6E9E">L6E9E</a>
6e94: 85 95                              sta     <a href="#SymFACING">FACING</a>
6e96: 20 aa 6e                           jsr     <a href="#SymL6EAA">L6EAA</a>
6e99: a2 0b                              ldx     #$0b
6e9b: 20 03 b6                           jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>
6e9e: a5 95        <a name="SymL6E9E">L6E9E</a>                 lda     <a href="#SymFACING">FACING</a>
6ea0: 18                                 clc
6ea1: 65 19                              adc     <a href="#SymplayerX">playerX</a>
6ea3: 85 19                              sta     <a href="#SymplayerX">playerX</a>
6ea5: e6 1a                              inc     <a href="#SymplayerY">playerY</a>
6ea7: 4c c0 6c                           jmp     <a href="#Symfinish_move">finish_move</a>

6eaa: a2 0c        <a name="SymL6EAA">L6EAA</a>                 ldx     #$0c
6eac: a5 95                              lda     <a href="#SymFACING">FACING</a>
6eae: 30 02                              bmi     <a href="#Symset_anim_frame">set_anim_frame</a>
6eb0: a2 0e                              ldx     #$0e
6eb2: 86 a3        <a name="Symset_anim_frame">set_anim_frame</a>        stx     <a href="#SymanimFrame">animFrame</a>
6eb4: e8                                 inx
6eb5: 86 a4                              stx     <a href="#SymanimFrame_unused">animFrame_unused</a>
6eb7: a9 01                              lda     #$01
6eb9: 85 b2                              sta     <a href="#SymerasePlayer">erasePlayer</a>
6ebb: 60                                 rts

                   ; Crouch. Whether we are about to stand or about to crawl in the next frame is
                   ; encoded in crawlFlag.
6ebc: a9 01        <a name="Symcrouch">crouch</a>                lda     #$01
6ebe: 85 9b                              sta     <a href="#SymcrouchFlag">crouchFlag</a>              ;writes to $9b are contained here
6ec0: a9 05                              lda     #$05
6ec2: 85 90                              sta     <a href="#SymanimDelay">animDelay</a>
6ec4: a2 16                              ldx     #$16                    ;crouch left
6ec6: a4 95                              ldy     <a href="#SymFACING">FACING</a>
6ec8: 30 02                              bmi     @left
6eca: a2 1a                              ldx     #$1a                    ;crouch right
6ecc: 4c b2 6e     @left                 jmp     <a href="#Symset_anim_frame">set_anim_frame</a>

                   ; Called from main tick loop when crouching. Resets crouchFlag and sets the
                   ; player animation frame to stand or crawl. crawlFlag will be set along with
                   ; crouchFlag when crawling, effectively queueing a stand or crawl.
6ecf: a9 00        <a name="Symuncrouch">uncrouch</a>              lda     #$00
6ed1: 85 9b                              sta     <a href="#SymcrouchFlag">crouchFlag</a>
6ed3: 4c d6 72                           jmp     <a href="#Symstop_frame_ground">stop_frame_ground</a>

                   ********************************************************************************
                   * This appears to handle walk/run/crawl cycle. Sets the animation delay (hold  *
                   * time for current player animation frame) appropriately for the current       *
                   * action. Crawling is slow, walking is medium and running is fast. Each is 4   *
                   * frames long, with frames 0 and 2 being identical (standing still) and frames *
                   * 1 and 3 being left and right steps.                                          *
                   *                                                                              *
                   * $A3 animation frames:                                                        *
                   * Left walk animation: $00, $02, $00, $04                                      *
                   * Right walk animation: $06, $08, $06, $0A                                     *
                   * Left glide: $0C                                                              *
                   * Right glide: $0E                                                             *
                   * Climb: $10, $12                                                              *
                   * Unknown (unused?): $14                                                       *
                   * Left crouch: $16                                                             *
                   * Left jump: $18                                                               *
                   * Right crouch: $1A (between standing and crawling/bonk, or start of jump)     *
                   * Right jump: $1C                                                              *
                   * Bonk: $1E, $20, $1E, $20, $1E, $20                                           *
                   * Left crawl animation: $22, $24, $22, $26                                     *
                   * Right crawl animation: $28, $2A, $28, $2C                                    *
                   * Resting: $2E                                                                 *
                   ********************************************************************************
6ed6: a6 96        <a name="Symwalk_crawl_cycle">walk_crawl_cycle</a>      ldx     <a href="#SymtakingStep">takingStep</a>              ;0 or 1, alternating frames; basically, taking a step
6ed8: bd 3f 6f                           lda     <a href="#Symnext_step_value">next_step_value</a>,x
6edb: 85 96                              sta     <a href="#SymtakingStep">takingStep</a>
6edd: a5 9a                              lda     <a href="#SymcrawlFlag">crawlFlag</a>
6edf: f0 0b                              beq     @not_crawling
6ee1: bd 45 6f                           lda     <a href="#Symcrawling_delay">crawling_delay</a>,x        ;crawling
6ee4: 85 90                              sta     <a href="#SymanimDelay">animDelay</a>
6ee6: bd 49 6f                           lda     <a href="#Symcrawl_frames">crawl_frames</a>,x
6ee9: 4c fb 6e                           jmp     @facing

6eec: bd 41 6f     @not_crawling         lda     <a href="#Symwalking_delay">walking_delay</a>,x
6eef: a4 99                              ldy     <a href="#SymrunFlag">runFlag</a>
6ef1: f0 03                              beq     @walking
6ef3: bd 43 6f                           lda     <a href="#Symrunning_delay">running_delay</a>,x
6ef6: 85 90        @walking              sta     <a href="#SymanimDelay">animDelay</a>
6ef8: bd 47 6f                           lda     <a href="#Symwalk_frames">walk_frames</a>,x
6efb: a6 95        @facing               ldx     <a href="#SymFACING">FACING</a>
6efd: 30 03                              bmi     @left
6eff: 18                                 clc
6f00: 69 06                              adc     #$06                    ;right facing frames are left facing + 6
6f02: a6 96        @left                 ldx     <a href="#SymtakingStep">takingStep</a>
6f04: f0 03                              beq     @step
6f06: 18                                 clc
6f07: 65 97                              adc     $97                     ;should add 2 only on right step
6f09: 85 a3        @step                 sta     <a href="#SymanimFrame">animFrame</a>               ;or maybe no step
6f0b: 85 a4                              sta     <a href="#SymanimFrame_unused">animFrame_unused</a>
6f0d: e6 a4                              inc     <a href="#SymanimFrame_unused">animFrame_unused</a>        ;maintain A4=A3+1
6f0f: a5 96                              lda     <a href="#SymtakingStep">takingStep</a>
6f11: d0 26                              bne     @nostep                 ;note meaning may be reversed
6f13: 18                                 clc
6f14: a5 95                              lda     <a href="#SymFACING">FACING</a>                  ;move the player
6f16: 65 19                              adc     <a href="#SymplayerX">playerX</a>
6f18: 85 19                              sta     <a href="#SymplayerX">playerX</a>
6f1a: a5 95                              lda     <a href="#SymFACING">FACING</a>                  ;and check left/right tile at feet, depending on facing
6f1c: 10 05                              bpl     @right                  ;note this is the tile we are now directly over
6f1e: a5 e1                              lda     <a href="#SymtileFeetLeft">tileFeetLeft</a>
6f20: 4c 25 6f                           jmp     @gettile

6f23: a5 e2        @right                lda     <a href="#SymtileFeetRight">tileFeetRight</a>
6f25: 20 7e 72     @gettile              jsr     <a href="#Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>
6f28: a5 f1                              lda     <a href="#SymxSolid">xSolid</a>
6f2a: f0 02                              beq     @solid
6f2c: c6 1a                              dec     <a href="#SymplayerY">playerY</a>                 ;tile was not solid, so fall through one tile
6f2e: a2 02        @solid                ldx     #$02                    ;footstep sound 1
6f30: a5 97                              lda     $97
6f32: d0 02                              bne     @sound
6f34: a2 03                              ldx     #$03                    ;footstep sound 2
6f36: 20 03 b6     @sound                jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>
6f39: 20 d1 71     @nostep               jsr     <a href="#Symcheck_cave_door">check_cave_door</a>?
6f3c: 4c c0 6c                           jmp     <a href="#Symfinish_move">finish_move</a>

6f3f: 01           <a name="Symnext_step_value">next_step_value</a>       .dd1    $01
6f40: 00                                 .dd1    $00
6f41: 06           <a name="Symwalking_delay">walking_delay</a>         .dd1    $06
6f42: 04                                 .dd1    $04
6f43: 03           <a name="Symrunning_delay">running_delay</a>         .dd1    $03                     ;not crawling nor walking, unsure
6f44: 02                                 .dd1    $02
6f45: 08           <a name="Symcrawling_delay">crawling_delay</a>        .dd1    $08
6f46: 08                                 .dd1    $08
6f47: 02           <a name="Symwalk_frames">walk_frames</a>           .dd1    $02
6f48: 00                                 .dd1    $00
6f49: 24           <a name="Symcrawl_frames">crawl_frames</a>          .dd1    $24
6f4a: 22                                 .dd1    $22

6f4b: a9 00        <a name="SymL6F4B">L6F4B</a>                 lda     #$00
6f4d: 85 99                              sta     <a href="#SymrunFlag">runFlag</a>
6f4f: 85 9a                              sta     <a href="#SymcrawlFlag">crawlFlag</a>
6f51: a5 1a                              lda     <a href="#SymplayerY">playerY</a>
6f53: 30 4f                              bmi     <a href="#SymL6FA4">L6FA4</a>
6f55: f0 30                              beq     <a href="#SymL6F87">L6F87</a>
6f57: c9 13                              cmp     #$13
6f59: f0 49                              beq     <a href="#SymL6FA4">L6FA4</a>
6f5b: a5 e6                              lda     <a href="#SymtileKnee">tileKnee</a>
6f5d: a6 86                              ldx     <a href="#SymYDIR">YDIR</a>
6f5f: 30 02                              bmi     <a href="#SymL6F63">L6F63</a>
6f61: a5 e3                              lda     <a href="#SymtileUnder">tileUnder</a>
6f63: 20 7e 72     <a name="SymL6F63">L6F63</a>                 jsr     <a href="#Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>
6f66: a5 f2                              lda     <a href="#Symclimbable">climbable</a>
6f68: d0 06                              bne     <a href="#SymL6F70">L6F70</a>
6f6a: 20 bc 6e                           jsr     <a href="#Symcrouch">crouch</a>
6f6d: 4c c0 6c                           jmp     <a href="#Symfinish_move">finish_move</a>

6f70: a5 e7        <a name="SymL6F70">L6F70</a>                 lda     <a href="#SymtileArm">tileArm</a>
6f72: a6 86                              ldx     <a href="#SymYDIR">YDIR</a>
6f74: 30 02                              bmi     <a href="#SymL6F78">L6F78</a>
6f76: a5 e0                              lda     <a href="#SymtileFeet">tileFeet</a>
6f78: 20 7e 72     <a name="SymL6F78">L6F78</a>                 jsr     <a href="#Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>
6f7b: a5 f2                              lda     <a href="#Symclimbable">climbable</a>
6f7d: d0 08                              bne     <a href="#SymL6F87">L6F87</a>
6f7f: a2 14                              ldx     #$14
6f81: 20 b2 6e                           jsr     <a href="#Symset_anim_frame">set_anim_frame</a>
6f84: 4c c0 6c                           jmp     <a href="#Symfinish_move">finish_move</a>

6f87: a5 98        <a name="SymL6F87">L6F87</a>                 lda     $98
6f89: 49 01                              eor     #$01
6f8b: 85 98                              sta     $98
6f8d: a8                                 tay
6f8e: be a7 6f                           ldx     <a href="#SymL6FA7">L6FA7</a>,y
6f91: 20 b2 6e                           jsr     <a href="#Symset_anim_frame">set_anim_frame</a>
6f94: a2 04                              ldx     #$04
6f96: a5 86                              lda     <a href="#SymYDIR">YDIR</a>
6f98: 30 02                              bmi     <a href="#SymL6F9C">L6F9C</a>
6f9a: a2 05                              ldx     #$05
6f9c: 20 03 b6     <a name="SymL6F9C">L6F9C</a>                 jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>
6f9f: a2 01                              ldx     #$01
6fa1: 20 a2 71                           jsr     <a href="#Symhandle_food_rest">handle_food_rest</a>
6fa4: 4c c0 6c     <a name="SymL6FA4">L6FA4</a>                 jmp     <a href="#Symfinish_move">finish_move</a>

6fa7: 10           <a name="SymL6FA7">L6FA7</a>                 .dd1    $10
6fa8: 12                                 .dd1    $12

6fa9: a5 6b        <a name="Symhandle_npc">handle_npc?</a>           lda     <a href="#Symzp6b_npcHere">zp6b_npcHere</a>
6fab: d0 01                              bne     <a href="#SymL6FAE">L6FAE</a>
6fad: 60                                 rts

6fae: e6 53        <a name="SymL6FAE">L6FAE</a>                 inc     $53
6fb0: a5 53                              lda     $53
6fb2: c5 54                              cmp     $54
6fb4: f0 01                              beq     <a href="#SymL6FB7">L6FB7</a>
6fb6: 60                                 rts

6fb7: a9 00        <a name="SymL6FB7">L6FB7</a>                 lda     #$00
6fb9: 85 53                              sta     $53
6fbb: a5 6c                              lda     <a href="#SymnpcX">npcX</a>
6fbd: 18                                 clc
6fbe: 65 6f                              adc     <a href="#SymnpcFacing">npcFacing</a>
6fc0: aa                                 tax
6fc1: a4 6d                              ldy     <a href="#SymnpcY">npcY</a>
6fc3: 20 60 72                           jsr     <a href="#Symget_tile_at_xy">get_tile_at_xy</a>
6fc6: 85 a7                              sta     $a7
6fc8: a6 6c                              ldx     <a href="#SymnpcX">npcX</a>
6fca: a4 6d                              ldy     <a href="#SymnpcY">npcY</a>
6fcc: c8                                 iny
6fcd: 20 60 72                           jsr     <a href="#Symget_tile_at_xy">get_tile_at_xy</a>
6fd0: 85 a8                              sta     $a8
6fd2: a5 50                              lda     $50
6fd4: f0 03                              beq     <a href="#SymL6FD9">L6FD9</a>
6fd6: 4c 9f 70                           jmp     <a href="#SymL709F">L709F</a>

6fd9: a5 a8        <a name="SymL6FD9">L6FD9</a>                 lda     $a8
6fdb: 20 7e 72                           jsr     <a href="#Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>
6fde: a5 f0                              lda     <a href="#SymySolid">ySolid</a>
6fe0: d0 0b                              bne     <a href="#SymL6FED">L6FED</a>
6fe2: e6 6d                              inc     <a href="#SymnpcY">npcY</a>
6fe4: a9 04                              lda     #$04
6fe6: 85 54                              sta     $54
6fe8: a9 01                              lda     #$01
6fea: 85 b3                              sta     $b3
6fec: 60                                 rts

6fed: a5 6a        <a name="SymL6FED">L6FED</a>                 lda     $6a
6fef: c9 08                              cmp     #$08
6ff1: f0 32                              beq     <a href="#SymL7025">L7025</a>
6ff3: c9 09                              cmp     #$09
6ff5: f0 2e                              beq     <a href="#SymL7025">L7025</a>
6ff7: ad f2 02                           lda     <a href="#SymRWTSBUF_npctype">RWTSBUF_npctype</a>
6ffa: 29 f0                              and     #$f0
6ffc: c9 e0                              cmp     #$e0
6ffe: d0 03                              bne     <a href="#SymL7003">L7003</a>
7000: 4c f5 70                           jmp     <a href="#SymL70F5">L70F5</a>

7003: a5 6c        <a name="SymL7003">L7003</a>                 lda     <a href="#SymnpcX">npcX</a>
7005: 18                                 clc
7006: 65 6f                              adc     <a href="#SymnpcFacing">npcFacing</a>
7008: c5 19                              cmp     <a href="#SymplayerX">playerX</a>
700a: f0 07                              beq     <a href="#SymL7013">L7013</a>
700c: 18                                 clc
700d: 65 6f                              adc     <a href="#SymnpcFacing">npcFacing</a>
700f: c5 19                              cmp     <a href="#SymplayerX">playerX</a>
7011: d0 39                              bne     <a href="#SymL704C">L704C</a>
7013: a6 6d        <a name="SymL7013">L7013</a>                 ldx     <a href="#SymnpcY">npcY</a>
7015: e4 1a                              cpx     <a href="#SymplayerY">playerY</a>
7017: f0 0b                              beq     <a href="#SymL7024">L7024</a>
7019: e8                                 inx
701a: e4 1a                              cpx     <a href="#SymplayerY">playerY</a>
701c: f0 06                              beq     <a href="#SymL7024">L7024</a>
701e: ca                                 dex
701f: ca                                 dex
7020: e4 1a                              cpx     <a href="#SymplayerY">playerY</a>
7022: d0 28                              bne     <a href="#SymL704C">L704C</a>
7024: 60           <a name="SymL7024">L7024</a>                 rts

7025: a5 93        <a name="SymL7025">L7025</a>                 lda     <a href="#SymbonkFrame">bonkFrame</a>
7027: d0 23                              bne     <a href="#SymL704C">L704C</a>
7029: a6 6d                              ldx     <a href="#SymnpcY">npcY</a>
702b: e4 1a                              cpx     <a href="#SymplayerY">playerY</a>
702d: f0 05                              beq     <a href="#SymL7034">L7034</a>
702f: ca                                 dex
7030: e4 1a                              cpx     <a href="#SymplayerY">playerY</a>
7032: d0 18                              bne     <a href="#SymL704C">L704C</a>
7034: a5 6c        <a name="SymL7034">L7034</a>                 lda     <a href="#SymnpcX">npcX</a>
7036: c5 19                              cmp     <a href="#SymplayerX">playerX</a>
7038: f0 0e                              beq     <a href="#SymL7048">L7048</a>
703a: 18                                 clc
703b: 65 6f                              adc     <a href="#SymnpcFacing">npcFacing</a>
703d: c5 19                              cmp     <a href="#SymplayerX">playerX</a>
703f: f0 07                              beq     <a href="#SymL7048">L7048</a>
7041: 18                                 clc
7042: 65 6f                              adc     <a href="#SymnpcFacing">npcFacing</a>
7044: c5 19                              cmp     <a href="#SymplayerX">playerX</a>
7046: d0 04                              bne     <a href="#SymL704C">L704C</a>
                   <span style="background-color: #cbcb00">NOTE: Setting fallcnt to $0A is observed to happen when you bump your head.</span>
7048: a9 0a        <a name="SymL7048">L7048</a>                 lda     #$0a
704a: 85 92                              sta     <a href="#SymFALLCNT">FALLCNT</a>
704c: a5 52        <a name="SymL704C">L704C</a>                 lda     $52
704e: d0 28                              bne     <a href="#SymL7078">L7078</a>
7050: a5 6c                              lda     <a href="#SymnpcX">npcX</a>
7052: cd e6 02                           cmp     <a href="#SymRWTSBUF">RWTSBUF</a>+230
7055: f0 05                              beq     <a href="#SymL705C">L705C</a>
7057: cd e7 02                           cmp     <a href="#SymRWTSBUF">RWTSBUF</a>+231
705a: d0 1c                              bne     <a href="#SymL7078">L7078</a>
705c: a9 00        <a name="SymL705C">L705C</a>                 lda     #$00
705e: 38                                 sec
705f: e5 6f                              sbc     <a href="#SymnpcFacing">npcFacing</a>
7061: 85 6f                              sta     <a href="#SymnpcFacing">npcFacing</a>
7063: 20 62 75                           jsr     <a href="#SymL7562">L7562</a>
7066: a9 01                              lda     #$01
7068: 85 b3                              sta     $b3
706a: a6 6e                              ldx     <a href="#Symzp6e">zp6e</a>
706c: bd 76 70                           lda     <a href="#SymL7076">L7076</a>,x
706f: 85 54                              sta     $54
7071: a9 01                              lda     #$01
7073: 85 52                              sta     $52
7075: 60                                 rts

7076: 0c           <a name="SymL7076">L7076</a>                 .dd1    $0c
7077: 08                                 .dd1    $08

7078: 20 21 60     <a name="SymL7078">L7078</a>                 jsr     <a href="#SymGAME2_read_0900">GAME2_read_0900</a>
707b: 29 07                              and     #$07                    ;check lower 3 bits
707d: d0 12                              bne     <a href="#SymL7091">L7091</a>
707f: a6 6a                              ldx     $6a
7081: e0 08                              cpx     #$08
7083: f0 0b                              beq     @rts
7085: e0 09                              cpx     #$09
7087: f0 07                              beq     @rts
7089: 20 21 60                           jsr     <a href="#SymGAME2_read_0900">GAME2_read_0900</a>
708c: 29 7f                              and     #$7f
708e: 85 54                              sta     $54
7090: 60           @rts                  rts

7091: a5 52        <a name="SymL7091">L7091</a>                 lda     $52
7093: d0 0a                              bne     <a href="#SymL709F">L709F</a>
7095: 20 21 60                           jsr     <a href="#SymGAME2_read_0900">GAME2_read_0900</a>
7098: 29 0f                              and     #$0f
709a: d0 03                              bne     <a href="#SymL709F">L709F</a>
709c: 4c 5c 70                           jmp     <a href="#SymL705C">L705C</a>

709f: a9 00        <a name="SymL709F">L709F</a>                 lda     #$00
70a1: 85 52                              sta     $52
70a3: a5 50                              lda     $50
70a5: 49 01                              eor     #$01
70a7: 85 50                              sta     $50
70a9: a8                                 tay
70aa: b9 ef 70                           lda     <a href="#SymL70EF">L70EF</a>,y
70ad: a6 6e                              ldx     <a href="#Symzp6e">zp6e</a>
70af: f0 03                              beq     <a href="#SymL70B4">L70B4</a>
70b1: b9 f1 70                           lda     <a href="#SymL70F1">L70F1</a>,y
70b4: 85 54        <a name="SymL70B4">L70B4</a>                 sta     $54
70b6: b9 f3 70                           lda     <a href="#SymL70F3">L70F3</a>,y
70b9: a6 6f                              ldx     <a href="#SymnpcFacing">npcFacing</a>
70bb: 30 03                              bmi     <a href="#SymL70C0">L70C0</a>
70bd: 18                                 clc
70be: 69 06                              adc     #$06
70c0: a6 50        <a name="SymL70C0">L70C0</a>                 ldx     $50
70c2: f0 0c                              beq     <a href="#SymL70D0">L70D0</a>
70c4: 18                                 clc
70c5: 65 97                              adc     $97
70c7: 48                                 pha
70c8: a9 02                              lda     #$02
70ca: 38                                 sec
70cb: e5 51                              sbc     $51
70cd: 85 51                              sta     $51
70cf: 68                                 pla
70d0: aa           <a name="SymL70D0">L70D0</a>                 tax
70d1: 20 6d 75                           jsr     <a href="#SymL756D">L756D</a>
70d4: a5 50                              lda     $50
70d6: d0 12                              bne     <a href="#SymL70EA">L70EA</a>
70d8: 18                                 clc
70d9: a5 6c                              lda     <a href="#SymnpcX">npcX</a>
70db: 65 6f                              adc     <a href="#SymnpcFacing">npcFacing</a>               ;move one tile in direction they are facing
70dd: 85 6c                              sta     <a href="#SymnpcX">npcX</a>
70df: a5 a7                              lda     $a7
70e1: 20 7e 72                           jsr     <a href="#Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>
70e4: a5 f1                              lda     <a href="#SymxSolid">xSolid</a>
70e6: f0 02                              beq     <a href="#SymL70EA">L70EA</a>
70e8: c6 6d                              dec     <a href="#SymnpcY">npcY</a>
70ea: a9 01        <a name="SymL70EA">L70EA</a>                 lda     #$01
70ec: 85 b3                              sta     $b3
70ee: 60                                 rts

70ef: 08           <a name="SymL70EF">L70EF</a>                 .dd1    $08
70f0: 0c                                 .dd1    $0c
70f1: 06           <a name="SymL70F1">L70F1</a>                 .dd1    $06
70f2: 0a                                 .dd1    $0a
70f3: 00           <a name="SymL70F3">L70F3</a>                 .dd1    $00
70f4: 02                                 .dd1    $02

                   <span style="background-color: #cbcb00">NOTE: Might control NPC behavior (stopping) near player.</span>
70f5: a6 6c        <a name="SymL70F5">L70F5</a>                 ldx     <a href="#SymnpcX">npcX</a>
70f7: e4 19                              cpx     <a href="#SymplayerX">playerX</a>
70f9: f0 10                              beq     <a href="#SymL710B">L710B</a>
70fb: e8                                 inx
70fc: e4 19                              cpx     <a href="#SymplayerX">playerX</a>
70fe: f0 0b                              beq     <a href="#SymL710B">L710B</a>
7100: ca                                 dex
7101: ca                                 dex
7102: e4 19                              cpx     <a href="#SymplayerX">playerX</a>
7104: f0 05                              beq     <a href="#SymL710B">L710B</a>
7106: ca                                 dex
7107: e4 19                              cpx     <a href="#SymplayerX">playerX</a>
7109: d0 1a                              bne     <a href="#SymL7125">L7125</a>
710b: a6 6d        <a name="SymL710B">L710B</a>                 ldx     <a href="#SymnpcY">npcY</a>
710d: e4 1a                              cpx     <a href="#SymplayerY">playerY</a>
710f: f0 0b                              beq     <a href="#SymL711C">L711C</a>
7111: e8                                 inx
7112: e4 1a                              cpx     <a href="#SymplayerY">playerY</a>
7114: f0 06                              beq     <a href="#SymL711C">L711C</a>
7116: ca                                 dex
7117: ca                                 dex
7118: e4 1a                              cpx     <a href="#SymplayerY">playerY</a>
711a: d0 09                              bne     <a href="#SymL7125">L7125</a>
711c: ad f2 02     <a name="SymL711C">L711C</a>                 lda     <a href="#SymRWTSBUF_npctype">RWTSBUF_npctype</a>
711f: 85 34                              sta     <a href="#Symtemp34_npctype">temp34_npctype</a>
7121: a9 00                              lda     #$00
7123: 85 87                              sta     <a href="#SymTICKING">TICKING</a>
7125: 4c 4c 70     <a name="SymL7125">L7125</a>                 jmp     <a href="#SymL704C">L704C</a>

                   ; Checks and handles collision with brambles at foot level. Ignored when flying.
7128: 20 2a 72     <a name="Symcheck_brambles">check_brambles</a>        jsr     <a href="#Symget_adjacent_tiles">get_adjacent_tiles</a>
712b: a5 e0                              lda     <a href="#SymtileFeet">tileFeet</a>
712d: c9 1c                              cmp     #<a href="#Symtile_brambles">tile_brambles</a>
712f: f0 01                              beq     @check_brambles
7131: 60           @rts                  rts

7132: a5 92        @check_brambles       lda     <a href="#SymFALLCNT">FALLCNT</a>
7134: c9 02                              cmp     #$02
7136: b0 f9                              bcs     @rts
7138: a5 94                              lda     <a href="#SymflyFlag">flyFlag</a>                 ;ignore brambles if flying. only contact on ground
713a: d0 f5                              bne     @rts
713c: a5 9c                              lda     <a href="#SymplayerXold">playerXold</a>
713e: 85 19                              sta     <a href="#SymplayerX">playerX</a>
7140: a5 9d                              lda     <a href="#SymplayerYold">playerYold</a>
7142: 85 1a                              sta     <a href="#SymplayerY">playerY</a>
7144: 20 7d 71                           jsr     <a href="#Symreset_after_hurt">reset_after_hurt</a>
7147: 4c 72 71                           jmp     @ouch

                   ; Checks and handles collision with wall tiles (locked gate, house wall) at foot
                   ; and shoulder level.
714a: a5 e0        <a name="Symcheck_walls">check_walls</a>           lda     <a href="#SymtileFeet">tileFeet</a>
714c: 20 8a 71                           jsr     @is_collision_tile
714f: f0 0c                              beq     @collide
7151: a5 9a                              lda     <a href="#SymcrawlFlag">crawlFlag</a>
7153: f0 01                              beq     @chk_collide_shoulder   ;if crawling, don't test collision at shoulder height
7155: 60           @rts                  rts

7156: a5 e8        @chk_collide_shoulder lda     <a href="#SymtileShoulder">tileShoulder</a>
7158: 20 8a 71                           jsr     @is_collision_tile
715b: d0 f8                              bne     @rts
715d: a5 9c        @collide              lda     <a href="#SymplayerXold">playerXold</a>
715f: 85 19                              sta     <a href="#SymplayerX">playerX</a>
7161: a5 9d                              lda     <a href="#SymplayerYold">playerYold</a>
7163: 85 1a                              sta     <a href="#SymplayerY">playerY</a>
7165: a9 00                              lda     #$00
7167: 85 8c                              sta     <a href="#SymjumpFlag">jumpFlag</a>
7169: 85 94                              sta     <a href="#SymflyFlag">flyFlag</a>
716b: 20 d6 72                           jsr     <a href="#Symstop_frame_ground">stop_frame_ground</a>
716e: a9 01                              lda     #$01
7170: 85 a0                              sta     $a0
7172: a9 0a        @ouch                 lda     #$0a                    ;full stop, max fall, get hurt
7174: 85 92                              sta     <a href="#SymFALLCNT">FALLCNT</a>
7176: a9 00                              lda     #$00
7178: 85 af                              sta     <a href="#SymXMOVFLG">XMOVFLG</a>
717a: 85 b0                              sta     <a href="#SymYMOVFLG">YMOVFLG</a>
717c: 60                                 rts

717d: a9 00        <a name="Symreset_after_hurt">reset_after_hurt</a>      lda     #$00
717f: 85 8c                              sta     <a href="#SymjumpFlag">jumpFlag</a>
7181: 85 94                              sta     <a href="#SymflyFlag">flyFlag</a>
7183: 85 96                              sta     <a href="#SymtakingStep">takingStep</a>
7185: 85 99                              sta     <a href="#SymrunFlag">runFlag</a>
7187: 85 9a                              sta     <a href="#SymcrawlFlag">crawlFlag</a>
7189: 60                                 rts

                   ; Sets Z flag if tile in A is $07,$08 or $52. These are tiles that cause you to
                   ; get hurt when you contact them.
718a: c9 07        @is_collision_tile    cmp     #$07                    ;unknown; probably a wall
718c: f0 08                              beq     @rts
718e: c9 08                              cmp     #$08                    ;a locked gate (Temple Grund entrance)
7190: f0 04                              beq     @rts                    ;   or impassable wall (hostage house)
7192: c9 52                              cmp     #$52                    ;a checkerboard pattern (internal house wall)
7194: f0 00                              beq     @rts
7196: 60           @rts                  rts

                   ; Translate BA..BC (the 3 door tiles, in A) to a door slot number (1..3) and
                   ; store it in doorTransit.
7197: 38           <a name="Symhandle_door">handle_door</a>           sec                             ;A is BA..BC on entry (the door tile)
7198: e9 b9                              sbc     #$b9                    ;subtract B9
719a: 85 9e                              sta     <a href="#SymdoorTransit">doorTransit</a>             ;result is 1..3
719c: a9 00                              lda     #$00                    ;pause during transit
719e: 85 87                              sta     <a href="#SymTICKING">TICKING</a>
71a0: a2 0a                              ldx     #$0a                    ;use 10 food during a door transit
                   ; (Multiple entry.) X is the amount to decrease food/rest by ($0A, $01, ...).
                   ; Subtract this from the food/rest timer, unless we are in the Neshom realm,
                   ; where time does not pass.
                   ; 
                   ; If the food/rest timer falls below zero, decrease food and rest by 1 each. The
                   ; timer ranges from 00..FF so no post-adjustment is needed.
71a2: a5 35        <a name="Symhandle_food_rest">handle_food_rest</a>      lda     <a href="#SymdoorNeshom">doorNeshom</a>              ;in neshom's house or realm?
71a4: d0 2a                              bne     @rts                    ;yep, return; never starve
71a6: 86 b7                              stx     <a href="#SymtempB7">tempB7</a>                  ;temp used only for subtracting X from A
71a8: a5 b8                              lda     <a href="#SymfoodRestTimer">foodRestTimer</a>
71aa: 38                                 sec
71ab: e5 b7                              sbc     <a href="#SymtempB7">tempB7</a>
71ad: 85 b8                              sta     <a href="#SymfoodRestTimer">foodRestTimer</a>
71af: 90 01                              bcc     @dec_food
71b1: 60                                 rts

71b2: c6 24        @dec_food             dec     <a href="#SymlevelFood">levelFood</a>
71b4: 10 0c                              bpl     @dec_rest
71b6: e6 24                              inc     <a href="#SymlevelFood">levelFood</a>
71b8: e6 24                              inc     <a href="#SymlevelFood">levelFood</a>
71ba: a9 01                              lda     #<a href="#SymSTARVED_food">STARVED_food</a>           ;starved of food
71bc: 85 3c                              sta     <a href="#SymSTARVED">STARVED</a>
71be: a9 00                              lda     #$00                    ;pause
71c0: 85 87                              sta     <a href="#SymTICKING">TICKING</a>
71c2: c6 25        @dec_rest             dec     <a href="#SymlevelRest">levelRest</a>
71c4: 10 0a                              bpl     @rts
71c6: e6 25                              inc     <a href="#SymlevelRest">levelRest</a>
71c8: a9 02                              lda     #<a href="#SymSTARVED_rest">STARVED_rest</a>           ;starved of rest
71ca: 85 3c                              sta     <a href="#SymSTARVED">STARVED</a>
71cc: a9 00                              lda     #$00                    ;pause
71ce: 85 87                              sta     <a href="#SymTICKING">TICKING</a>
71d0: 60           @rts                  rts

                   <span style="background-color: #cbcb00">NOTE: Suspect this is checking if we are in front of a certain type of door in</span>
                   <span style="background-color: #cbcb00">the caves, and if so, sets the flag for the spirit bell to ring.</span>
71d1: a5 e0        <a name="Symcheck_cave_door">check_cave_door?</a>      lda     <a href="#SymtileFeet">tileFeet</a>
71d3: c9 bb                              cmp     #$bb                    ;a door tile
71d5: d0 1a                              bne     @rts
71d7: a5 1c                              lda     <a href="#SymMAPHALF">MAPHALF</a>
71d9: f0 16                              beq     @rts
71db: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>
71dd: c9 80                              cmp     #$80
71df: 90 10                              bcc     @rts
71e1: ad 00 b5                           lda     <a href="#SymitemState">itemState</a>               ;might be checking spirit bell in inventory
71e4: 2c bd 1d                           bit     <a href="#SymGAME1_BITTAB5">GAME1_BITTAB5</a>
71e7: f0 08                              beq     @rts
71e9: a9 00                              lda     #$00
71eb: 85 87                              sta     <a href="#SymTICKING">TICKING</a>
71ed: a9 01                              lda     #$01
71ef: 85 bc                              sta     <a href="#SymzpBC_bellrings">zpBC_bellrings</a>          ;spirit bell rings?
71f1: 60           @rts                  rts

71f2: 20 21 60     <a name="Symmaybe_tear_shuba">maybe_tear_shuba</a>      jsr     <a href="#SymGAME2_read_0900">GAME2_read_0900</a>         ;pseudo-randomness?
71f5: c9 f0                              cmp     #$f0                    ;essentially, a 1 in 16 chance to tear
71f7: 90 0d                              bcc     @rts
71f9: a2 13                              ldx     #19                     ;20 shuba inventory slots
71fb: bd 58 b5     @loop                 lda     <a href="#Syminv_shuba">inv_shuba</a>,x
71fe: 2c bd 1d                           bit     <a href="#SymGAME1_BITTAB5">GAME1_BITTAB5</a>           ;check if slot is occupied by a shuba
7201: d0 04                              bne     @shuba_has_torn
7203: ca                                 dex
7204: 10 f5                              bpl     @loop
7206: 60           @rts                  rts

7207: a9 00        @shuba_has_torn       lda     #$00                    ;clear inventory slot
7209: 9d 58 b5                           sta     <a href="#Syminv_shuba">inv_shuba</a>,x
720c: a0 07                              ldy     #$07
720e: 20 12 77                           jsr     <a href="#SymGAME2_lose_weight">GAME2_lose_weight</a>
7211: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7214: 01                                 .dd1    $01
7215: d9 cf d5 d2+                       .str    YOUR SHUBA HAS TORN  ;ow
7228: ff                                 .dd1    $ff
7229: 60                                 rts

                   ; Populates $E0..EA with tiles near the player's feet. See notes at @xoffset.
722a: a9 0a        <a name="Symget_adjacent_tiles">get_adjacent_tiles</a>    lda     #$0a
722c: 85 82                              sta     <a href="#Symtemp82">temp82</a>
722e: a6 82        @loop                 ldx     <a href="#Symtemp82">temp82</a>
7230: a5 1a                              lda     <a href="#SymplayerY">playerY</a>
7232: 18                                 clc
7233: 7d 55 72                           adc     @yoffset,x
7236: a8                                 tay
7237: a5 19                              lda     <a href="#SymplayerX">playerX</a>
7239: 18                                 clc
723a: 7d 4a 72                           adc     @xoffset,x
723d: aa                                 tax
723e: 20 60 72                           jsr     <a href="#Symget_tile_at_xy">get_tile_at_xy</a>
7241: a6 82                              ldx     <a href="#Symtemp82">temp82</a>
7243: 95 e0                              sta     <a href="#SymtileFeet">tileFeet</a>,x
7245: c6 82                              dec     <a href="#Symtemp82">temp82</a>
7247: 10 e5                              bpl     @loop                   ;loop 11 times
7249: 60                                 rts

                   ; the 3 tiles at the player's feet (center, left, right)
724a: 00           @xoffset              .dd1    $00                     ;E0:  0, 0
724b: ff                                 .dd1    $ff                     ;E1: -1, 0
724c: 01                                 .dd1    $01                     ;E2:  1, 0
                   ; the 3 tiles under the player (center, left, right)
724d: 00                                 .dd1    $00                     ;E3:  0, 1
724e: ff                                 .dd1    $ff                     ;E4: -1, 1
724f: 01                                 .dd1    $01                     ;E5:  1, 1
                   ; the 3 tiles at knee (-1), arm (-2) and shoulder (-3) height
7250: 00                                 .dd1    $00                     ;E6:  0,-1
7251: 00                                 .dd1    $00                     ;E7:  0,-2
7252: 00                                 .dd1    $00                     ;E8:  0,-3
                   ; the 2 tiles (left, right) at -2 (arm level), which is the height of items on
                   ; tables and shelves for taking
7253: ff                                 .dd1    $ff                     ;E9: -1,-2
7254: 01                                 .dd1    $01                     ;EA:  1,-2
7255: 00           @yoffset              .dd1    $00
7256: 00                                 .dd1    $00
7257: 00                                 .dd1    $00
7258: 01                                 .dd1    $01
7259: 01                                 .dd1    $01
725a: 01                                 .dd1    $01
725b: ff                                 .dd1    $ff
725c: fe                                 .dd1    $fe
725d: fd                                 .dd1    $fd
725e: fe                                 .dd1    $fe
725f: fe                                 .dd1    $fe

                   ; Input: X=col, Y=line. Output: A=tile at X,Y. A=0 if X=-1, X=40, or Y&lt;0.
7260: e0 ff        <a name="Symget_tile_at_xy">get_tile_at_xy</a>        cpx     #$ff
7262: f0 17                              beq     @tile0
7264: e0 28                              cpx     #$28
7266: f0 13                              beq     @tile0
7268: c0 00                              cpy     #$00
726a: 30 0f                              bmi     @tile0
726c: b9 a0 1d                           lda     <a href="#SymGAME1_textlo">GAME1_textlo</a>,y
726f: 85 89                              sta     <a href="#Symtemp89">temp89</a>                  ;$89 {addr/2} is temp
7271: b9 80 1d                           lda     <a href="#SymGAME1_texthi">GAME1_texthi</a>,y
7274: 85 8a                              sta     <a href="#Symtemp89">temp89</a>+1
7276: 8a                                 txa
7277: a8                                 tay
7278: b1 89                              lda     (<a href="#Symtemp89">temp89</a>),y
727a: 60                                 rts

727b: a9 00        @tile0                lda     #$00
727d: 60                                 rts

                   ; Maps a tile in A to 3 output values in $F0, $F1, $F2.
                   ; 
                   ; On return ($F0,$F1,$F2) is (0,0,0) for all A except:
                   ;   (1,1,0) when A = 01..06, 19..1b (bush), 75, df
                   ;   (1,0,1) when A = b4..b6 (ladder) and b7..b9 (vine)
                   ;   (1,1,0) when A = e0 and $9A != 0
                   ; 
                   ; It's likely these denote permeability in different directions, with $F2=1 as
                   ; climbable. The (1,1,0) tiles appear to be solid.
727e: 48           <a name="Symtile_to_f0_f1_f2">tile_to_f0_f1_f2</a>      pha
727f: a2 02                              ldx     #$02                    ;Store 0 in $F0..$F2
7281: a9 00                              lda     #$00
7283: 95 f0        @loop                 sta     <a href="#SymySolid">ySolid</a>,x
7285: ca                                 dex
7286: 10 fb                              bpl     @loop
7288: 68                                 pla
7289: c9 00                              cmp     #$00                    ;(0,0,0) -- $00
728b: f0 48                              beq     @rts
728d: c9 07                              cmp     #$07
728f: b0 06                              bcs     @p1
7291: e6 f0                              inc     <a href="#SymySolid">ySolid</a>                  ;(1,1,0) -- $01..06
7293: e6 f1                              inc     <a href="#SymxSolid">xSolid</a>
7295: d0 3e                              bne     @rts
7297: c9 19        @p1                   cmp     #$19                    ;(0,0,0) -- $07..18
7299: 90 3a                              bcc     @rts
729b: c9 1c                              cmp     #$1c
729d: b0 06                              bcs     @p2
729f: e6 f0                              inc     <a href="#SymySolid">ySolid</a>                  ;(1,1,0) -- $19..1b
72a1: e6 f1                              inc     <a href="#SymxSolid">xSolid</a>
72a3: d0 30                              bne     @rts                    ;always
72a5: c9 75        @p2                   cmp     #$75
72a7: d0 06                              bne     @p3
72a9: e6 f0                              inc     <a href="#SymySolid">ySolid</a>                  ;(1,1,0) -- $75
72ab: e6 f1                              inc     <a href="#SymxSolid">xSolid</a>
72ad: d0 26                              bne     @rts
72af: c9 b4        @p3                   cmp     #$b4
72b1: 90 22                              bcc     @rts                    ;(0,0,0) -- $1c..74,76..b3
72b3: c9 ba                              cmp     #$ba
72b5: b0 06                              bcs     @p4
72b7: e6 f0                              inc     <a href="#SymySolid">ySolid</a>                  ;(1,0,1) -- $b4..b9
72b9: e6 f2                              inc     <a href="#Symclimbable">climbable</a>
72bb: d0 18                              bne     @rts
72bd: c9 e0        @p4                   cmp     #$e0
72bf: d0 0a                              bne     @p5
72c1: a5 9a                              lda     <a href="#SymcrawlFlag">crawlFlag</a>
72c3: f0 10                              beq     @rts                    ;(0,0,0) -- $e0 (when $9a == 0)
72c5: e6 f0                              inc     <a href="#SymySolid">ySolid</a>                  ;(1,1,0) -- $e0 (when $9a == 1)
72c7: e6 f1                              inc     <a href="#SymxSolid">xSolid</a>
72c9: d0 0a                              bne     @rts
72cb: c9 df        @p5                   cmp     #$df
72cd: d0 06                              bne     @rts                    ;(0,0,0) -- $ba..$de,$e1..$ff
72cf: e6 f0                              inc     <a href="#SymySolid">ySolid</a>                  ;(1,1,0) -- $df
72d1: e6 f1                              inc     <a href="#SymxSolid">xSolid</a>
72d3: d0 00                              bne     @rts
72d5: 60           @rts                  rts

                   ; Sets animation frame to $00/$06 (crawling) or $22/$28 (standing), depending on
                   ; facing direction. Often called in tandem with FACING being updated.
                   ; Essentially, the initial animation frame when you are stopped on the ground.
72d6: a5 9a        <a name="Symstop_frame_ground">stop_frame_ground</a>     lda     <a href="#SymcrawlFlag">crawlFlag</a>
72d8: d0 0a                              bne     @crawling
72da: a2 00                              ldx     #$00
72dc: a5 95                              lda     <a href="#SymFACING">FACING</a>
72de: 30 0c                              bmi     @cont
72e0: a2 06                              ldx     #$06
72e2: d0 08                              bne     @cont                   ;always

72e4: a2 22        @crawling             ldx     #$22
72e6: a5 95                              lda     <a href="#SymFACING">FACING</a>
72e8: 30 02                              bmi     @cont                   ;if facing left
72ea: a2 28                              ldx     #$28
72ec: 86 a3        @cont                 stx     <a href="#SymanimFrame">animFrame</a>
72ee: e8                                 inx
72ef: 86 a4                              stx     <a href="#SymanimFrame_unused">animFrame_unused</a>
72f1: a9 01                              lda     #$01
72f3: 85 b2                              sta     <a href="#SymerasePlayer">erasePlayer</a>
72f5: 60                                 rts

72f6: 20 06 60     <a name="Symwin_game">win_game</a>              jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
72f9: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
72fc: 01                                 .dd1    $01
72fd: c9 a0 c1 cd+                       .str    I AM RAAMO, THE SPIRIT GIFTED.
731b: ff                                 .dd1    $ff
731c: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
731f: 29                                 .dd1    $29
7320: d9 cf d5 a0+                       .str    YOU HAVE SAVED MY LIFE AND FULFILLED    THE PROPHESY.  THE QU
                                          +      EST IS OVER AND    GREEN-SKY IS SAVED.
7383: ff                                 .dd1    $ff
7384: a9 00                              lda     #$00
7386: 20 00 b6                           jsr     <a href="#SymSCRN_play_melody">SCRN_play_melody</a>
                   ; This weird test (which is always 0 so never loops) only occurs after a melody
                   ; is played, and only on win or lose. It might be a vestige of another platform,
                   ; as it would enter an infinite loop unless there is an interrupt handler
                   ; (music?) that updates this value.
7389: a5 83        @loop                 lda     <a href="#SymwaitMelody">waitMelody</a>
738b: d0 fc                              bne     @loop
738d: a2 ff                              ldx     #$ff
738f: 20 12 60                           jsr     <a href="#SymGAME2_delayXtimes256">GAME2_delayXtimes256</a>
7392: 20 06 60                           jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
7395: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7398: 01                                 .dd1    $01
7399: d9 cf d5 a0+                       .str    YOU HAVE FINISHED THE QUEST IN    DAYS. YOU ARE A
73ca: ff                                 .dd1    $ff
73cb: a6 22                              ldx     <a href="#SymdayNum">dayNum</a>
73cd: a0 00                              ldy     #$00
73cf: 20 18 77                           jsr     <a href="#SymGAME2_num_to_str">GAME2_num_to_str</a>
73d2: a9 20                              lda     #$20
73d4: 85 64                              sta     <a href="#SymHTAB">HTAB</a>
73d6: a5 fc                              lda     <a href="#Symdigits">digits</a>+3
73d8: 20 0f 60                           jsr     <a href="#SymGAME2_printchar">GAME2_printchar</a>
73db: a9 21                              lda     #$21
73dd: 85 64                              sta     <a href="#SymHTAB">HTAB</a>
73df: a5 fd                              lda     <a href="#Symdigits">digits</a>+4
73e1: 20 0f 60                           jsr     <a href="#SymGAME2_printchar">GAME2_printchar</a>
73e4: a5 22                              lda     <a href="#SymdayNum">dayNum</a>
73e6: c9 1e                              cmp     #30                     ;&gt;= 30 days, gifted quester
73e8: 90 17                              bcc     @highly_gifted
73ea: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
73ed: 33                                 .dd1    $33
73ee: c7 c9 c6 d4+                       .str    GIFTED QUESTER.
73fd: ff                                 .dd1    $ff
73fe: 4c 37 74                           jmp     @melody

7401: c9 0f        @highly_gifted        cmp     #15                     ;&gt;= 15 days, highly gifted quester
7403: 90 1e                              bcc     @master_quester
7405: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7408: 33                                 .dd1    $33
7409: c8 c9 c7 c8+                       .str    HIGHLY GIFTED QUESTER.
741f: ff                                 .dd1    $ff
7420: 4c 37 74                           jmp     @melody

7423: 20 0c 60     @master_quester       jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>           ;&lt; 15 days, master quester
7426: 33                                 .dd1    $33
7427: cd c1 d3 d4+                       .str    MASTER QUESTER.
7436: ff                                 .dd1    $ff
7437: a9 02        @melody               lda     #$02
7439: 20 00 b6                           jsr     <a href="#SymSCRN_play_melody">SCRN_play_melody</a>
743c: a5 83        @loop                 lda     <a href="#SymwaitMelody">waitMelody</a>              ;again the weird loop that never loops
743e: d0 fc                              bne     @loop
7440: 20 c3 75     @wait_for_input       jsr     <a href="#Symget_ongoing_input">get_ongoing_input</a>
7443: f0 fb                              beq     @wait_for_input
7445: a9 00                              lda     #$00
7447: 85 ba                              sta     $ba
7449: 4c 0c 77                           jmp     <a href="#SymGAME2_await_button_up">GAME2_await_button_up</a>

744c: 20 20 75     <a name="Symredraw_player">redraw_player</a>         jsr     <a href="#Symerase_old_player">erase_old_player</a>
744f: a5 19        <a name="Symdraw_player">draw_player</a>           lda     <a href="#SymplayerX">playerX</a>                 ;Save old player X,Y for later erase
7451: 85 9c                              sta     <a href="#SymplayerXold">playerXold</a>
7453: a5 1a                              lda     <a href="#SymplayerY">playerY</a>
7455: 85 9d                              sta     <a href="#SymplayerYold">playerYold</a>
                   ; Bit 0 (odd/even) in $A3 is discarded. Bit 1 becomes the high bit in A, and is
                   ; stored in $1d. Bits 7..2 are shifted to 5..0, and 32 added and stored in $1e.
7457: a5 a3                              lda     <a href="#SymanimFrame">animFrame</a>
7459: 4a                                 lsr     A
745a: 4a                                 lsr     A
745b: 85 82                              sta     <a href="#Symtemp82">temp82</a>
745d: a9 00                              lda     #$00
745f: 6a                                 ror     A                       ;Bit 7 is carry (bit 1 from $A3); Bit 6-0 is 0
7460: 18                                 clc
7461: 69 00                              adc     #$00                    ;cannot understand this. clc+adc #$00 should be nop
7463: 85 1d                              sta     <a href="#Symzp1d">zp1d</a>
7465: a5 82                              lda     <a href="#Symtemp82">temp82</a>                  ;$a3/4
7467: 69 20                              adc     #$20                    ;carry should always be 0
7469: 85 1e                              sta     <a href="#Symzp1d">zp1d</a>+1
746b: a5 19                              lda     <a href="#SymplayerX">playerX</a>
746d: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>
746f: c6 05                              dec     <a href="#SymTXTCOL">TXTCOL</a>
7471: a5 1a                              lda     <a href="#SymplayerY">playerY</a>                 ;playerY * 8 hires lines
7473: 0a           <a name="SymL7473">L7473</a>                 asl     A
7474: 0a                                 asl     A
7475: 0a                                 asl     A
7476: 38                                 sec
7477: e9 22                              sbc     #$22
7479: 85 06                              sta     <a href="#SymTXTROW">TXTROW</a>
747b: a9 ff                              lda     #$ff
747d: 85 1f                              sta     <a href="#Symzp1f">zp1f</a>
747f: a0 00                              ldy     #$00
7481: a5 05        <a name="SymL7481">L7481</a>                 lda     <a href="#SymTXTCOL">TXTCOL</a>
7483: 85 8b                              sta     <a href="#Symtemp8b">temp8b</a>
7485: a5 06                              lda     <a href="#SymTXTROW">TXTROW</a>
7487: 4a                                 lsr     A
7488: 4a                                 lsr     A
7489: 4a                                 lsr     A
748a: aa                                 tax
748b: bd 40 1d                           lda     <a href="#SymGAME1_hireslo">GAME1_hireslo</a>,x
748e: 85 0f                              sta     $0f
7490: bd 60 1d                           lda     <a href="#SymGAME1_hireshi">GAME1_hireshi</a>,x
7493: 85 10                              sta     $10
7495: a5 06                              lda     <a href="#SymTXTROW">TXTROW</a>
7497: 29 07                              and     #$07
7499: 0a                                 asl     A
749a: 0a                                 asl     A
749b: 18                                 clc
749c: 65 10                              adc     $10
749e: 18                                 clc
749f: 69 20                              adc     #$20
74a1: 85 10                              sta     $10
74a3: a5 05                              lda     <a href="#SymTXTCOL">TXTCOL</a>
74a5: 10 0e                              bpl     <a href="#SymL74B5">L74B5</a>
74a7: a5 0f                              lda     $0f
74a9: 38                                 sec
74aa: e9 01                              sbc     #$01
74ac: 85 0f                              sta     $0f
74ae: b0 12                              bcs     <a href="#SymL74C2">L74C2</a>
74b0: c6 10                              dec     $10
74b2: 4c c2 74                           jmp     <a href="#SymL74C2">L74C2</a>

74b5: a5 0f        <a name="SymL74B5">L74B5</a>                 lda     $0f
74b7: 18                                 clc
74b8: 65 05                              adc     <a href="#SymTXTCOL">TXTCOL</a>
74ba: 85 0f                              sta     $0f
74bc: a9 00                              lda     #$00
74be: 65 10                              adc     $10
74c0: 85 10                              sta     $10
74c2: a9 03        <a name="SymL74C2">L74C2</a>                 lda     #$03
74c4: 85 07                              sta     $07
74c6: a2 00                              ldx     #$00
74c8: a5 8b                              lda     <a href="#Symtemp8b">temp8b</a>
74ca: 30 26                              bmi     <a href="#SymL74F2">L74F2</a>
74cc: c9 28                              cmp     #$28
74ce: b0 22                              bcs     <a href="#SymL74F2">L74F2</a>
74d0: a5 06                              lda     <a href="#SymTXTROW">TXTROW</a>
74d2: c9 a0                              cmp     #$a0
74d4: b0 1c                              bcs     <a href="#SymL74F2">L74F2</a>
74d6: b1 1d                              lda     (<a href="#Symzp1d">zp1d</a>),y
74d8: 4a                                 lsr     A
74d9: 4c ec 74                           jmp     <a href="#SymL74EC">L74EC</a>

74dc: a5 8b        @line                 lda     <a href="#Symtemp8b">temp8b</a>
74de: 30 12                              bmi     <a href="#SymL74F2">L74F2</a>
74e0: c9 28                              cmp     #$28
74e2: b0 0e                              bcs     <a href="#SymL74F2">L74F2</a>
74e4: a5 06                              lda     <a href="#SymTXTROW">TXTROW</a>
74e6: c9 a0                              cmp     #$a0
74e8: b0 08                              bcs     <a href="#SymL74F2">L74F2</a>
74ea: b1 1d                              lda     (<a href="#Symzp1d">zp1d</a>),y
74ec: 29 7f        <a name="SymL74EC">L74EC</a>                 and     #$7f
74ee: 01 0f                              ora     ($0f,x)                 ;OR with hires screen
74f0: 81 0f                              sta     ($0f,x)                 ;note x=0; ora/sta ($0f)
74f2: c8           <a name="SymL74F2">L74F2</a>                 iny                             ;next zp1d index
74f3: e6 8b                              inc     <a href="#Symtemp8b">temp8b</a>
74f5: e6 0f                              inc     $0f                     ;16-bit inc $0f ptr
74f7: d0 02                              bne     @no16
74f9: e6 10                              inc     $10
74fb: c6 07        @no16                 dec     $07
74fd: d0 dd                              bne     @line                   ;loop 3 times total
74ff: e6 06                              inc     <a href="#SymTXTROW">TXTROW</a>
7501: 98                                 tya
7502: c9 3f                              cmp     #$3f                    ;processed 64 yet?
7504: f0 03                              beq     <a href="#SymL7509">L7509</a>
7506: 4c 81 74                           jmp     <a href="#SymL7481">L7481</a>

                   ; Increase $1d by 64 and continue. Do this twice.
7509: e6 1f        <a name="SymL7509">L7509</a>                 inc     <a href="#Symzp1f">zp1f</a>                    ;zp1f starts at #$FF
750b: d0 12                              bne     @rts                    ;so this loops twice
750d: a9 40                              lda     #$40                    ;16-bit add of 64 to $1d/$1e
750f: 18                                 clc
7510: 65 1d                              adc     <a href="#Symzp1d">zp1d</a>
7512: 85 1d                              sta     <a href="#Symzp1d">zp1d</a>
7514: a9 00                              lda     #$00
7516: 65 1e                              adc     <a href="#Symzp1d">zp1d</a>+1
7518: 85 1e                              sta     <a href="#Symzp1d">zp1d</a>+1
751a: a0 00                              ldy     #$00                    ;reset zp1d index
751c: 4c 81 74                           jmp     <a href="#SymL7481">L7481</a>

751f: 60           @rts                  rts

                   ; Redraw a 3x6 tile area at the old player position ($9c-1,$9d-5), copying tiles
                   ; from the text screen. This erases the old player.
7520: a5 9c        <a name="Symerase_old_player">erase_old_player</a>      lda     <a href="#SymplayerXold">playerXold</a>
7522: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>
7524: c6 05                              dec     <a href="#SymTXTCOL">TXTCOL</a>
7526: a5 9d                              lda     <a href="#SymplayerYold">playerYold</a>
7528: 38           <a name="SymL7528">L7528</a>                 sec
7529: e9 05                              sbc     #$05                    ;probably related to the 6 tiles printed
752b: 85 06                              sta     <a href="#SymTXTROW">TXTROW</a>
752d: a9 00                              lda     #$00
752f: a9 06                              lda     #$06
7531: 85 8b                              sta     <a href="#Symtemp8b">temp8b</a>
7533: a5 06        @row                  lda     <a href="#SymTXTROW">TXTROW</a>
7535: 30 24                              bmi     @nextrow                ;skip to next row if row &lt; 0
7537: c9 14                              cmp     #20
7539: b0 20                              bcs     @nextrow                ;or if row &gt; 19 (why not just exit)
753b: a5 05                              lda     <a href="#SymTXTCOL">TXTCOL</a>
753d: 48                                 pha
753e: a9 03                              lda     #$03
7540: 85 82                              sta     <a href="#Symtemp82">temp82</a>
7542: a6 05        @col                  ldx     <a href="#SymTXTCOL">TXTCOL</a>
7544: 30 0c                              bmi     @nextcol
7546: e0 28                              cpx     #$28
7548: b0 08                              bcs     @nextcol
754a: a4 06                              ldy     <a href="#SymTXTROW">TXTROW</a>
754c: 20 60 72                           jsr     <a href="#Symget_tile_at_xy">get_tile_at_xy</a>
754f: 20 03 60                           jsr     <a href="#SymGAME2_drawtile">GAME2_drawtile</a>          ;draw tile in A
7552: e6 05        @nextcol              inc     <a href="#SymTXTCOL">TXTCOL</a>
7554: c6 82                              dec     <a href="#Symtemp82">temp82</a>
7556: d0 ea                              bne     @col                    ;3 times
7558: 68                                 pla
7559: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>
755b: e6 06        @nextrow              inc     <a href="#SymTXTROW">TXTROW</a>
755d: c6 8b                              dec     <a href="#Symtemp8b">temp8b</a>
755f: d0 d2                              bne     @row                    ;6 times
7561: 60                                 rts

7562: a2 00        <a name="SymL7562">L7562</a>                 ldx     #$00
7564: a5 6f                              lda     <a href="#SymnpcFacing">npcFacing</a>
7566: 30 02                              bmi     <a href="#SymL756A">L756A</a>
7568: a2 06                              ldx     #$06
756a: 4c 6d 75     <a name="SymL756A">L756A</a>                 jmp     <a href="#SymL756D">L756D</a>

756d: 86 ad        <a name="SymL756D">L756D</a>                 stx     $ad
756f: e8                                 inx
7570: 86 ae                              stx     $ae
7572: 60                                 rts

7573: 20 a6 75 4c+                       .junk   6                       ;unused code

7579: a5 6b        <a name="Symdraw_npc">draw_npc?</a>             lda     <a href="#Symzp6b_npcHere">zp6b_npcHere</a>
757b: d0 01                              bne     <a href="#SymL757E">L757E</a>
757d: 60                                 rts

757e: a6 ad        <a name="SymL757E">L757E</a>                 ldx     $ad
7580: bd 9a 75                           lda     <a href="#SymL759A">L759A</a>,x
7583: 85 1d                              sta     <a href="#Symzp1d">zp1d</a>
7585: e8                                 inx
7586: bd 9a 75                           lda     <a href="#SymL759A">L759A</a>,x
7589: 85 1e                              sta     <a href="#Symzp1d">zp1d</a>+1
758b: a5 6c                              lda     <a href="#SymnpcX">npcX</a>
758d: 85 ab                              sta     $ab
758f: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>
7591: c6 05                              dec     <a href="#SymTXTCOL">TXTCOL</a>
7593: a5 6d                              lda     <a href="#SymnpcY">npcY</a>
7595: 85 ac                              sta     $ac
7597: 4c 73 74                           jmp     <a href="#SymL7473">L7473</a>

759a: 00           <a name="SymL759A">L759A</a>                 .dd1    $00
759b: af                                 .dd1    $af
759c: 80                                 .dd1    $80
759d: af                                 .dd1    $af
759e: 00                                 .dd1    $00
759f: b0                                 .dd1    $b0
75a0: 80                                 .dd1    $80
75a1: b0                                 .dd1    $b0
75a2: 00                                 .dd1    $00
75a3: b1                                 .dd1    $b1
75a4: 80                                 .dd1    $80
75a5: b1                                 .dd1    $b1

75a6: a5 ab        <a name="SymL75A6">L75A6</a>                 lda     $ab
75a8: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>
75aa: c6 05                              dec     <a href="#SymTXTCOL">TXTCOL</a>
75ac: a5 ac                              lda     $ac
75ae: 4c 28 75                           jmp     <a href="#SymL7528">L7528</a>

                   <span style="background-color: #72be72">NOTE: Wraps a call to input code at $6b09 ($75c3). It ensures any latched</span>
                   <span style="background-color: #72be72">keyboard motion is stopped, gets input, and ignores any returned button press if</span>
                   <span style="background-color: #72be72">we are moving upward (the keyboard handler adds a virtual button press for UP).</span>
                   <span style="background-color: #72be72"></span>
                   <span style="background-color: #72be72">This is the exact behavior you'd want in a menu.</span>
                   <span style="background-color: #72be72"></span>
                   <span style="background-color: #72be72">Returns 0 or 1 (button press status) in A.</span>
75b1: a9 00        <a name="Symget_menu_input">get_menu_input</a>        lda     #$00                    ;clear the kbd movement latches
75b3: 85 b0                              sta     <a href="#SymYMOVFLG">YMOVFLG</a>
75b5: 85 af                              sta     <a href="#SymXMOVFLG">XMOVFLG</a>
75b7: 20 c3 75                           jsr     <a href="#Symget_ongoing_input">get_ongoing_input</a>
75ba: a6 b0                              ldx     <a href="#SymYMOVFLG">YMOVFLG</a>
75bc: 10 02                              bpl     @ret                    ;branch if not moving up
75be: a9 00                              lda     #$00                    ;or clear button press if we are moving up
                   ; ORA #0 (AND #$FF, EOR #0) will make the N and Z flags reflect the value in A.
                   ; This is used to ensure the Z flag still reflects A (return value from $75C3)
                   ; after the LDX, so callers can BEQ/BNE.
75c0: 09 00        @ret                  ora     #$00                    ;update N and Z from A, even when LDA skipped
75c2: 60                                 rts

                   <span style="background-color: #72be72">NOTE: Input code called via $6b09 vector or directly. Vector $6b29 ($75b1) also</span>
                   <span style="background-color: #72be72">calls this as its main action, but with a bit of wrapper code. This code</span>
                   <span style="background-color: #72be72">respects any latched keyboard movement.</span>
                   <span style="background-color: #72be72"></span>
                   <span style="background-color: #72be72">This code behaves in 1 of 2 ways after its preamble. If DEMOFLG is 0, it handles</span>
                   <span style="background-color: #72be72">keyboard/joystick input. If 1, it calls $9600, which calls back into this</span>
                   <span style="background-color: #72be72">handler in non-demo mode and does a bunch of processing, then we update</span>
                   <span style="background-color: #72be72">XDIR/YDIR/MOVING/BUTTON based on its return value, just as if we were handling</span>
                   <span style="background-color: #72be72">input.</span>
                   <span style="background-color: #72be72"></span>
                   <span style="background-color: #72be72">Amusingly, if you set $C4 to 0 while the sample quest or intro screen is</span>
                   <span style="background-color: #72be72">playing, you can take over.</span>
75c3: a9 00        <a name="Symget_ongoing_input">get_ongoing_input</a>     lda     #$00                    ;from $6b09 or 
75c5: 85 85                              sta     <a href="#SymXDIR">XDIR</a>
75c7: 85 86                              sta     <a href="#SymYDIR">YDIR</a>
75c9: 85 a2                              sta     <a href="#SymMOVING">MOVING</a>
75cb: 85 84                              sta     <a href="#SymVIRTBTN">VIRTBTN</a>
75cd: 20 2e 6e                           jsr     <a href="#Symis_climbing">is_climbing</a>
75d0: b0 04                              bcs     <a href="#SymL75D6">L75D6</a>
75d2: a9 00                              lda     #$00
75d4: 85 b0                              sta     <a href="#SymYMOVFLG">YMOVFLG</a>
75d6: a5 92        <a name="SymL75D6">L75D6</a>                 lda     <a href="#SymFALLCNT">FALLCNT</a>
75d8: c9 01                              cmp     #$01
75da: 10 04                              bpl     @falling                ;branch when falling, it seems
75dc: a5 94                              lda     <a href="#SymflyFlag">flyFlag</a>
75de: f0 04                              beq     <a href="#SymL75E4">L75E4</a>
75e0: a9 00        @falling              lda     #$00                    ;cancel X movement when falling
75e2: 85 af                              sta     <a href="#SymXMOVFLG">XMOVFLG</a>
75e4: a5 c4        <a name="SymL75E4">L75E4</a>                 lda     <a href="#SymDEMOFLG">DEMOFLG</a>                 ;If not in demo mode,
75e6: f0 32                              beq     <a href="#Symhandle_kbd_or_joy">handle_kbd_or_joy</a>       ;handle kbd/joy input and return to caller
75e8: 20 00 96                           jsr     <a href="#SymSCRN_demo_handler">SCRN_demo_handler</a>       ;otherwise get demo movement for this frame in A
75eb: 2c bb 1d                           bit     <a href="#SymGAME1_BITTAB3">GAME1_BITTAB3</a>           ;test bit 3 of A
75ee: d0 04                              bne     @test_left
75f0: e6 85                              inc     <a href="#SymXDIR">XDIR</a>                    ;moving right
75f2: e6 a2                              inc     <a href="#SymMOVING">MOVING</a>                  ;we moved
75f4: 2c ba 1d     @test_left            bit     <a href="#SymGAME1_BITTAB2">GAME1_BITTAB2</a>           ;test bit 2 of A
75f7: d0 04                              bne     @test_down
75f9: c6 85                              dec     <a href="#SymXDIR">XDIR</a>                    ;moving left
75fb: e6 a2                              inc     <a href="#SymMOVING">MOVING</a>
75fd: 2c b9 1d     @test_down            bit     <a href="#SymGAME1_BITTAB1">GAME1_BITTAB1</a>           ;test bit 1 of A
7600: d0 04                              bne     @test_up
7602: e6 86                              inc     <a href="#SymYDIR">YDIR</a>
7604: e6 a2                              inc     <a href="#SymMOVING">MOVING</a>
7606: 2c b8 1d     @test_up              bit     <a href="#SymGAME1_BITTAB0">GAME1_BITTAB0</a>           ;test bit 0 of A
7609: d0 04                              bne     @test_button?
760b: c6 86                              dec     <a href="#SymYDIR">YDIR</a>
760d: e6 a2                              inc     <a href="#SymMOVING">MOVING</a>
760f: 2c bc 1d     @test_button?         bit     <a href="#SymGAME1_BITTAB4">GAME1_BITTAB4</a>           ;test bit 4 of A -- !button
7612: d0 03                              bne     @ret00                  ;set, return 0
7614: a9 01                              lda     #$01                    ;clear, return 1
7616: 60                                 rts

7617: a9 00        @ret00                lda     #$00
7619: 60                                 rts

761a: a5 b1        <a name="Symhandle_kbd_or_joy">handle_kbd_or_joy</a>     lda     <a href="#SymJOYFLG">JOYFLG</a>
761c: f0 03                              beq     <a href="#Symhandle_ijkm_space">handle_ijkm_space</a>
761e: 4c ac 76                           jmp     <a href="#Symhandle_joystick">handle_joystick</a>

                   ********************************************************************************
                   * Handle cursor/character motion. Supports both IJKM and RDFC for up-left-     *
                   * right-down, along with spacebar for execute/jump. The keyboard handler       *
                   * translates its inputs into the equivalent joystick actions (horiz/vert       *
                   * movement and button presses), and callers just handle joystick actions. It   *
                   * keeps some extra state since keys don't need to be held down to move.        *
                   *                                                                              *
                   * $84 (VIRTBTN) is a temporary used only in this handler. It represents a      *
                   * virtual joystick button press; this is returned in A to match the joystick   *
                   * API. For example, pressing UP (I) will return a virtual button press to the  *
                   * caller, because KBD UP enters a door, just like JOY BTN. As another example, *
                   * a double press of KBD LEFT/RIGHT will trigger a virtual button press because *
                   * this will switch to run mode, just like JOY BTN + LEFT/RIGHT. And KBD SPACE  *
                   * simulates JOY BTN + DOWN, which brings up the action menu.                   *
                   *                                                                              *
                   * $AF/$B0 are X/Y movement latches (-1, 0, +1), set on initial keypress and    *
                   * maintained until you hit something, press another movement key, etc.         *
                   *                                                                              *
                   * On return, XDIR and YDIR and MOVING are set as their joystick equivalents,   *
                   * along with A as the virtual button press.                                    *
                   ********************************************************************************
7621: 20 09 b6     <a name="Symhandle_ijkm_space">handle_ijkm_space</a>     jsr     <a href="#SymSCRN_chkkey">SCRN_chkkey</a>
7624: f0 70                              beq     @finish
7626: a5 02                              lda     <a href="#SymLASTKEY">LASTKEY</a>
7628: c9 c6                              cmp     #F | $80
762a: f0 04                              beq     @right
762c: c9 cb                              cmp     #K | $80
762e: d0 0d                              bne     @chk_left
7630: e6 af        @right                inc     <a href="#SymXMOVFLG">XMOVFLG</a>
7632: a5 af                              lda     <a href="#SymXMOVFLG">XMOVFLG</a>
7634: c9 02                              cmp     #$02                    ;was x motion previously 1?
7636: d0 19                              bne     @move_horiz             ;no, move right
7638: c6 af                              dec     <a href="#SymXMOVFLG">XMOVFLG</a>                 ;yes, double press; set back to 1
763a: 4c 4f 76                           jmp     @run                    ;and start running

763d: c9 c4        @chk_left             cmp     #D | $80
763f: f0 04                              beq     @left
7641: c9 ca                              cmp     #J | $80
7643: d0 20                              bne     @chk_up
7645: c6 af        @left                 dec     <a href="#SymXMOVFLG">XMOVFLG</a>
7647: a5 af                              lda     <a href="#SymXMOVFLG">XMOVFLG</a>
7649: c9 fe                              cmp     #$fe                    ;was this previously -1?
764b: d0 04                              bne     @move_horiz             ;nope, we've just started to move left
764d: e6 af                              inc     <a href="#SymXMOVFLG">XMOVFLG</a>                 ;yes, double press; set back to -1
764f: e6 84        @run                  inc     <a href="#SymVIRTBTN">VIRTBTN</a>                 ;...and press button (to run)
7651: a9 00        @move_horiz           lda     #$00
7653: 85 b0                              sta     <a href="#SymYMOVFLG">YMOVFLG</a>                 ;halt vertical motion
7655: 20 2e 6e                           jsr     <a href="#Symis_climbing">is_climbing</a>
7658: b0 06                              bcs     <a href="#SymL7660">L7660</a>
765a: a5 92                              lda     <a href="#SymFALLCNT">FALLCNT</a>                 ;might be, how many tiles we have fallen
765c: c9 03                              cmp     #$03                    ;because we can't fly until we fall a bit
765e: 30 36                              bmi     @finish
                   ; So far I can get here if we are falling and press right, or if we are on a
                   ; ladder and press right. VIRTBTN appears to be zero on entry.
7660: e6 84        <a name="SymL7660">L7660</a>                 inc     <a href="#SymVIRTBTN">VIRTBTN</a>
7662: 4c 96 76                           jmp     @finish

7665: c9 d2        @chk_up               cmp     #R | $80
7667: f0 04                              beq     @up
7669: c9 c9                              cmp     #I | $80
766b: d0 0a                              bne     @chk_down
766d: a5 b0        @up                   lda     <a href="#SymYMOVFLG">YMOVFLG</a>
766f: 30 21                              bmi     @haltx                  ;if already moving up, stop x motion and return
7671: e6 84                              inc     <a href="#SymVIRTBTN">VIRTBTN</a>                 ;otherwise, press button (as if to enter door)
7673: c6 b0                              dec     <a href="#SymYMOVFLG">YMOVFLG</a>                 ;and also start moving up
7675: 30 1b                              bmi     @haltx
7677: c9 c3        @chk_down             cmp     #C | $80
7679: f0 04                              beq     @down
767b: c9 cd                              cmp     #M | $80
767d: d0 0b                              bne     @chk_space
767f: a5 b0        @down                 lda     <a href="#SymYMOVFLG">YMOVFLG</a>
7681: c9 01                              cmp     #$01                    ;were we already moving down?
7683: f0 0d                              beq     @haltx                  ;yes, just stop x motion and return
7685: e6 b0                              inc     <a href="#SymYMOVFLG">YMOVFLG</a>                 ;no, start moving down
7687: 4c 92 76                           jmp     @haltx                  ;stop x motion (and return)

768a: c9 a0        @chk_space            cmp     #  | $80
768c: d0 08                              bne     @finish
768e: e6 84                              inc     <a href="#SymVIRTBTN">VIRTBTN</a>                 ;SPACE is JOY BTN + JOY DOWN
7690: e6 86                              inc     <a href="#SymYDIR">YDIR</a>                    ;which will bring up the menu
7692: a9 00        @haltx                lda     #$00                    ;halt horizontal motion
7694: 85 af                              sta     <a href="#SymXMOVFLG">XMOVFLG</a>
7696: a5 af        @finish               lda     <a href="#SymXMOVFLG">XMOVFLG</a>
7698: f0 05                              beq     @no_x_motion
769a: 85 85                              sta     <a href="#SymXDIR">XDIR</a>                    ;we are moving horizontally
769c: 4c a5 76                           jmp     @moving

769f: a5 b0        @no_x_motion          lda     <a href="#SymYMOVFLG">YMOVFLG</a>                 ;only check Y if no X motion, can't move diagonally
76a1: f0 06                              beq     @no_y_motion
76a3: 85 86                              sta     <a href="#SymYDIR">YDIR</a>
76a5: a9 01        @moving               lda     #$01                    ;effectively, MOVING &lt;- XDIR|YDIR
76a7: 85 a2                              sta     <a href="#SymMOVING">MOVING</a>
76a9: a5 84        @no_y_motion          lda     <a href="#SymVIRTBTN">VIRTBTN</a>                 ;return virtual joystick button press in A
76ab: 60                                 rts                             ;end of cursor/character keypress handler

                   ; Joystick handling is less complicated than the keyboard. This subroutine
                   ; updates XDIR (when horizontal joystick movement), YDIR (vertical movement) and
                   ; MOVING (XDIR | YDIR).
                   ; 
                   ; On return, accumulator is 0 for no button currently pressed, or 1 for pressed.
76ac: a2 04        <a name="Symhandle_joystick">handle_joystick</a>       ldx     #$04
76ae: 20 12 60                           jsr     <a href="#SymGAME2_delayXtimes256">GAME2_delayXtimes256</a>
76b1: a2 00                              ldx     #$00
76b3: 20 1e fb                           jsr     <a href="#SymMON_PREAD">MON_PREAD</a>
76b6: 98                                 tya
76b7: a2 ff                              ldx     #$ff
76b9: c9 40                              cmp     #$40
76bb: 90 08                              bcc     <a href="#SymL76C5">L76C5</a>
76bd: a2 01                              ldx     #$01
76bf: c9 c0                              cmp     #$c0
76c1: b0 02                              bcs     <a href="#SymL76C5">L76C5</a>
76c3: a2 00                              ldx     #$00
76c5: 86 85        <a name="SymL76C5">L76C5</a>                 stx     <a href="#SymXDIR">XDIR</a>
76c7: a2 04                              ldx     #$04
76c9: 20 12 60                           jsr     <a href="#SymGAME2_delayXtimes256">GAME2_delayXtimes256</a>
76cc: a2 01                              ldx     #$01
76ce: 20 1e fb                           jsr     <a href="#SymMON_PREAD">MON_PREAD</a>
76d1: 98                                 tya
76d2: a0 ff                              ldy     #$ff
76d4: c9 40                              cmp     #$40
76d6: 90 08                              bcc     <a href="#SymL76E0">L76E0</a>
76d8: a0 01                              ldy     #$01
76da: c9 c0                              cmp     #$c0
76dc: b0 02                              bcs     <a href="#SymL76E0">L76E0</a>
76de: a0 00                              ldy     #$00
76e0: 84 86        <a name="SymL76E0">L76E0</a>                 sty     <a href="#SymYDIR">YDIR</a>
76e2: a5 86                              lda     <a href="#SymYDIR">YDIR</a>                    ;moving if XDIR or YDIR is non-zero
76e4: 05 85                              ora     <a href="#SymXDIR">XDIR</a>
76e6: f0 04                              beq     @nomove                 ;stationary, branch
76e8: a9 01                              lda     #$01                    ;we are moving
76ea: 85 a2                              sta     <a href="#SymMOVING">MOVING</a>
76ec: a2 04        @nomove               ldx     #$04
76ee: 20 12 60                           jsr     <a href="#SymGAME2_delayXtimes256">GAME2_delayXtimes256</a>
76f1: a2 00                              ldx     #$00
76f3: ad 62 c0                           lda     <a href="#SymBUTN1">BUTN1</a>                   ;treat either button equally
76f6: 0d 61 c0                           ora     <a href="#SymBUTN0">BUTN0</a>
76f9: 10 02                              bpl     <a href="#SymL76FD">L76FD</a>
76fb: a2 01                              ldx     #$01
76fd: 8a           <a name="SymL76FD">L76FD</a>                 txa                             ;return A=0 if no button press, 1 if press
76fe: 60                                 rts

76ff: 20                                 .dd1    $20

                   ; Vectors! This section deals with menus and actions.
7700: 4c 27 77     <a name="SymGAME2_action_menu">GAME2_action_menu</a>     jmp     <a href="#Symaction_menu">action_menu</a>

7703: 4c c0 7f     <a name="SymGAME2_slot_to_item">GAME2_slot_to_item</a>    jmp     <a href="#Symslot_to_item">slot_to_item</a>            ;input slot $00-fe (A), output item 0-14 (Y)

7706: 4c e3 7f     <a name="SymGAME2_message_wait">GAME2_message_wait</a>    jmp     <a href="#Symmessage_wait">message_wait</a>            ;wait for input after a message

7709: 4c 4b 84     <a name="SymL7709">L7709</a>                 jmp     <a href="#Symtime_has_passed">time_has_passed</a>

770c: 4c f2 7f     <a name="SymGAME2_await_button_up">GAME2_await_button_up</a> jmp     <a href="#Symawait_button_up">await_button_up</a>

770f: 4c a2 7e     <a name="SymGAME2_print_item_desc">GAME2_print_item_desc</a> jmp     <a href="#Symprint_item_desc">print_item_desc</a>

7712: 4c 48 7e     <a name="SymGAME2_lose_weight">GAME2_lose_weight</a>     jmp     <a href="#Symlose_weight">lose_weight</a>

7715: 4c dd 81                           jmp     <a href="#SymL81DD">L81DD</a>

7718: 4c cc 84     <a name="SymGAME2_num_to_str">GAME2_num_to_str</a>      jmp     <a href="#Symnum_to_str">num_to_str</a>

771b: 4c 61 84     <a name="SymGAME2_next_tick">GAME2_next_tick</a>       jmp     <a href="#Symnext_tick">next_tick</a>

771e: 4c fd 79     <a name="SymGAME2_attacked">GAME2_attacked</a>        jmp     <a href="#Symattacked">attacked</a>

7721: 4c 90 7e     <a name="SymGAME2_txtpos_to_addr">GAME2_txtpos_to_addr</a>  jmp     <a href="#Symtxtpos_to_addr">txtpos_to_addr</a>

7724: 4c 51 7e                           jmp     <a href="#SymL7E51">L7E51</a>

7727: 20 2f 78     <a name="Symaction_menu">action_menu</a>           jsr     <a href="#Symdisplay_actions">display_actions</a>
772a: a9 00                              lda     #$00
772c: 85 71                              sta     <a href="#SymMENUCOL">MENUCOL</a>                 ;set top left of menu (0,0)
772e: 85 72                              sta     <a href="#SymMENUROW">MENUROW</a>
7730: 85 73                              sta     <a href="#SymMENUCOL_NEXT">MENUCOL_NEXT</a>            ;next menucol/row, so we can unhighlight old row
7732: 85 74                              sta     <a href="#SymMENUROW_NEXT">MENUROW_NEXT</a>            ;these are really temp vars, only used here
7734: 85 9f                              sta     <a href="#SymenterMenu">enterMenu</a>
7736: 20 f6 78                           jsr     <a href="#Symhighlight_menu_action">highlight_menu_action</a>
7739: 20 f2 7f     <a name="Symaction_menu_no_effect">action_menu_no_effect</a> jsr     <a href="#Symawait_button_up">await_button_up</a>         ;jmp here when no effect (RENEW in Neshom)
773c: 20 2a 6b     @check_input          jsr     <a href="#SymGAME2_menu_input">GAME2_menu_input</a>        ;get input
773f: f0 08                              beq     @check_moving           ;no button, branch
7741: a2 01                              ldx     #$01                    ;button pressed, boop
7743: 20 03 b6                           jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>
7746: 4c 92 77                           jmp     <a href="#Symselect_menu_item">select_menu_item</a>

                   tmpMoved              .var    $08    {addr/1}         ;did we actually move menu pos?

7749: a5 a2        @check_moving         lda     <a href="#SymMOVING">MOVING</a>                  ;no button, check direction
774b: f0 ef                              beq     @check_input            ;no input, loop
774d: a9 00                              lda     #$00
774f: 85 08                              sta     tmpMoved
7751: 18                                 clc
7752: a5 85                              lda     <a href="#SymXDIR">XDIR</a>                    ;FF (left), 01 (right)
7754: f0 0c                              beq     @check_ymove            ;no attempt to move
7756: 65 73                              adc     <a href="#SymMENUCOL_NEXT">MENUCOL_NEXT</a>
7758: 30 08                              bmi     @check_ymove            ;off left edge, don't move
775a: c9 05                              cmp     #$05                    ;off the right edge?
775c: f0 04                              beq     @check_ymove            ;yes, don't move
775e: 85 73                              sta     <a href="#SymMENUCOL_NEXT">MENUCOL_NEXT</a>            ;no, set next column
7760: e6 08                              inc     tmpMoved                ;and note that we moved
7762: 18           @check_ymove          clc
7763: a5 86                              lda     <a href="#SymYDIR">YDIR</a>                    ;FF (up), 01 (down)
7765: f0 0c                              beq     @check_moved            ;no attempt to move vertically
7767: 65 74                              adc     <a href="#SymMENUROW_NEXT">MENUROW_NEXT</a>
7769: 30 08                              bmi     @check_moved            ;off top edge, don't move
776b: c9 04                              cmp     #$04                    ;off the bottom?
776d: f0 04                              beq     @check_moved            ;yes, don't move
776f: 85 74                              sta     <a href="#SymMENUROW_NEXT">MENUROW_NEXT</a>            ;no, set next row
7771: e6 08                              inc     tmpMoved                ;and note that we moved
7773: a5 08        @check_moved          lda     tmpMoved
7775: f0 c5                              beq     @check_input            ;no movement, get more input
7777: 20 10 79                           jsr     <a href="#Symunhighlight_menu_action">unhighlight_menu_action</a> ;unhighlight old menu item
777a: a5 73                              lda     <a href="#SymMENUCOL_NEXT">MENUCOL_NEXT</a>
777c: 85 71                              sta     <a href="#SymMENUCOL">MENUCOL</a>                 ;update menu position
777e: a5 74                              lda     <a href="#SymMENUROW_NEXT">MENUROW_NEXT</a>
7780: 85 72                              sta     <a href="#SymMENUROW">MENUROW</a>
7782: 20 f6 78                           jsr     <a href="#Symhighlight_menu_action">highlight_menu_action</a>   ;and highlight new menu item
7785: a2 00                              ldx     #$00
7787: 20 03 b6                           jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>         ;beep
778a: a2 60                              ldx     #$60
778c: 20 12 60                           jsr     <a href="#SymGAME2_delayXtimes256">GAME2_delayXtimes256</a>    ;delay repeat
778f: 4c 3c 77                           jmp     @check_input            ;get more input

7792: a5 71        <a name="Symselect_menu_item">select_menu_item</a>      lda     <a href="#SymMENUCOL">MENUCOL</a>                 ;col 0, row 0 (PAUSE)
7794: d0 18                              bne     <a href="#Symmenu_take">menu_take</a>
7796: a5 72                              lda     <a href="#SymMENUROW">MENUROW</a>
7798: d0 03                              bne     <a href="#Symmenu_speak">menu_speak</a>
779a: 4c 06 60                           jmp     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>

779d: c9 01        <a name="Symmenu_speak">menu_speak</a>            cmp     #$01                    ;row 1
779f: d0 03                              bne     <a href="#Symmenu_pense">menu_pense</a>
77a1: 4c 0c 9c                           jmp     <a href="#SymSCRN_speak">SCRN_speak</a>

77a4: c9 02        <a name="Symmenu_pense">menu_pense</a>            cmp     #$02
77a6: d0 03                              bne     <a href="#Symmenu_offer">menu_offer</a>
77a8: 4c 0f 9c                           jmp     <a href="#SymSCRN_pense">SCRN_pense</a>

77ab: 4c 18 9c     <a name="Symmenu_offer">menu_offer</a>            jmp     <a href="#SymSCRN_offer">SCRN_offer</a>

77ae: c9 01        <a name="Symmenu_take">menu_take</a>             cmp     #$01                    ;col 1
77b0: d0 18                              bne     <a href="#Symmenu_drop">menu_drop</a>
77b2: a5 72                              lda     <a href="#SymMENUROW">MENUROW</a>
77b4: d0 03                              bne     <a href="#Symmenu_buy">menu_buy</a>
77b6: 4c e6 7b                           jmp     <a href="#Symtake">take</a>

77b9: c9 01        <a name="Symmenu_buy">menu_buy</a>              cmp     #$01
77bb: d0 03                              bne     <a href="#Symmenu_use">menu_use</a>
77bd: 4c 12 9c                           jmp     $9c12

77c0: c9 02        <a name="Symmenu_use">menu_use</a>              cmp     #$02
77c2: d0 03                              bne     <a href="#Symmenu_eat">menu_eat</a>
77c4: 4c 09 9c                           jmp     $9c09

77c7: 4c fc 7f     <a name="Symmenu_eat">menu_eat</a>              jmp     <a href="#Symwhat_will_you_eat">what_will_you_eat</a>

77ca: c9 02        <a name="Symmenu_drop">menu_drop</a>             cmp     #$02                    ;col 2
77cc: d0 18                              bne     <a href="#Symmenu_examine">menu_examine</a>
77ce: a5 72                              lda     <a href="#SymMENUROW">MENUROW</a>
77d0: d0 03                              bne     <a href="#Symmenu_sell">menu_sell</a>
77d2: 4c d0 7c                           jmp     <a href="#SymL7CD0">L7CD0</a>

77d5: c9 01        <a name="Symmenu_sell">menu_sell</a>             cmp     #$01
77d7: d0 03                              bne     <a href="#Symmenu_heal">menu_heal</a>
77d9: 4c 15 9c                           jmp     <a href="#SymSCRN_sell">SCRN_sell</a>

77dc: c9 02        <a name="Symmenu_heal">menu_heal</a>             cmp     #$02
77de: d0 03                              bne     <a href="#Symmenu_rest">menu_rest</a>
77e0: 4c 00 9c                           jmp     <a href="#SymSCRN_heal">SCRN_heal</a>

77e3: 4c b5 7a     <a name="Symmenu_rest">menu_rest</a>             jmp     <a href="#SymL7AB5">L7AB5</a>

77e6: c9 03        <a name="Symmenu_examine">menu_examine</a>          cmp     #$03                    ;col 3
77e8: d0 18                              bne     <a href="#Symmenu_status">menu_status</a>
77ea: a5 72                              lda     <a href="#SymMENUROW">MENUROW</a>
77ec: d0 03                              bne     <a href="#Symmenu_inventory">menu_inventory</a>
77ee: 4c 13 82     <a name="SymGAME2_examine">GAME2_examine</a>         jmp     <a href="#Symexamine">examine</a>

77f1: c9 01        <a name="Symmenu_inventory">menu_inventory</a>        cmp     #$01
77f3: d0 03                              bne     <a href="#Symmenu_grunspreke">menu_grunspreke</a>
77f5: 4c 65 82                           jmp     <a href="#Symdo_menu_inventory">do_menu_inventory</a>

77f8: c9 02        <a name="Symmenu_grunspreke">menu_grunspreke</a>       cmp     #$02
77fa: d0 03                              bne     <a href="#Symmenu_kiniport">menu_kiniport</a>
77fc: 4c 03 9c                           jmp     <a href="#SymSCRN_grunspreke">SCRN_grunspreke</a>

77ff: 4c 06 9c     <a name="Symmenu_kiniport">menu_kiniport</a>         jmp     <a href="#SymSCRN_kiniport">SCRN_kiniport</a>

7802: a5 72        <a name="Symmenu_status">menu_status</a>           lda     <a href="#SymMENUROW">MENUROW</a>                 ;col 4
7804: d0 03                              bne     <a href="#Symmenu_renew">menu_renew</a>
7806: 4c c1 82                           jmp     <a href="#Symdo_menu_status">do_menu_status</a>          ;row 0

7809: c9 01        <a name="Symmenu_renew">menu_renew</a>            cmp     #$01                    ;row 1
780b: d0 0a                              bne     <a href="#Symmenu_menu">menu_menu</a>
780d: a5 35                              lda     <a href="#SymdoorNeshom">doorNeshom</a>
780f: f0 03                              beq     @renew
7811: 4c 39 77                           jmp     <a href="#Symaction_menu_no_effect">action_menu_no_effect</a>   ;RENEW does nothing in Neshom realm

7814: 4c 1f 84     @renew                jmp     <a href="#Symrenew">renew</a>

7817: c9 02        <a name="Symmenu_menu">menu_menu</a>             cmp     #$02                    ;row 2
7819: d0 08                              bne     <a href="#Symmenu_sound">menu_sound</a>
781b: 20 06 60                           jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
781e: 68                                 pla                             ;discard game loop
781f: 68                                 pla
7820: 4c 40 a8                           jmp     <a href="#SymSCRN_warm_start">SCRN_warm_start</a>         ;return to menu

7823: a9 01        <a name="Symmenu_sound">menu_sound</a>            lda     #$01                    ;row 3
7825: 45 4a                              eor     <a href="#SymSOUNDFLG">SOUNDFLG</a>                ;toggle sound
7827: 85 4a                              sta     <a href="#SymSOUNDFLG">SOUNDFLG</a>
7829: 20 49 a8                           jsr     <a href="#SymSCRN_sound_status">SCRN_sound_status</a>       ;display sound status
782c: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

                   ; Display action menu. This is a single string that wraps around the screen as
                   ; it is printed in one shot.
782f: a9 00        <a name="Symdisplay_actions">display_actions</a>       lda     #$00
7831: 85 64                              sta     <a href="#SymHTAB">HTAB</a>
7833: a6 64        @char                 ldx     <a href="#SymHTAB">HTAB</a>
7835: bd 44 78                           lda     <a href="#Symaction_text">action_text</a>,x
7838: 20 0f 60                           jsr     <a href="#SymGAME2_printchar">GAME2_printchar</a>
783b: e6 64                              inc     <a href="#SymHTAB">HTAB</a>
783d: a5 64                              lda     <a href="#SymHTAB">HTAB</a>
783f: c9 9f                              cmp     #$9f                    ;hardcoded length of action_text
7841: d0 f0                              bne     @char
7843: 60                                 rts

7844: a0 d0 c1 d5+ <a name="Symaction_text">action_text</a>           .str     PAUSE  TAKE  DROP  EXAMINE     STATUS   SPEAK  BUY   SELL  I
                                          +      NVENTORY   RENEW    PENSE  USE   HEAL  GRUNSPREKE  MENU     OF
                                          +      FER  EAT   REST  KINIPORT    SOUND  

                   ; Given menu row # and col #, get entry's htab (in HTAB) and width (in $77).
                   tmp_menuwidth         .var    $77    {addr/1}         ;width of current menu column

78e3: a6 72        <a name="Symget_menu_pos">get_menu_pos</a>          ldx     <a href="#SymMENUROW">MENUROW</a>                 ;menu row number we are on
78e5: bd 26 79                           lda     <a href="#Symtext_col1">text_col1</a>,x             ;get the htab of col 1 in row
78e8: a6 71                              ldx     <a href="#SymMENUCOL">MENUCOL</a>                 ;menu column we are on
78ea: 18                                 clc
78eb: 7d 2a 79                           adc     <a href="#Symtext_colx">text_colx</a>,x             ;get htab of menu column
78ee: 85 64                              sta     <a href="#SymHTAB">HTAB</a>
78f0: bd 2f 79                           lda     <a href="#Symtext_colw">text_colw</a>,x             ;get width of menu column
78f3: 85 77                              sta     tmp_menuwidth           ;save for later
78f5: 60                                 rts

                   ; Highlight text of currently selected action menu item by drawing it in inverse
                   ; text over the existing menu item.
78f6: 20 e3 78     <a name="Symhighlight_menu_action">highlight_menu_action</a> jsr     <a href="#Symget_menu_pos">get_menu_pos</a>
78f9: a9 01                              lda     #$01
78fb: 85 66                              sta     <a href="#SymINVTEXT">INVTEXT</a>                 ;enable inverse
78fd: a6 64        @char                 ldx     <a href="#SymHTAB">HTAB</a>                    ;HTAB is also the index into the action text string
78ff: bd 44 78                           lda     <a href="#Symaction_text">action_text</a>,x
7902: 20 0f 60                           jsr     <a href="#SymGAME2_printchar">GAME2_printchar</a>
7905: e6 64                              inc     <a href="#SymHTAB">HTAB</a>                    ;next screen col &amp; string char
7907: c6 77                              dec     tmp_menuwidth
7909: d0 f2                              bne     @char
790b: a9 00                              lda     #$00
790d: 85 66                              sta     <a href="#SymINVTEXT">INVTEXT</a>                 ;disable inverse
790f: 60                                 rts

                   ; Unhighlight selected menu action, after we have previously highlighted it and
                   ; are moving away.
                   <a name="Symunhighlight_menu_action">unhighlight_menu_action</a>
7910: 20 e3 78                           jsr     <a href="#Symget_menu_pos">get_menu_pos</a>
7913: a9 00                              lda     #$00
7915: 85 66                              sta     <a href="#SymINVTEXT">INVTEXT</a>                 ;disable inverse
7917: a6 64        @char                 ldx     <a href="#SymHTAB">HTAB</a>
7919: bd 44 78                           lda     <a href="#Symaction_text">action_text</a>,x
791c: 20 0f 60                           jsr     <a href="#SymGAME2_printchar">GAME2_printchar</a>
791f: e6 64                              inc     <a href="#SymHTAB">HTAB</a>
7921: c6 77                              dec     tmp_menuwidth
7923: d0 f2                              bne     @char
7925: 60                                 rts

7926: 00 28 50 78  <a name="Symtext_col1">text_col1</a>             .bulk   00285078                ;col #s of first col of text
792a: 00 07 0d 13+ <a name="Symtext_colx">text_colx</a>             .bulk   00070d131f              ;col #s of each menu col
792f: 07 06 06 0c+ <a name="Symtext_colw">text_colw</a>             .bulk   0706060c08              ;width of each menu col

                    Clear variables

7934: a2 4a        <a name="SymL7934">L7934</a>                 ldx     #$4a
7936: bd 6c b5     <a name="SymL7936">L7936</a>                 lda     <a href="#Syminv_token">inv_token</a>,x
7939: 2c bd 1d                           bit     <a href="#SymGAME1_BITTAB5">GAME1_BITTAB5</a>
793c: f0 0a                              beq     <a href="#SymL7948">L7948</a>
793e: a9 00                              lda     #$00
7940: 9d 6c b5                           sta     <a href="#Syminv_token">inv_token</a>,x
7943: a0 08                              ldy     #$08
7945: 20 48 7e                           jsr     <a href="#Symlose_weight">lose_weight</a>
7948: ca           <a name="SymL7948">L7948</a>                 dex
7949: 10 eb                              bpl     <a href="#SymL7936">L7936</a>
794b: 60                                 rts

794c: a2 13        <a name="SymL794C">L794C</a>                 ldx     #$13
794e: bd 58 b5     @loop                 lda     <a href="#Syminv_shuba">inv_shuba</a>,x
7951: 2c bd 1d                           bit     <a href="#SymGAME1_BITTAB5">GAME1_BITTAB5</a>
7954: f0 0a                              beq     <a href="#SymL7960">L7960</a>
7956: a9 00                              lda     #$00
7958: 9d 58 b5                           sta     <a href="#Syminv_shuba">inv_shuba</a>,x
795b: a0 07                              ldy     #<a href="#Symitem_shuba">item_shuba</a>
795d: 20 48 7e                           jsr     <a href="#Symlose_weight">lose_weight</a>
7960: ca           <a name="SymL7960">L7960</a>                 dex
7961: 10 eb                              bpl     @loop
7963: 60                                 rts

7964: a9 1c        <a name="Symkidnapped_by_salaat">kidnapped_by_salaat</a>   lda     #$1c
7966: 85 1b                              sta     <a href="#SymMAPPOS">MAPPOS</a>
7968: a9 00                              lda     #$00
796a: 85 1c                              sta     <a href="#SymMAPHALF">MAPHALF</a>
796c: a9 01                              lda     #$01
796e: 85 67                              sta     <a href="#SymINSIDE">INSIDE</a>
7970: 20 4c a8                           jsr     $a84c
7973: 20 1e 60                           jsr     <a href="#SymGAME2_read_playfield">GAME2_read_playfield</a>
7976: a9 15                              lda     #$15
7978: 85 19                              sta     <a href="#SymplayerX">playerX</a>
797a: a9 0f                              lda     #$0f
797c: 85 1a                              sta     <a href="#SymplayerY">playerY</a>
797e: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7981: 01                                 .dd1    $01
7982: d9 cf d5 a0+                       .str    YOU WERE KIDNAPPED BY THE FOLLOWERS     OF D'OL SALAAT
79b8: ff                                 .dd1    $ff
79b9: 4c 03 6b     @cont                 jmp     <a href="#SymGAME2_draw_player">GAME2_draw_player</a>

79bc: a9 3b        <a name="Symkidnapped_by_nekom">kidnapped_by_nekom</a>    lda     #$3b
79be: 85 1b                              sta     <a href="#SymMAPPOS">MAPPOS</a>
79c0: a9 00                              lda     #$00
79c2: 85 1c                              sta     <a href="#SymMAPHALF">MAPHALF</a>
79c4: a9 01                              lda     #$01
79c6: 85 67                              sta     <a href="#SymINSIDE">INSIDE</a>
79c8: 20 4c a8                           jsr     $a84c
79cb: 20 1e 60                           jsr     <a href="#SymGAME2_read_playfield">GAME2_read_playfield</a>
79ce: a9 13                              lda     #$13
79d0: 85 19                              sta     <a href="#SymplayerX">playerX</a>
79d2: a9 0f                              lda     #$0f
79d4: 85 1a                              sta     <a href="#SymplayerY">playerY</a>
79d6: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
79d9: 01                                 .dd1    $01
79da: d9 cf d5 a0+                       .str    YOU WERE KIDNAPPED BY THE NEKOM
79f9: ff                                 .dd1    $ff
79fa: 4c b9 79                           jmp     @cont

79fd: a5 34        <a name="Symattacked">attacked</a>              lda     <a href="#Symtemp34_npctype">temp34_npctype</a>
79ff: c9 e0                              cmp     #$e0                    ;E0 = kidnapped by salaat
7a01: d0 0a                              bne     @salaat_attack
7a03: 20 64 79                           jsr     <a href="#Symkidnapped_by_salaat">kidnapped_by_salaat</a>
7a06: a9 00        @finish_attack        lda     #$00
7a08: 85 34                              sta     <a href="#Symtemp34_npctype">temp34_npctype</a>
7a0a: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

7a0d: c9 e1        @salaat_attack        cmp     #$e1                    ;E1 = D'OL SALAAT attack
7a0f: d0 50                              bne     @nekom_kidnap
7a11: 20 1b 60                           jsr     <a href="#SymGAME2_teleport_home">GAME2_teleport_home</a>
7a14: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7a17: 01                                 .dd1    $01
7a18: d9 cf d5 a0+                       .str    YOU WERE ATTACKED BY A FOLLOWER OF      D'OL SALAAT. TIME HAS
                                          +       PASSED.
7a5d: ff                                 .dd1    $ff
7a5e: 4c 06 7a                           jmp     @finish_attack

7a61: c9 e2        @nekom_kidnap         cmp     #$e2                    ;E2 = kidnapped by nekom
7a63: d0 06                              bne     @nekom_attack
7a65: 20 bc 79                           jsr     <a href="#Symkidnapped_by_nekom">kidnapped_by_nekom</a>
7a68: 4c 06 7a                           jmp     @finish_attack

7a6b: 20 1b 60     @nekom_attack         jsr     <a href="#SymGAME2_teleport_home">GAME2_teleport_home</a>     ;otherwise (E3..EF?) = NEKOM attack
7a6e: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7a71: 01                                 .dd1    $01
7a72: d9 cf d5 a0+                       .str    YOU WERE ATTACKED BY A MEMBER OF THE    NEKOM. TIME HAS PASSE
                                          +      D.
7ab1: ff                                 .dd1    $ff
7ab2: 4c 06 7a                           jmp     @finish_attack

7ab5: 20 06 60     <a name="SymL7AB5">L7AB5</a>                 jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
7ab8: a5 67                              lda     <a href="#SymINSIDE">INSIDE</a>
7aba: d0 03                              bne     <a href="#SymL7ABF">L7ABF</a>
7abc: 4c c7 7b                           jmp     <a href="#Symno_nid_here">no_nid_here</a>

7abf: a5 e6        <a name="SymL7ABF">L7ABF</a>                 lda     <a href="#SymtileKnee">tileKnee</a>
7ac1: c9 3c                              cmp     #$3c
7ac3: f0 03                              beq     <a href="#SymL7AC8">L7AC8</a>
7ac5: 4c c7 7b                           jmp     <a href="#Symno_nid_here">no_nid_here</a>

7ac8: a5 1b        <a name="SymL7AC8">L7AC8</a>                 lda     <a href="#SymMAPPOS">MAPPOS</a>
7aca: c9 09                              cmp     #$09
7acc: d0 04                              bne     <a href="#SymL7AD2">L7AD2</a>
7ace: a5 1c                              lda     <a href="#SymMAPHALF">MAPHALF</a>
7ad0: f0 37                              beq     <a href="#SymL7B09">L7B09</a>
7ad2: a5 1b        <a name="SymL7AD2">L7AD2</a>                 lda     <a href="#SymMAPPOS">MAPPOS</a>
7ad4: c5 2d                              cmp     <a href="#SymhomePos">homePos</a>
7ad6: d0 06                              bne     <a href="#SymL7ADE">L7ADE</a>
7ad8: a5 1c                              lda     <a href="#SymMAPHALF">MAPHALF</a>
7ada: c5 2e                              cmp     <a href="#SymhomeHalf">homeHalf</a>
7adc: f0 2b                              beq     <a href="#SymL7B09">L7B09</a>
7ade: a5 37        <a name="SymL7ADE">L7ADE</a>                 lda     <a href="#SymspokeTo">spokeTo</a>
7ae0: f0 07                              beq     <a href="#SymL7AE9">L7AE9</a>
7ae2: ad f0 02                           lda     <a href="#SymRWTSBUF">RWTSBUF</a>+240
7ae5: c9 10                              cmp     #$10
7ae7: f0 20                              beq     <a href="#SymL7B09">L7B09</a>
7ae9: 20 0c 60     <a name="SymL7AE9">L7AE9</a>                 jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7aec: 01                                 .dd1    $01
7aed: ce cf a0 cf+                       .str    NO ONE OFFERED YOU A NID
7b05: ff                                 .dd1    $ff
7b06: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

7b09: e6 19        <a name="SymL7B09">L7B09</a>                 inc     <a href="#SymplayerX">playerX</a>
7b0b: 20 0f 6b                           jsr     <a href="#SymGAME2_adjacent_tiles">GAME2_adjacent_tiles</a>
7b0e: a5 e6                              lda     <a href="#SymtileKnee">tileKnee</a>
7b10: c9 3d                              cmp     #$3d
7b12: d0 f5                              bne     <a href="#SymL7B09">L7B09</a>
7b14: c6 19                              dec     <a href="#SymplayerX">playerX</a>
7b16: a2 2e                              ldx     #$2e
7b18: 86 a3                              stx     <a href="#SymanimFrame">animFrame</a>
7b1a: e8                                 inx
7b1b: 86 a4                              stx     <a href="#SymanimFrame_unused">animFrame_unused</a>
7b1d: 20 0c 6b                           jsr     <a href="#SymGAME2_redraw_player">GAME2_redraw_player</a>
7b20: 4c 7d 7b                           jmp     <a href="#Symsleep_loop">sleep_loop</a>

7b23: 20 75 84     <a name="SymL7B23">L7B23</a>                 jsr     <a href="#Symnext_time_period">next_time_period</a>
7b26: a9 04                              lda     #$04
7b28: 18                                 clc
7b29: 65 25                              adc     <a href="#SymlevelRest">levelRest</a>
7b2b: 85 25                              sta     <a href="#SymlevelRest">levelRest</a>
7b2d: c5 2b                              cmp     <a href="#SymlimitRest">limitRest</a>
7b2f: 90 05                              bcc     <a href="#SymL7B36">L7B36</a>
7b31: a6 2b                              ldx     <a href="#SymlimitRest">limitRest</a>               ;cap level of rest
7b33: ca                                 dex
7b34: 86 25                              stx     <a href="#SymlevelRest">levelRest</a>
7b36: a5 1c        <a name="SymL7B36">L7B36</a>                 lda     <a href="#SymMAPHALF">MAPHALF</a>
7b38: d0 0a                              bne     <a href="#SymL7B44">L7B44</a>
7b3a: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>
7b3c: c9 09                              cmp     #$09
7b3e: d0 04                              bne     <a href="#SymL7B44">L7B44</a>
7b40: a9 01                              lda     #$01
7b42: 85 35                              sta     <a href="#SymdoorNeshom">doorNeshom</a>
7b44: ae f1 02     <a name="SymL7B44">L7B44</a>                 ldx     <a href="#SymRWTSBUF_npcnum">RWTSBUF_npcnum</a>
7b47: bd 00 b2                           lda     <a href="#Symstate_npc1">state_npc1</a>,x
7b4a: d0 31                              bne     <a href="#Symsleep_loop">sleep_loop</a>
7b4c: ad f2 02                           lda     <a href="#SymRWTSBUF_npctype">RWTSBUF_npctype</a>
                   <span style="background-color: #cbcb00">NOTE: Handle sleeping in NPC $20..$23 nid</span>
7b4f: c9 20                              cmp     #$20
7b51: d0 06                              bne     <a href="#SymL7B59">L7B59</a>
7b53: 20 34 79                           jsr     <a href="#SymL7934">L7934</a>
7b56: 4c 7d 7b                           jmp     <a href="#Symsleep_loop">sleep_loop</a>

7b59: c9 22        <a name="SymL7B59">L7B59</a>                 cmp     #$22
7b5b: d0 06                              bne     <a href="#SymL7B63">L7B63</a>
7b5d: 20 4c 79                           jsr     <a href="#SymL794C">L794C</a>
7b60: 4c 7d 7b                           jmp     <a href="#Symsleep_loop">sleep_loop</a>

7b63: c9 21        <a name="SymL7B63">L7B63</a>                 cmp     #$21
7b65: d0 09                              bne     <a href="#SymL7B70">L7B70</a>
7b67: 20 06 60                           jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
7b6a: 20 64 79                           jsr     <a href="#Symkidnapped_by_salaat">kidnapped_by_salaat</a>
7b6d: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

7b70: c9 23        <a name="SymL7B70">L7B70</a>                 cmp     #$23
7b72: d0 09                              bne     <a href="#Symsleep_loop">sleep_loop</a>
7b74: 20 06 60                           jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
7b77: 20 bc 79                           jsr     <a href="#Symkidnapped_by_nekom">kidnapped_by_nekom</a>
7b7a: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

                   ; Looks like this does the sleeping loop, which goes tick-tock 3 times and then
                   ; boop. Any input during this loop terminates it and returns to caller.
7b7d: 20 d6 82     <a name="Symsleep_loop">sleep_loop</a>            jsr     <a href="#Symdisplay_status">display_status</a>
7b80: 20 f2 7f                           jsr     <a href="#Symawait_button_up">await_button_up</a>
7b83: 20 a9 7b                           jsr     @terminate_on_input
7b86: 20 a9 7b                           jsr     @terminate_on_input
7b89: a9 03                              lda     #$03                    ;thrice
7b8b: 85 79                              sta     <a href="#Symtemp79">temp79</a>
7b8d: a2 0d        @loop                 ldx     #$0d                    ;tick
7b8f: 20 03 b6                           jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>
7b92: 20 a9 7b                           jsr     @terminate_on_input
7b95: a2 00                              ldx     #$00                    ;tock
7b97: 20 03 b6                           jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>
7b9a: 20 a9 7b                           jsr     @terminate_on_input
7b9d: c6 79                              dec     <a href="#Symtemp79">temp79</a>
7b9f: d0 ec                              bne     @loop
7ba1: a2 01                              ldx     #$01                    ;boop
7ba3: 20 03 b6                           jsr     <a href="#SymSCRN_play_sound">SCRN_play_sound</a>
7ba6: 4c 23 7b                           jmp     <a href="#SymL7B23">L7B23</a>

                   ; Read joystick (keyboard) input up to $15 times (effects a constant delay if no
                   ; input). If any input occurred, terminate the calling subroutine.
7ba9: a9 15        @terminate_on_input   lda     #$15
7bab: 85 08                              sta     <a href="#Symtemp08">temp08</a>
7bad: 20 2a 6b     @loop                 jsr     <a href="#SymGAME2_menu_input">GAME2_menu_input</a>
7bb0: d0 09                              bne     @got_input
7bb2: a5 a2                              lda     <a href="#SymMOVING">MOVING</a>
7bb4: d0 05                              bne     @got_input
7bb6: c6 08                              dec     <a href="#Symtemp08">temp08</a>
7bb8: d0 f3                              bne     @loop                   ;try $15 times
7bba: 60                                 rts

7bbb: 68           @got_input            pla                             ;discard caller
7bbc: 68                                 pla
7bbd: 20 06 60                           jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
7bc0: 20 21 6b                           jsr     <a href="#SymL6B21">L6B21</a>
7bc3: 20 f2 7f                           jsr     <a href="#Symawait_button_up">await_button_up</a>
7bc6: 60                                 rts

7bc7: 20 06 60     <a name="Symno_nid_here">no_nid_here</a>           jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
7bca: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7bcd: 29                                 .dd1    $29
7bce: d4 c8 c5 d2+                       .str    THERE IS NO NID HERE
7be2: ff                                 .dd1    $ff
7be3: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

7be6: 20 06 60     <a name="Symtake">take</a>                  jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
7be9: 20 b5 81                           jsr     <a href="#Symitem_of_interest">item_of_interest</a>
7bec: 90 03                              bcc     <a href="#Symtake_item">take_item</a>
7bee: 4c 88 7c                           jmp     <a href="#Symnothing_to_take">nothing_to_take</a>

7bf1: 20 c0 7f     <a name="Symtake_item">take_item</a>             jsr     <a href="#Symslot_to_item">slot_to_item</a>            ;A=slot -&gt; Y=item
7bf4: c0 0d                              cpy     #<a href="#Symitem_fallaKey">item_fallaKey</a>
7bf6: d0 04                              bne     @std_item
7bf8: a5 38                              lda     <a href="#SymfallaKeyOffered">fallaKeyOffered</a>
7bfa: d0 4c                              bne     <a href="#Symtake_legally">take_legally</a>            ;otherwise fall thru, should fail
7bfc: a5 67        @std_item             lda     <a href="#SymINSIDE">INSIDE</a>
7bfe: f0 48                              beq     <a href="#Symtake_legally">take_legally</a>
7c00: a5 c4                              lda     <a href="#SymDEMOFLG">DEMOFLG</a>
7c02: d0 44                              bne     <a href="#Symtake_legally">take_legally</a>            ;anything can be taken during the demo
7c04: a5 1c                              lda     <a href="#SymMAPHALF">MAPHALF</a>
7c06: d0 16                              bne     @side1
7c08: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>
7c0a: c5 2d                              cmp     <a href="#SymhomePos">homePos</a>
7c0c: f0 3a                              beq     <a href="#Symtake_legally">take_legally</a>            ;anything in your house is fair game
7c0e: c9 1c                              cmp     #$1c                    ;or in room 1c, 3b, 4b or 51
7c10: f0 36                              beq     <a href="#Symtake_legally">take_legally</a>
7c12: c9 3b                              cmp     #$3b
7c14: f0 32                              beq     <a href="#Symtake_legally">take_legally</a>
7c16: c9 4b                              cmp     #$4b
7c18: f0 2e                              beq     <a href="#Symtake_legally">take_legally</a>
7c1a: c9 51                              cmp     #$51
7c1c: f0 2a                              beq     <a href="#Symtake_legally">take_legally</a>
7c1e: a5 37        @side1                lda     <a href="#SymspokeTo">spokeTo</a>
7c20: f0 05                              beq     <a href="#Symnot_offered">not_offered</a>
7c22: cc f0 02                           cpy     <a href="#SymRWTSBUF">RWTSBUF</a>+240
7c25: f0 21                              beq     <a href="#Symtake_legally">take_legally</a>
7c27: 20 0c 60     <a name="Symnot_offered">not_offered</a>           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7c2a: 01                                 .dd1    $01
7c2b: c9 d4 a0 d7+                       .str    IT WAS NOT OFFERED TO YOU
7c44: ff                                 .dd1    $ff
7c45: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

7c48: b9 c1 7c     <a name="Symtake_legally">take_legally</a>          lda     <a href="#Symitem_weights">item_weights</a>,y          ;can we carry this?
7c4b: 18                                 clc
7c4c: 65 70                              adc     <a href="#SymWEIGHT">WEIGHT</a>
7c4e: c5 2c                              cmp     <a href="#SymmaxWeight">maxWeight</a>
7c50: b0 52                              bcs     <a href="#Symcarry_no_more">carry_no_more</a>           ;too heavy!
7c52: 85 70                              sta     <a href="#SymWEIGHT">WEIGHT</a>
7c54: bd 00 b5                           lda     <a href="#SymitemState">itemState</a>,x
7c57: 09 20                              ora     #%00100000              ;set bit 5 of inv slot -- item possession
7c59: 9d 00 b5                           sta     <a href="#SymitemState">itemState</a>,x
7c5c: 84 77                              sty     <a href="#SymselItemSlot">selItemSlot</a>
7c5e: 98                                 tya
7c5f: 20 51 7e                           jsr     <a href="#SymL7E51">L7E51</a>
7c62: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7c65: 29                                 .dd1    $29
7c66: d9 cf d5 a0+                       .str    YOU FIND
7c6e: ff                                 .dd1    $ff
7c6f: a4 77                              ldy     <a href="#SymselItemSlot">selItemSlot</a>
7c71: a9 32                              lda     #$32
7c73: 85 64                              sta     <a href="#SymHTAB">HTAB</a>
7c75: 20 a2 7e                           jsr     <a href="#Symprint_item_desc">print_item_desc</a>
7c78: a9 00                              lda     #$00
7c7a: 85 37                              sta     <a href="#SymspokeTo">spokeTo</a>
7c7c: a5 77                              lda     <a href="#SymselItemSlot">selItemSlot</a>
7c7e: c9 01                              cmp     #<a href="#Symitem_spiritLamp">item_spiritLamp</a>
7c80: d0 03                              bne     <a href="#SymL7C85">L7C85</a>
7c82: 20 4b 60                           jsr     <a href="#SymL604B">L604B</a>
7c85: 4c e3 7f     <a name="SymL7C85">L7C85</a>                 jmp     <a href="#Symmessage_wait">message_wait</a>

7c88: 20 0c 60     <a name="Symnothing_to_take">nothing_to_take</a>       jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7c8b: 29                                 .dd1    $29
7c8c: ce cf d4 c8+                       .str    NOTHING HERE TO TAKE
7ca0: ff                                 .dd1    $ff
7ca1: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

7ca4: 20 0c 60     <a name="Symcarry_no_more">carry_no_more</a>         jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7ca7: 29                                 .dd1    $29
7ca8: d9 cf d5 a0+                       .str    YOU CAN CARRY NO MORE
7cbd: ff                                 .dd1    $ff
7cbe: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

                   ; Item weight table. Everything weighs 5 units except for tokens (1).
7cc1: 05           <a name="Symitem_weights">item_weights</a>          .dd1    $05                     ;0 spirit bell
7cc2: 05                                 .dd1    $05
7cc3: 05                                 .dd1    $05
7cc4: 05                                 .dd1    $05
7cc5: 05                                 .dd1    $05
7cc6: 05                                 .dd1    $05
7cc7: 05                                 .dd1    $05
7cc8: 05                                 .dd1    $05
7cc9: 01                                 .dd1    $01                     ;8 token
7cca: 05                                 .dd1    $05
7ccb: 05                                 .dd1    $05
7ccc: 05                                 .dd1    $05
7ccd: 05                                 .dd1    $05
7cce: 05                                 .dd1    $05
7ccf: 05                                 .dd1    $05                     ;14 strange elixer

7cd0: 20 06 60     <a name="SymL7CD0">L7CD0</a>                 jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
7cd3: a5 19                              lda     <a href="#SymplayerX">playerX</a>
7cd5: f0 04                              beq     <a href="#SymL7CDB">L7CDB</a>
7cd7: c9 27                              cmp     #$27
7cd9: d0 03                              bne     <a href="#SymL7CDE">L7CDE</a>
7cdb: 4c 35 7e     <a name="SymL7CDB">L7CDB</a>                 jmp     <a href="#SymL7E35">L7E35</a>

7cde: a5 67        <a name="SymL7CDE">L7CDE</a>                 lda     <a href="#SymINSIDE">INSIDE</a>
7ce0: a5 67                              lda     <a href="#SymINSIDE">INSIDE</a>                  ;??
7ce2: f0 42                              beq     <a href="#SymL7D26">L7D26</a>
7ce4: a5 2d                              lda     <a href="#SymhomePos">homePos</a>
7ce6: c5 1b                              cmp     <a href="#SymMAPPOS">MAPPOS</a>
7ce8: d0 06                              bne     <a href="#SymL7CF0">L7CF0</a>
7cea: a5 2e                              lda     <a href="#SymhomeHalf">homeHalf</a>
7cec: c5 1c                              cmp     <a href="#SymMAPHALF">MAPHALF</a>
7cee: f0 03                              beq     <a href="#SymL7CF3">L7CF3</a>
7cf0: 4c 35 7e     <a name="SymL7CF0">L7CF0</a>                 jmp     <a href="#SymL7E35">L7E35</a>

7cf3: a5 e6        <a name="SymL7CF3">L7CF3</a>                 lda     <a href="#SymtileKnee">tileKnee</a>
7cf5: c9 57                              cmp     #$57
7cf7: 90 2d                              bcc     <a href="#SymL7D26">L7D26</a>
7cf9: c9 59                              cmp     #$59
7cfb: b0 29                              bcs     <a href="#SymL7D26">L7D26</a>
7cfd: a5 e7                              lda     <a href="#SymtileArm">tileArm</a>
7cff: c9 e2                              cmp     #$e2
7d01: b0 23                              bcs     <a href="#SymL7D26">L7D26</a>
7d03: a5 95                              lda     <a href="#SymFACING">FACING</a>
7d05: 30 0b                              bmi     <a href="#SymL7D12">L7D12</a>
7d07: a5 ea                              lda     <a href="#SymtileArmRight">tileArmRight</a>
7d09: c9 e2                              cmp     #$e2
7d0b: b0 19                              bcs     <a href="#SymL7D26">L7D26</a>
7d0d: a6 19                              ldx     <a href="#SymplayerX">playerX</a>
7d0f: 4c 1b 7d                           jmp     <a href="#SymL7D1B">L7D1B</a>

7d12: a5 e9        <a name="SymL7D12">L7D12</a>                 lda     <a href="#SymtileArmLeft">tileArmLeft</a>
7d14: c9 e2                              cmp     #$e2
7d16: b0 0e                              bcs     <a href="#SymL7D26">L7D26</a>
7d18: a6 19                              ldx     <a href="#SymplayerX">playerX</a>
7d1a: ca                                 dex
7d1b: 86 75        <a name="SymL7D1B">L7D1B</a>                 stx     <a href="#Symtemp75">temp75</a>
7d1d: a6 1a                              ldx     <a href="#SymplayerY">playerY</a>
7d1f: ca                                 dex
7d20: ca                                 dex
7d21: 86 76                              stx     <a href="#Symtemp76">temp76</a>
7d23: 4c 6d 7d                           jmp     <a href="#Symwhat_will_you_drop">what_will_you_drop</a>

7d26: a5 e3        <a name="SymL7D26">L7D26</a>                 lda     <a href="#SymtileUnder">tileUnder</a>
7d28: c9 e0                              cmp     #$e0
7d2a: b0 3e                              bcs     <a href="#SymL7D6A">L7D6A</a>
7d2c: 20 12 6b                           jsr     <a href="#SymL6B12">L6B12</a>
7d2f: a5 f1                              lda     <a href="#SymxSolid">xSolid</a>
7d31: f0 37                              beq     <a href="#SymL7D6A">L7D6A</a>
7d33: a5 e0                              lda     <a href="#SymtileFeet">tileFeet</a>
7d35: c9 e2                              cmp     #$e2
7d37: b0 31                              bcs     <a href="#SymL7D6A">L7D6A</a>
7d39: a5 95                              lda     <a href="#SymFACING">FACING</a>
7d3b: 30 07                              bmi     <a href="#SymL7D44">L7D44</a>
7d3d: a5 e2                              lda     <a href="#SymtileFeetRight">tileFeetRight</a>
7d3f: a6 19                              ldx     <a href="#SymplayerX">playerX</a>
7d41: 4c 49 7d                           jmp     <a href="#SymL7D49">L7D49</a>

7d44: a5 e1        <a name="SymL7D44">L7D44</a>                 lda     <a href="#SymtileFeetLeft">tileFeetLeft</a>
7d46: a6 19                              ldx     <a href="#SymplayerX">playerX</a>
7d48: ca                                 dex
7d49: 86 75        <a name="SymL7D49">L7D49</a>                 stx     <a href="#Symtemp75">temp75</a>
7d4b: a6 1a                              ldx     <a href="#SymplayerY">playerY</a>
7d4d: 86 76                              stx     <a href="#Symtemp76">temp76</a>
7d4f: c9 e1                              cmp     #$e1
7d51: b0 17                              bcs     <a href="#SymL7D6A">L7D6A</a>
7d53: c9 07                              cmp     #$07
7d55: f0 13                              beq     <a href="#SymL7D6A">L7D6A</a>
7d57: c9 08                              cmp     #$08
7d59: f0 0f                              beq     <a href="#SymL7D6A">L7D6A</a>
7d5b: c9 52                              cmp     #$52
7d5d: f0 0b                              beq     <a href="#SymL7D6A">L7D6A</a>
7d5f: c9 1c                              cmp     #$1c
7d61: f0 07                              beq     <a href="#SymL7D6A">L7D6A</a>
7d63: 20 12 6b                           jsr     <a href="#SymL6B12">L6B12</a>
7d66: a5 f1                              lda     <a href="#SymxSolid">xSolid</a>
7d68: f0 03                              beq     <a href="#Symwhat_will_you_drop">what_will_you_drop</a>
7d6a: 4c 35 7e     <a name="SymL7D6A">L7D6A</a>                 jmp     <a href="#SymL7E35">L7E35</a>

7d6d: 20 0c 60     <a name="Symwhat_will_you_drop">what_will_you_drop</a>    jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7d70: 29                                 .dd1    $29
7d71: d7 c8 c1 d4+                       .str    WHAT WILL YOU DROP?
7d84: ff                                 .dd1    $ff
7d85: a9 ff                              lda     #$ff                    ;iterate through all slots
7d87: 85 77                              sta     <a href="#SymselItemSlot">selItemSlot</a>             ;holds current slot index
7d89: 85 39                              sta     <a href="#SymsuppressSound0">suppressSound0</a>
7d8b: 20 f2 7f                           jsr     <a href="#Symawait_button_up">await_button_up</a>
7d8e: e6 77        @next_slot            inc     <a href="#SymselItemSlot">selItemSlot</a>
7d90: a6 77                              ldx     <a href="#SymselItemSlot">selItemSlot</a>
7d92: e0 ff                              cpx     #$ff                    ;0-fe items, ff=nothing
7d94: d0 18                              bne     @valid_slot
7d96: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7d99: 3e                                 .dd1    $3e
7d9a: ce cf d4 c8+                       .str    NOTHING         
7daa: ff                                 .dd1    $ff
7dab: 4c c1 7d                           jmp     <a href="#SymL7DC1">L7DC1</a>

7dae: bd 00 b5     @valid_slot           lda     <a href="#SymitemState">itemState</a>,x
7db1: 2c bd 1d                           bit     <a href="#SymGAME1_BITTAB5">GAME1_BITTAB5</a>           ;do we have an item in this slot
7db4: f0 d8                              beq     @next_slot
7db6: 8a                                 txa                             ;yes
7db7: 20 c0 7f                           jsr     <a href="#Symslot_to_item">slot_to_item</a>            ;get item in Y
7dba: a9 3e                              lda     #$3e
7dbc: 85 64                              sta     <a href="#SymHTAB">HTAB</a>
7dbe: 20 a2 7e                           jsr     <a href="#Symprint_item_desc">print_item_desc</a>
7dc1: 20 06 b6     <a name="SymL7DC1">L7DC1</a>                 jsr     <a href="#SymSCRN_play_sound_0">SCRN_play_sound_0</a>
7dc4: 20 2a 6b     <a name="SymL7DC4">L7DC4</a>                 jsr     <a href="#SymGAME2_menu_input">GAME2_menu_input</a>
7dc7: d0 07                              bne     <a href="#SymL7DD0">L7DD0</a>
7dc9: a5 86                              lda     <a href="#SymYDIR">YDIR</a>
7dcb: 10 f7                              bpl     <a href="#SymL7DC4">L7DC4</a>
7dcd: 4c 8e 7d                           jmp     @next_slot

7dd0: 20 06 60     <a name="SymL7DD0">L7DD0</a>                 jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
7dd3: a6 77                              ldx     <a href="#SymselItemSlot">selItemSlot</a>
7dd5: e0 ff                              cpx     #$ff                    ;nothing
7dd7: f0 5b                              beq     @rts
7dd9: a5 1b                              lda     <a href="#SymMAPPOS">MAPPOS</a>
7ddb: 9d 00 b3                           sta     <a href="#SymitemStatePos">itemStatePos</a>,x
7dde: a5 75                              lda     <a href="#Symtemp75">temp75</a>
7de0: 9d 00 b4                           sta     <a href="#SymitemStateCol">itemStateCol</a>,x
7de3: a5 76                              lda     <a href="#Symtemp76">temp76</a>
7de5: a4 1c                              ldy     <a href="#SymMAPHALF">MAPHALF</a>
7de7: f0 02                              beq     <a href="#SymL7DEB">L7DEB</a>
7de9: 09 80                              ora     #$80
7deb: 09 40        <a name="SymL7DEB">L7DEB</a>                 ora     #$40
7ded: 9d 00 b5                           sta     <a href="#SymitemState">itemState</a>,x
7df0: 20 51 7e                           jsr     <a href="#SymL7E51">L7E51</a>
7df3: a6 77                              ldx     <a href="#SymselItemSlot">selItemSlot</a>
7df5: a5 3a                              lda     <a href="#SymlitLamp">litLamp</a>
7df7: f0 2a                              beq     <a href="#SymL7E23">L7E23</a>
7df9: e4 3a                              cpx     <a href="#SymlitLamp">litLamp</a>
7dfb: d0 26                              bne     <a href="#SymL7E23">L7E23</a>
7dfd: a9 00                              lda     #$00
7dff: 9d 00 b5                           sta     <a href="#SymitemState">itemState</a>,x
7e02: 85 3a                              sta     <a href="#SymlitLamp">litLamp</a>
7e04: 85 3b                              sta     <a href="#SymMON_PCH">MON_PCH</a>
7e06: 20 29 7e                           jsr     <a href="#SymL7E29">L7E29</a>
7e09: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7e0c: 01                                 .dd1    $01
7e0d: d9 cf d5 d2+                       .str    YOUR LAMP VANISHES
7e1f: ff                                 .dd1    $ff
7e20: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

7e23: a5 77        <a name="SymL7E23">L7E23</a>                 lda     <a href="#SymselItemSlot">selItemSlot</a>
7e25: c9 01                              cmp     #$01
7e27: d0 03                              bne     <a href="#SymL7E2C">L7E2C</a>
7e29: 20 4b 60     <a name="SymL7E29">L7E29</a>                 jsr     <a href="#SymL604B">L604B</a>
7e2c: a5 77        <a name="SymL7E2C">L7E2C</a>                 lda     <a href="#SymselItemSlot">selItemSlot</a>
7e2e: 20 c0 7f                           jsr     <a href="#Symslot_to_item">slot_to_item</a>
7e31: 20 48 7e                           jsr     <a href="#Symlose_weight">lose_weight</a>
7e34: 60           @rts                  rts

7e35: 20 06 60     <a name="SymL7E35">L7E35</a>                 jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
7e38: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
7e3b: 29                                 .dd1    $29
7e3c: ce cf d4 a0+                       .str    NOT HERE
7e44: ff                                 .dd1    $ff
7e45: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

                   ; Subtracts weight of item (in Y) from current carry weight.
7e48: a5 70        <a name="Symlose_weight">lose_weight</a>           lda     <a href="#SymWEIGHT">WEIGHT</a>
7e4a: 38                                 sec
7e4b: f9 c1 7c                           sbc     <a href="#Symitem_weights">item_weights</a>,y
7e4e: 85 70                              sta     <a href="#SymWEIGHT">WEIGHT</a>
7e50: 60                                 rts

7e51: 8a           <a name="SymL7E51">L7E51</a>                 txa
7e52: 48                                 pha
7e53: 20 09 60                           jsr     <a href="#SymGAME2_write_tiles_to_text">GAME2_write_tiles_to_text</a>
7e56: 68                                 pla
7e57: aa                                 tax
7e58: bd 00 b5                           lda     <a href="#SymitemState">itemState</a>,x
7e5b: 29 1f                              and     #$1f
7e5d: 85 06                              sta     <a href="#SymTXTROW">TXTROW</a>
7e5f: bd 00 b4                           lda     <a href="#SymitemStateCol">itemStateCol</a>,x
7e62: 85 05                              sta     <a href="#SymTXTCOL">TXTCOL</a>
7e64: 20 90 7e                           jsr     <a href="#Symtxtpos_to_addr">txtpos_to_addr</a>
7e67: 8a                                 txa
7e68: 20 c0 7f                           jsr     <a href="#Symslot_to_item">slot_to_item</a>
7e6b: 84 08                              sty     <a href="#Symtemp08">temp08</a>
7e6d: 06 08                              asl     <a href="#Symtemp08">temp08</a>
7e6f: a9 fd                              lda     #$fd
7e71: 38                                 sec
7e72: e5 08                              sbc     <a href="#Symtemp08">temp08</a>
7e74: a0 00                              ldy     #$00
7e76: b1 11                              lda     (<a href="#Symtemp11_textlo">temp11_textlo</a>),y
7e78: 20 03 60                           jsr     <a href="#SymGAME2_drawtile">GAME2_drawtile</a>
7e7b: e6 05                              inc     <a href="#SymTXTCOL">TXTCOL</a>
7e7d: e6 11                              inc     <a href="#Symtemp11_textlo">temp11_textlo</a>
7e7f: d0 02                              bne     <a href="#SymL7E83">L7E83</a>
7e81: e6 12                              inc     <a href="#Symtemp12_texthi">temp12_texthi</a>
7e83: a0 00        <a name="SymL7E83">L7E83</a>                 ldy     #$00
7e85: b1 11                              lda     (<a href="#Symtemp11_textlo">temp11_textlo</a>),y
7e87: 20 03 60                           jsr     <a href="#SymGAME2_drawtile">GAME2_drawtile</a>
7e8a: 20 03 6b                           jsr     <a href="#SymGAME2_draw_player">GAME2_draw_player</a>
7e8d: 4c 15 6b                           jmp     <a href="#SymL6B15">L6B15</a>

                   ; Convert the text position in (TXTCOL,TXTROW) to a text page address and store
                   ; it in $11/12. Clobbers A,Y but preserves X.
7e90: a4 06        <a name="Symtxtpos_to_addr">txtpos_to_addr</a>        ldy     <a href="#SymTXTROW">TXTROW</a>
7e92: b9 a0 1d                           lda     <a href="#SymGAME1_textlo">GAME1_textlo</a>,y
7e95: 18                                 clc
7e96: 65 05                              adc     <a href="#SymTXTCOL">TXTCOL</a>
7e98: 85 11                              sta     <a href="#Symtemp11_textlo">temp11_textlo</a>
7e9a: b9 80 1d                           lda     <a href="#SymGAME1_texthi">GAME1_texthi</a>,y
7e9d: 69 00                              adc     #$00
7e9f: 85 12                              sta     <a href="#Symtemp12_texthi">temp12_texthi</a>
7ea1: 60                                 rts

7ea2: be b0 7f     <a name="Symprint_item_desc">print_item_desc</a>       ldx     <a href="#Symitem_desc_idx">item_desc_idx</a>,y         ;item in Y
7ea5: 86 7a                              stx     <a href="#Symtemp7a">temp7a</a>                  ;item
7ea7: a9 10                              lda     #16                     ;length of item desc
7ea9: 85 7b                              sta     <a href="#Symtemp7b">temp7b</a>                  ;len
7eab: a6 7a        @printchar            ldx     <a href="#Symtemp7a">temp7a</a>
7ead: bd c0 7e                           lda     <a href="#Symitem_desc">item_desc</a>,x
7eb0: 20 0f 60                           jsr     <a href="#SymGAME2_printchar">GAME2_printchar</a>
7eb3: e6 7a                              inc     <a href="#Symtemp7a">temp7a</a>
7eb5: e6 64                              inc     <a href="#SymHTAB">HTAB</a>
7eb7: c6 7b                              dec     <a href="#Symtemp7b">temp7b</a>
7eb9: d0 f0                              bne     @printchar
7ebb: a9 00                              lda     #$00
7ebd: 85 66                              sta     <a href="#SymINVTEXT">INVTEXT</a>
7ebf: 60                                 rts

                   ; There are 15 possible items, with 16 description indices in this string (the
                   ; last not used). Each is 16 bytes long so the indices aren't really needed.
7ec0: c1 a0 d3 d0+ <a name="Symitem_desc">item_desc</a>             .str    A SPIRIT BELL   A SPIRIT LAMP   A HONEYLAMP     A WAND OF BEF
                                          +      AL A ROAST LAPAN   PAN BREAD       FRUIT &amp; NUTS    A SHUBA    
                                          +           A TOKEN         A TRENCHER BEAK WISSENBERRIES   A VINE RO
                                          +      PE     THE TEMPLE KEY  D'OL FALLA'S KEYA STRANGE ELIXER
7fb0: 00 10 20 30+ <a name="Symitem_desc_idx">item_desc_idx</a>         .bulk   00102030405060708090a0b0c0d0e0f0

                   ; Compute the item number (0-14) from the inventory slot ($00-$fe). Takes the
                   ; slot number in A, and sets Y to the index of the first byte in the item
                   ; address table that is less than that.
7fc0: a0 00        <a name="Symslot_to_item">slot_to_item</a>          ldy     #$00
7fc2: d9 d1 7f     @loop                 cmp     @item_slots,y
7fc5: 90 06                              bcc     @iny
7fc7: d9 d2 7f                           cmp     @item_slots+1,y
7fca: b0 01                              bcs     @iny
7fcc: 60                                 rts

7fcd: c8           @iny                  iny
7fce: d0 f2                              bne     @loop                   ;always--y&lt;16
7fd0: 60                                 rts

                   ; One pair of overlapping bytes for each of 15 items, or looked at another way,
                   ; one byte for the first slot address an item can be in.
7fd1: 00           @item_slots           .dd1    $00                     ;spirit bell ($00)
7fd2: 01                                 .dd1    $01                     ;spirit lamp ($01)
7fd3: 02                                 .dd1    $02                     ;honeylamp ($02-$1a)
7fd4: 1b                                 .dd1    $1b                     ;wand of befal ($1b)
7fd5: 1c                                 .dd1    $1c                     ;roast lapan ($1c-$25)
7fd6: 26                                 .dd1    $26                     ;pan bread ($26-$3e)
7fd7: 3f                                 .dd1    $3f                     ;fruit and nuts
7fd8: 58                                 .dd1    $58                     ;shuba
7fd9: 6c                                 .dd1    $6c                     ;token
7fda: b7                                 .dd1    $b7                     ;trencher beak
7fdb: d0                                 .dd1    $d0                     ;wissenberries
7fdc: da                                 .dd1    $da                     ;vine rope
7fdd: f8                                 .dd1    $f8                     ;temple key ($f8)
7fde: f9                                 .dd1    $f9                     ;d'ol falla's key ($f9)
7fdf: fa                                 .dd1    $fa                     ;elixer ($fa-$fe)
7fe0: ff                                 .dd1    $ff                     ;(terminator)
7fe1: e6                                 .dd1    $e6                     ;unused
7fe2: ff                                 .dd1    $ff                     ;unused

                   ; Called, for example, after selecting SOUND menu item, which displays a status
                   ; screen / message immediately, so wait for the select button to be released.
                   ; Then, loop until a button or direction is pressed, clear the screen, and
                   ; return.
7fe3: 20 f2 7f     <a name="Symmessage_wait">message_wait</a>          jsr     <a href="#Symawait_button_up">await_button_up</a>
7fe6: 20 2a 6b     @loop                 jsr     <a href="#SymGAME2_menu_input">GAME2_menu_input</a>
7fe9: d0 04                              bne     @ret
7feb: a5 a2                              lda     <a href="#SymMOVING">MOVING</a>
7fed: f0 f7                              beq     @loop                   ;if no direction pressed
7fef: 4c 06 60     @ret                  jmp     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>         ;and then rts

                   ; Loop until (menu select) button released (or at least not being pressed).
7ff2: 20 2a 6b     <a name="Symawait_button_up">await_button_up</a>       jsr     <a href="#SymGAME2_menu_input">GAME2_menu_input</a>
7ff5: d0 fb                              bne     <a href="#Symawait_button_up">await_button_up</a>
7ff7: a2 10                              ldx     #$10
7ff9: 4c 12 60                           jmp     <a href="#SymGAME2_delayXtimes256">GAME2_delayXtimes256</a>    ;and then rts

                   tempEatenFood         .var    $78    {addr/1}         ;which food was eaten

7ffc: 20 06 60     <a name="Symwhat_will_you_eat">what_will_you_eat</a>     jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
7fff: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
8002: 01                                 .dd1    $01
8003: d7 c8 c1 d4+                       .str    WHAT WILL YOU EAT?
8015: ff                                 .dd1    $ff
8016: a9 ff                              lda     #$ff
8018: 85 77                              sta     <a href="#SymselItemSlot">selItemSlot</a>
801a: 85 78                              sta     tempEatenFood
801c: 85 39                              sta     <a href="#SymsuppressSound0">suppressSound0</a>
801e: 20 f2 7f                           jsr     <a href="#Symawait_button_up">await_button_up</a>
8021: e6 77        <a name="SymL8021">L8021</a>                 inc     <a href="#SymselItemSlot">selItemSlot</a>
8023: a6 77                              ldx     <a href="#SymselItemSlot">selItemSlot</a>
8025: e0 ff                              cpx     #$ff
8027: d0 1a                              bne     <a href="#SymL8043">L8043</a>
8029: 86 78                              stx     tempEatenFood           ;temp, which food
802b: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
802e: 15                                 .dd1    $15
802f: ce cf d4 c8+                       .str    NOTHING         
803f: ff                                 .dd1    $ff
8040: 4c 70 80                           jmp     <a href="#SymL8070">L8070</a>

8043: bd 00 b5     <a name="SymL8043">L8043</a>                 lda     <a href="#SymitemState">itemState</a>,x
8046: 2c bd 1d                           bit     <a href="#SymGAME1_BITTAB5">GAME1_BITTAB5</a>
8049: f0 d6                              beq     <a href="#SymL8021">L8021</a>
804b: 8a                                 txa
804c: 20 c0 7f                           jsr     <a href="#Symslot_to_item">slot_to_item</a>
804f: c4 78                              cpy     tempEatenFood
8051: f0 ce                              beq     <a href="#SymL8021">L8021</a>
8053: c0 04                              cpy     #$04
8055: f0 10                              beq     <a href="#SymL8067">L8067</a>
8057: c0 05                              cpy     #$05
8059: f0 0c                              beq     <a href="#SymL8067">L8067</a>
805b: c0 06                              cpy     #$06
805d: f0 08                              beq     <a href="#SymL8067">L8067</a>
805f: c0 0a                              cpy     #$0a
8061: f0 04                              beq     <a href="#SymL8067">L8067</a>
8063: c0 0e                              cpy     #$0e
8065: d0 ba                              bne     <a href="#SymL8021">L8021</a>
8067: 84 78        <a name="SymL8067">L8067</a>                 sty     tempEatenFood
8069: a9 15                              lda     #$15
806b: 85 64                              sta     <a href="#SymHTAB">HTAB</a>
806d: 20 a2 7e                           jsr     <a href="#Symprint_item_desc">print_item_desc</a>
8070: 20 06 b6     <a name="SymL8070">L8070</a>                 jsr     <a href="#SymSCRN_play_sound_0">SCRN_play_sound_0</a>
8073: 20 2a 6b     <a name="SymL8073">L8073</a>                 jsr     <a href="#SymGAME2_menu_input">GAME2_menu_input</a>
8076: d0 07                              bne     <a href="#SymL807F">L807F</a>
8078: a5 86                              lda     <a href="#SymYDIR">YDIR</a>
807a: 10 f7                              bpl     <a href="#SymL8073">L8073</a>
807c: 4c 21 80                           jmp     <a href="#SymL8021">L8021</a>

807f: 20 06 60     <a name="SymL807F">L807F</a>                 jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
8082: a6 77                              ldx     <a href="#SymselItemSlot">selItemSlot</a>
8084: e0 ff                              cpx     #$ff
8086: d0 01                              bne     <a href="#SymL8089">L8089</a>
8088: 60                                 rts

8089: a4 78        <a name="SymL8089">L8089</a>                 ldy     tempEatenFood
808b: c0 04                              cpy     #$04
808d: d0 53                              bne     @is_pan_bread
808f: a5 20                              lda     <a href="#SymPLAYER">PLAYER</a>
8091: c9 02                              cmp     #<a href="#SymPLAYER_Herd">PLAYER_Herd</a>            ;only the 2 Erdling
8093: f0 34                              beq     @lapan_is_good
8095: c9 04                              cmp     #<a href="#SymPLAYER_Charn">PLAYER_Charn</a>           ;can eat lapan
8097: f0 30                              beq     @lapan_is_good
8099: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
809c: 01                                 .dd1    $01
809d: d4 c8 c5 a0+                       .str    THE LAPAN HAS A STRANGE TASTE
80ba: ff                                 .dd1    $ff
80bb: a5 23                              lda     <a href="#SymlevelSpirit">levelSpirit</a>
80bd: 38                                 sec
80be: e9 0f                              sbc     #$0f
80c0: b0 02                              bcs     <a href="#SymL80C4">L80C4</a>
80c2: a9 00                              lda     #$00
80c4: 85 23        <a name="SymL80C4">L80C4</a>                 sta     <a href="#SymlevelSpirit">levelSpirit</a>
80c6: 4c 25 81                           jmp     <a href="#Symsate_hunger">sate_hunger</a>

80c9: 20 0c 60     @lapan_is_good        jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
80cc: 01                                 .dd1    $01
80cd: d4 c8 c5 a0+                       .str    THE LAPAN IS GOOD
80de: ff                                 .dd1    $ff
80df: 4c 25 81                           jmp     <a href="#Symsate_hunger">sate_hunger</a>

80e2: c0 05        @is_pan_bread         cpy     #<a href="#Symitem_pan_bread">item_pan_bread</a>
80e4: d0 1d                              bne     @is_fruit_and_nuts
80e6: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
80e9: 01                                 .dd1    $01
80ea: d4 c8 c5 a0+                       .str    THE PAN BREAD IS GOOD
80ff: ff                                 .dd1    $ff
8100: 4c 25 81                           jmp     <a href="#Symsate_hunger">sate_hunger</a>

8103: c0 06        @is_fruit_and_nuts    cpy     #<a href="#Symitem_fruit_nuts">item_fruit_nuts</a>
8105: d0 31                              bne     @is_wissenberries
8107: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
810a: 01                                 .dd1    $01
810b: d4 c8 c5 a0+                       .str    THE FRUIT &amp; NUTS ARE GOOD
8124: ff                                 .dd1    $ff
8125: a9 05        <a name="Symsate_hunger">sate_hunger</a>           lda     #$05                    ;gain 5 food
8127: 18                                 clc
8128: 65 24                              adc     <a href="#SymlevelFood">levelFood</a>
812a: 85 24                              sta     <a href="#SymlevelFood">levelFood</a>
812c: c5 2a                              cmp     <a href="#SymlimitFood">limitFood</a>               ;cap at limit - 1
812e: 90 05                              bcc     @done
8130: a6 2a                              ldx     <a href="#SymlimitFood">limitFood</a>
8132: ca                                 dex
8133: 86 24                              stx     <a href="#SymlevelFood">levelFood</a>
8135: 4c a6 81     @done                 jmp     <a href="#SymL81A6">L81A6</a>

8138: c0 0a        @is_wissenberries     cpy     #<a href="#Symitem_berries">item_berries</a>
813a: d0 36                              bne     @strange_elixer
813c: 20 75 84                           jsr     <a href="#Symnext_time_period">next_time_period</a>        ;lose 2 time periods
813f: 20 75 84                           jsr     <a href="#Symnext_time_period">next_time_period</a>
8142: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
8145: 01                                 .dd1    $01
8146: d9 cf d5 a0+                       .str    YOU FEEL STRANGE. TIME PASSES
8163: ff                                 .dd1    $ff
8164: a5 23                              lda     <a href="#SymlevelSpirit">levelSpirit</a>
8166: 38                                 sec
8167: e9 0f                              sbc     #$0f                    ;lose 10 spirit
8169: b0 02                              bcs     @done
816b: a9 00                              lda     #$00                    ;floor
816d: 85 23        @done                 sta     <a href="#SymlevelSpirit">levelSpirit</a>
816f: 4c a6 81                           jmp     <a href="#SymL81A6">L81A6</a>

8172: 20 0c 60     @strange_elixer       jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
8175: 01                                 .dd1    $01
8176: d9 cf d5 a0+                       .str    YOU FEEL MUCH STRONGER
818c: ff                                 .dd1    $ff
818d: a5 26                              lda     <a href="#SymlevelStamina">levelStamina</a>
818f: 18                                 clc
8190: 69 05                              adc     #$05
8192: 85 26                              sta     <a href="#SymlevelStamina">levelStamina</a>
8194: 4a                                 lsr     A
8195: aa                                 tax
8196: 86 25                              stx     <a href="#SymlevelRest">levelRest</a>
8198: 86 24                              stx     <a href="#SymlevelFood">levelFood</a>
819a: e8                                 inx
819b: 86 2b                              stx     <a href="#SymlimitRest">limitRest</a>
819d: 86 2a                              stx     <a href="#SymlimitFood">limitFood</a>
819f: a5 2c                              lda     <a href="#SymmaxWeight">maxWeight</a>
81a1: 18                                 clc
81a2: 69 05                              adc     #$05
81a4: 85 2c                              sta     <a href="#SymmaxWeight">maxWeight</a>
81a6: a6 77        <a name="SymL81A6">L81A6</a>                 ldx     <a href="#SymselItemSlot">selItemSlot</a>
81a8: a9 00                              lda     #$00
81aa: 9d 00 b5                           sta     <a href="#SymitemState">itemState</a>,x
81ad: a4 78                              ldy     tempEatenFood
81af: 20 48 7e                           jsr     <a href="#Symlose_weight">lose_weight</a>
81b2: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

                   ; Check for item of interest at arm-level (take height) or at feet. Clears carry
                   ; and sets A to the item slot if so. Sets carry if no item of interest.
                    Clear variables

81b5: a5 e7        <a name="Symitem_of_interest">item_of_interest</a>      lda     <a href="#SymtileArm">tileArm</a>
81b7: c9 e0                              cmp     #$e0
81b9: 90 09                              bcc     <a href="#SymL81C4">L81C4</a>
81bb: a6 1a                              ldx     <a href="#SymplayerY">playerY</a>
81bd: ca                                 dex
81be: ca                                 dex
81bf: 86 65                              stx     $65
81c1: 4c d1 81                           jmp     <a href="#SymL81D1">L81D1</a>

81c4: a5 e0        <a name="SymL81C4">L81C4</a>                 lda     <a href="#SymtileFeet">tileFeet</a>
81c6: c9 e0                              cmp     #$e0
81c8: b0 03                              bcs     <a href="#SymL81CD">L81CD</a>
81ca: 4c 11 82                           jmp     <a href="#SymL8211">L8211</a>

81cd: a6 1a        <a name="SymL81CD">L81CD</a>                 ldx     <a href="#SymplayerY">playerY</a>
81cf: 86 65                              stx     $65
81d1: a6 19        <a name="SymL81D1">L81D1</a>                 ldx     <a href="#SymplayerX">playerX</a>
81d3: 2c b8 1d                           bit     <a href="#SymGAME1_BITTAB0">GAME1_BITTAB0</a>
81d6: d0 01                              bne     <a href="#SymL81D9">L81D9</a>
81d8: ca                                 dex
81d9: 86 08        <a name="SymL81D9">L81D9</a>                 stx     <a href="#Symtemp08">temp08</a>
81db: 85 79                              sta     <a href="#Symtemp79">temp79</a>                  ;never used!
81dd: a2 00        <a name="SymL81DD">L81DD</a>                 ldx     #$00
81df: bd 00 b3     <a name="SymL81DF">L81DF</a>                 lda     <a href="#SymitemStatePos">itemStatePos</a>,x
81e2: c5 1b                              cmp     <a href="#SymMAPPOS">MAPPOS</a>
81e4: d0 28                              bne     <a href="#SymL820E">L820E</a>
81e6: bd 00 b5                           lda     <a href="#SymitemState">itemState</a>,x
81e9: 0a                                 asl     A
81ea: a9 00                              lda     #$00
81ec: 2a                                 rol     A
81ed: c5 1c                              cmp     <a href="#SymMAPHALF">MAPHALF</a>
81ef: d0 1d                              bne     <a href="#SymL820E">L820E</a>
81f1: bd 00 b5                           lda     <a href="#SymitemState">itemState</a>,x
81f4: 2c be 1d                           bit     <a href="#SymGAME1_BITTAB6">GAME1_BITTAB6</a>
81f7: f0 15                              beq     <a href="#SymL820E">L820E</a>
81f9: 2c bd 1d                           bit     <a href="#SymGAME1_BITTAB5">GAME1_BITTAB5</a>
81fc: d0 10                              bne     <a href="#SymL820E">L820E</a>
81fe: 29 1f                              and     #$1f
8200: c5 65                              cmp     $65
8202: d0 0a                              bne     <a href="#SymL820E">L820E</a>
8204: bd 00 b4                           lda     <a href="#SymitemStateCol">itemStateCol</a>,x
8207: c5 08                              cmp     <a href="#Symtemp08">temp08</a>
8209: d0 03                              bne     <a href="#SymL820E">L820E</a>
820b: 8a                                 txa
820c: 18                                 clc
820d: 60                                 rts

820e: e8           <a name="SymL820E">L820E</a>                 inx
820f: d0 ce                              bne     <a href="#SymL81DF">L81DF</a>
8211: 38           <a name="SymL8211">L8211</a>                 sec
8212: 60                                 rts

8213: 20 06 60     <a name="Symexamine">examine</a>               jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
8216: 20 b5 81                           jsr     <a href="#Symitem_of_interest">item_of_interest</a>
8219: 90 29                              bcc     <a href="#Symit_looks_like">it_looks_like</a>
821b: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
821e: 01                                 .dd1    $01
821f: d4 c8 c5 d2+                       .str    THERE IS NOTHING OF INTEREST HERE
8240: ff                                 .dd1    $ff
8241: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

8244: 48           <a name="Symit_looks_like">it_looks_like</a>         pha
8245: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
8248: 01                                 .dd1    $01
8249: c9 d4 a0 cc+                       .str    IT LOOKS LIKE
8256: ff                                 .dd1    $ff
8257: 68                                 pla
8258: 20 c0 7f                           jsr     <a href="#Symslot_to_item">slot_to_item</a>
825b: a9 0f                              lda     #$0f
825d: 85 64                              sta     <a href="#SymHTAB">HTAB</a>
825f: 20 a2 7e                           jsr     <a href="#Symprint_item_desc">print_item_desc</a>
8262: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

8265: 20 06 60     <a name="Symdo_menu_inventory">do_menu_inventory</a>     jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
8268: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
826b: 01                                 .dd1    $01
826c: d9 cf d5 a0+                       .str    YOU HAVE
8274: ff                                 .dd1    $ff
8275: a9 ff                              lda     #$ff
8277: 85 77                              sta     <a href="#SymselItemSlot">selItemSlot</a>
8279: 85 78                              sta     <a href="#SymselItemNum">selItemNum</a>
827b: 85 39                              sta     <a href="#SymsuppressSound0">suppressSound0</a>          ;suppress beep for first item display
827d: e6 77        <a name="SymL827D">L827D</a>                 inc     <a href="#SymselItemSlot">selItemSlot</a>
827f: a6 77                              ldx     <a href="#SymselItemSlot">selItemSlot</a>
8281: e0 ff                              cpx     #$ff
8283: d0 17                              bne     <a href="#SymL829C">L829C</a>
8285: e4 78                              cpx     <a href="#SymselItemNum">selItemNum</a>
8287: d0 10                              bne     @done
8289: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
828c: 0a                                 .dd1    $0a
828d: ce cf d4 c8+                       .str    NOTHING 
8295: ff                                 .dd1    $ff
8296: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

8299: 4c 06 60     @done                 jmp     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>

829c: bd 00 b5     <a name="SymL829C">L829C</a>                 lda     <a href="#SymitemState">itemState</a>,x
829f: 2c bd 1d                           bit     <a href="#SymGAME1_BITTAB5">GAME1_BITTAB5</a>
82a2: f0 d9                              beq     <a href="#SymL827D">L827D</a>
82a4: a9 00                              lda     #$00
82a6: 85 78                              sta     <a href="#SymselItemNum">selItemNum</a>
82a8: 8a                                 txa
82a9: 20 c0 7f                           jsr     <a href="#Symslot_to_item">slot_to_item</a>
82ac: a9 0a                              lda     #$0a
82ae: 85 64                              sta     <a href="#SymHTAB">HTAB</a>
82b0: 20 a2 7e                           jsr     <a href="#Symprint_item_desc">print_item_desc</a>
82b3: 20 06 b6                           jsr     <a href="#SymSCRN_play_sound_0">SCRN_play_sound_0</a>
82b6: 20 2a 6b     <a name="SymL82B6">L82B6</a>                 jsr     <a href="#SymGAME2_menu_input">GAME2_menu_input</a>
82b9: d0 c2                              bne     <a href="#SymL827D">L827D</a>
82bb: a5 86                              lda     <a href="#SymYDIR">YDIR</a>
82bd: 30 be                              bmi     <a href="#SymL827D">L827D</a>
82bf: 10 f5                              bpl     <a href="#SymL82B6">L82B6</a>

                    Clear variables

82c1: 20 d3 82     <a name="Symdo_menu_status">do_menu_status</a>        jsr     @status
82c4: 20 f2 7f                           jsr     <a href="#Symawait_button_up">await_button_up</a>
82c7: 20 2a 6b     @loop                 jsr     <a href="#SymGAME2_menu_input">GAME2_menu_input</a>        ;await button or direction
82ca: d0 04                              bne     @ret
82cc: a5 a2                              lda     <a href="#SymMOVING">MOVING</a>
82ce: f0 f7                              beq     @loop
82d0: 4c 06 60     @ret                  jmp     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>

82d3: 20 06 60     @status               jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
82d6: 20 0c 60     <a name="Symdisplay_status">display_status</a>        jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
82d9: 01                                 .dd1    $01
82da: c4 c1 d9                           .str    DAY
82dd: ff                                 .dd1    $ff
82de: a6 20                              ldx     <a href="#SymPLAYER">PLAYER</a>
82e0: bd 94 83                           lda     <a href="#Symplayer_name_idx">player_name_idx</a>,x
82e3: 85 7b                              sta     <a href="#Symtemp7b">temp7b</a>
82e5: a9 18                              lda     #$18
82e7: 85 64                              sta     <a href="#SymHTAB">HTAB</a>
82e9: a4 7b        @loop1                ldy     <a href="#Symtemp7b">temp7b</a>
82eb: b9 d0 1a                           lda     <a href="#SymGAME1_player_names">GAME1_player_names</a>,y
82ee: 20 0f 60                           jsr     <a href="#SymGAME2_printchar">GAME2_printchar</a>
82f1: c6 7b                              dec     <a href="#Symtemp7b">temp7b</a>                  ;print name right-to-left
82f3: c6 64                              dec     <a href="#SymHTAB">HTAB</a>
82f5: a5 64                              lda     <a href="#SymHTAB">HTAB</a>
82f7: c9 13                              cmp     #$13                    ;each name is 5 chars -- use HTAB to track this
82f9: d0 ee                              bne     @loop1
82fb: a6 21                              ldx     <a href="#SymtimeOfDay">timeOfDay</a>
82fd: bd 17 84                           lda     <a href="#Symtime_of_day_idx">time_of_day_idx</a>,x
8300: 85 7b                              sta     <a href="#Symtemp7b">temp7b</a>
8302: a9 37                              lda     #$37
8304: 85 64                              sta     <a href="#SymHTAB">HTAB</a>
8306: a4 7b        @loop2                ldy     <a href="#Symtemp7b">temp7b</a>
8308: b9 99 83                           lda     <a href="#Symtime_of_day_str">time_of_day_str</a>,y
830b: 20 0f 60                           jsr     <a href="#SymGAME2_printchar">GAME2_printchar</a>
830e: c6 7b                              dec     <a href="#Symtemp7b">temp7b</a>
8310: c6 64                              dec     <a href="#SymHTAB">HTAB</a>
8312: a5 64                              lda     <a href="#SymHTAB">HTAB</a>
8314: c9 28                              cmp     #$28                    ;each time of day is 15 chars long
8316: d0 ee                              bne     @loop2
8318: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
831b: 3c                                 .dd1    $3c
831c: cc c5 d6 c5+                       .str    LEVEL OF REST
8329: ff                                 .dd1    $ff
832a: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
832d: 51                                 .dd1    $51
832e: d3 d0 c9 d2+                       .str    SPIRIT LIMIT
833a: ff                                 .dd1    $ff
833b: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
833e: 64                                 .dd1    $64
833f: cc c5 d6 c5+                       .str    LEVEL OF FOOD
834c: ff                                 .dd1    $ff
834d: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
8350: 79                                 .dd1    $79
8351: d3 d4 c1 cd+                       .str    STAMINA
8358: ff                                 .dd1    $ff
8359: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
835c: 8c                                 .dd1    $8c
835d: cc c5 d6 c5+                       .str    LEVEL OF SPIRIT
836c: ff                                 .dd1    $ff
836d: a9 05                              lda     #$05                    ;6 values, accessed in reverse order ($27..$22)
836f: 85 7b                              sta     <a href="#Symtemp7b">temp7b</a>
8371: a4 7b        @loop3                ldy     <a href="#Symtemp7b">temp7b</a>
8373: b6 22                              ldx     <a href="#SymdayNum">dayNum</a>,y                ;status values are sequential in zero page
8375: a0 00                              ldy     #$00
8377: 20 cc 84                           jsr     <a href="#Symnum_to_str">num_to_str</a>
837a: a4 7b                              ldy     <a href="#Symtemp7b">temp7b</a>
837c: b9 11 84                           lda     <a href="#Symstatus_digit_pos">status_digit_pos</a>,y      ;position to print each value
837f: 85 64                              sta     <a href="#SymHTAB">HTAB</a>
8381: a5 fc                              lda     <a href="#Symdigits">digits</a>+3                ;write the 2-digit, zero-padded value
8383: 20 0f 60                           jsr     <a href="#SymGAME2_printchar">GAME2_printchar</a>
8386: e6 64                              inc     <a href="#SymHTAB">HTAB</a>
8388: a5 fd                              lda     <a href="#Symdigits">digits</a>+4
838a: 20 0f 60                           jsr     <a href="#SymGAME2_printchar">GAME2_printchar</a>
838d: c6 7b                              dec     <a href="#Symtemp7b">temp7b</a>
838f: a5 7b                              lda     <a href="#Symtemp7b">temp7b</a>
8391: 10 de                              bpl     @loop3
8393: 60                                 rts

8394: 04           <a name="Symplayer_name_idx">player_name_idx</a>       .dd1    $04                     ;oddly, an index into player names at $1AD0
8395: 09                                 .dd1    $09                     ;(pointing to the last char of each)
8396: 0e                                 .dd1    $0e
8397: 13                                 .dd1    $13
8398: 18                                 .dd1    $18
8399: c5 c1 d2 cc+ <a name="Symtime_of_day_str">time_of_day_str</a>       .str    EARLY MORNING  
83a8: cc c1 d4 c5+                       .str    LATE MORNING   
83b7: c5 c1 d2 cc+                       .str    EARLY AFTERNOON
83c6: cc c1 d4 c5+                       .str    LATE AFTERNOON 
83d5: c5 c1 d2 cc+                       .str    EARLY EVENING  
83e4: cc c1 d4 c5+                       .str    LATE EVENING   
83f3: cd c9 c4 ce+                       .str    MIDNIGHT       
8402: cc c1 d4 c5+                       .str    LATE NIGHT     
8411: 05           <a name="Symstatus_digit_pos">status_digit_pos</a>      .dd1    $05                     ;positions for the 6 status numbers
8412: 9c                                 .dd1    $9c
8413: 74                                 .dd1    $74
8414: 4c                                 .dd1    $4c
8415: 81                                 .dd1    $81
8416: 5e                                 .dd1    $5e
8417: 0e           <a name="Symtime_of_day_idx">time_of_day_idx</a>       .dd1    $0e                     ;index into times of day
8418: 1d                                 .dd1    $1d                     ;(pointing to the last char of each)
8419: 2c                                 .dd1    $2c
841a: 3b                                 .dd1    $3b
841b: 4a                                 .dd1    $4a
841c: 59                                 .dd1    $59
841d: 68                                 .dd1    $68
841e: 77                                 .dd1    $77

841f: 20 06 60     <a name="Symrenew">renew</a>                 jsr     <a href="#SymGAME2_cleartext">GAME2_cleartext</a>
8422: 20 1b 60                           jsr     <a href="#SymGAME2_teleport_home">GAME2_teleport_home</a>
8425: 20 0c 60                           jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
8428: 29                                 .dd1    $29
8429: d9 cf d5 a0+                       .str    YOU WERE FOUND UNCONSCIOUS.
8444: ff                                 .dd1    $ff
8445: 20 4b 84                           jsr     <a href="#Symtime_has_passed">time_has_passed</a>
8448: 4c e3 7f                           jmp     <a href="#Symmessage_wait">message_wait</a>

844b: 20 0c 60     <a name="Symtime_has_passed">time_has_passed</a>       jsr     <a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a>
844e: 51                                 .dd1    $51
844f: d4 c9 cd c5+                       .str    TIME HAS PASSED.
845f: ff                                 .dd1    $ff
8460: 60                                 rts

                   ; There are 256 ticks per minute, $25 (or $23) minutes per period, and 8 periods
                   ; per day.
8461: a5 35        <a name="Symnext_tick">next_tick</a>             lda     <a href="#SymdoorNeshom">doorNeshom</a>              ;time does not pass automatically
8463: d0 04                              bne     @rts                    ;in the neshom realm
8465: c6 7c                              dec     <a href="#SymTICKS">TICKS</a>
8467: f0 01                              beq     <a href="#Symnext_minute">next_minute</a>
8469: 60           @rts                  rts

846a: c6 7d        <a name="Symnext_minute">next_minute</a>           dec     <a href="#SymMINUTES">MINUTES</a>
846c: d0 fb                              bne     @rts
846e: a9 25                              lda     #$25
8470: 85 7d                              sta     <a href="#SymMINUTES">MINUTES</a>
8472: 4c 75 84                           jmp     <a href="#Symnext_time_period">next_time_period</a>

                   ; Usually reached when game timer is running and minutes reaches 0. May also be
                   ; called when we are resting, or when passing out drunk.
8475: e6 21        <a name="Symnext_time_period">next_time_period</a>      inc     <a href="#SymtimeOfDay">timeOfDay</a>
8477: a5 21                              lda     <a href="#SymtimeOfDay">timeOfDay</a>
8479: c9 08                              cmp     #$08                    ;end of day?
847b: d0 06                              bne     <a href="#Symcheck_time_expired">check_time_expired</a>
847d: a9 00                              lda     #$00                    ;yes, go to next day
847f: 85 21                              sta     <a href="#SymtimeOfDay">timeOfDay</a>
8481: e6 22                              inc     <a href="#SymdayNum">dayNum</a>
8483: a5 22        <a name="Symcheck_time_expired">check_time_expired</a>    lda     <a href="#SymdayNum">dayNum</a>
8485: c9 33                              cmp     #$33                    ;game over on day 50
8487: 90 09                              bcc     <a href="#Symupdate_period_stats">update_period_stats</a>
8489: a9 00                              lda     #$00                    ;pause timer (permanently!)
848b: 85 87                              sta     <a href="#SymTICKING">TICKING</a>
848d: a9 01                              lda     #$01
848f: 85 3d                              sta     <a href="#SymGAMEOVER">GAMEOVER</a>                ;game over, man
8491: 60                                 rts

8492: c6 24        <a name="Symupdate_period_stats">update_period_stats</a>   dec     <a href="#SymlevelFood">levelFood</a>
8494: 10 10                              bpl     @has_food               ;branch if food left
8496: a9 00                              lda     #$00                    ;food floor is 0
8498: 85 24                              sta     <a href="#SymlevelFood">levelFood</a>
849a: a5 87                              lda     <a href="#SymTICKING">TICKING</a>                 ;don't starve if paused
849c: f0 08                              beq     @has_food               ;(paused when we are resting)
849e: a9 01                              lda     #$01
84a0: 85 3c                              sta     <a href="#SymSTARVED">STARVED</a>
84a2: a9 00                              lda     #$00                    ;pause timer
84a4: 85 87                              sta     <a href="#SymTICKING">TICKING</a>
84a6: c6 25        @has_food             dec     <a href="#SymlevelRest">levelRest</a>
84a8: 10 10                              bpl     <a href="#SymL84BA">L84BA</a>
84aa: a9 00                              lda     #$00                    ;rest floor is 0
84ac: 85 25                              sta     <a href="#SymlevelRest">levelRest</a>
84ae: a5 87                              lda     <a href="#SymTICKING">TICKING</a>
84b0: f0 08                              beq     <a href="#SymL84BA">L84BA</a>
84b2: a9 02                              lda     #$02
84b4: 85 3c                              sta     <a href="#SymSTARVED">STARVED</a>
84b6: a9 00                              lda     #$00
84b8: 85 87                              sta     <a href="#SymTICKING">TICKING</a>
84ba: a5 23        <a name="SymL84BA">L84BA</a>                 lda     <a href="#SymlevelSpirit">levelSpirit</a>             ;spirit increases by 5 every period
84bc: 18                                 clc
84bd: 69 05                              adc     #$05
84bf: c5 27                              cmp     <a href="#SymlimitSpirit">limitSpirit</a>
84c1: 90 02                              bcc     <a href="#SymL84C5">L84C5</a>
84c3: a5 27                              lda     <a href="#SymlimitSpirit">limitSpirit</a>             ;cap spirit at limit
84c5: 85 23        <a name="SymL84C5">L84C5</a>                 sta     <a href="#SymlevelSpirit">levelSpirit</a>
84c7: a9 23                              lda     #$23
84c9: 85 7d                              sta     <a href="#SymMINUTES">MINUTES</a>
84cb: 60                                 rts

                   ; Convert unsigned 16-bit value in (Y,X) to 5-digit string in $F9..$FD, left-
                   ; padded with zeroes. Uses standard 10s division algorithm, implemented via
                   ; subtraction on the 6502, of course.
                   ; 
                   ; ($7e/$7f are temps and only used in this subroutine.)
84cc: 86 7e        <a name="Symnum_to_str">num_to_str</a>            stx     <a href="#Symtemp7e">temp7e</a>
84ce: 84 7f                              sty     <a href="#Symtemp7f">temp7f</a>
84d0: a9 b0                              lda     #0 | $80              ;the digit 0
84d2: a2 06                              ldx     #$06                    ;#$05 would also work fine
84d4: 95 f8        @loop                 sta     <a href="#Symdigits">digits</a>-1,x              ;set $f9..$fe to #$b0 ($fe unused)
84d6: ca                                 dex
84d7: d0 fb                              bne     @loop
                   ; 16-bit subtract the highest decimal place's value from the total value, until
                   ; it would underflow, and increase the digit that many times. Then move on to
                   ; the next digit. In other words, take quotient(x,10000), set x=remainder, take
                   ; quotient(x,1000), and so on.
84d9: 38           @loop2                sec                             ;x=0 on entry
84da: a5 7e                              lda     <a href="#Symtemp7e">temp7e</a>
84dc: fd f6 84                           sbc     <a href="#Symtenslo">tenslo</a>,x
84df: a8                                 tay                             ;save
84e0: a5 7f                              lda     <a href="#Symtemp7f">temp7f</a>
84e2: fd fb 84                           sbc     <a href="#Symtenshi">tenshi</a>,x
84e5: 10 06                              bpl     @inc
84e7: e8                                 inx                             ;next digit
84e8: e0 05                              cpx     #$05                    ;digits 0..4
84ea: d0 ed                              bne     @loop2
84ec: 60                                 rts

84ed: f6 f9        @inc                  inc     <a href="#Symdigits">digits</a>,x                ;'0' -&gt; '1', etc.
84ef: 85 7f                              sta     <a href="#Symtemp7f">temp7f</a>
84f1: 84 7e                              sty     <a href="#Symtemp7e">temp7e</a>
84f3: 4c d9 84                           jmp     @loop2

                   ; Low and high 8 bits of decimal 10s places. E.g. 0x2710 = 10,000.
84f6: 10 e8 64 0a+ <a name="Symtenslo">tenslo</a>                .bulk   10e8640a01              ;10000,1000,100,10,1 (low 8 bits)
84fb: 27 03 00 00+ <a name="Symtenshi">tenshi</a>                .bulk   2703000000              ;10000,1000,100,10,1 (high 8 bits)
                   <span style="background-color: #cbcb00">NOTE: The rest of the file $8500-$95FF appears to be junk</span>
8500: 00 00 00 00+                       .junk   4352
</pre>


    </div>

    <!-- SymbolTable is optional; remove this entire section from the template if you don't want it -->
    <div id="symbol-table">
        <h2>Symbol Table</h2>
<table>
  <tr><td><a href="#SymGAME2_action_menu">GAME2_action_menu</a></td><td><code>$7700</code></td></tr>
  <tr><td><a href="#SymGAME2_attacked">GAME2_attacked</a></td><td><code>$771e</code></td></tr>
  <tr><td><a href="#SymGAME2_await_button_up">GAME2_await_button_up</a></td><td><code>$770c</code></td></tr>
  <tr><td><a href="#SymGAME2_calc_hires_textpos">GAME2_calc_hires_textpos</a></td><td><code>$6042</code></td></tr>
  <tr><td><a href="#SymGAME2_chkkey">GAME2_chkkey</a></td><td><code>$6b27</code></td></tr>
  <tr><td><a href="#SymGAME2_clearpages">GAME2_clearpages</a></td><td><code>$6033</code></td></tr>
  <tr><td><a href="#SymGAME2_cleartext">GAME2_cleartext</a></td><td><code>$6006</code></td></tr>
  <tr><td><a href="#SymGAME2_copypages">GAME2_copypages</a></td><td><code>$6030</code></td></tr>
  <tr><td><a href="#SymGAME2_delay2">GAME2_delay2</a></td><td><code>$6036</code></td></tr>
  <tr><td><a href="#SymGAME2_delayXtimes256">GAME2_delayXtimes256</a></td><td><code>$6012</code></td></tr>
  <tr><td><a href="#SymGAME2_draw_player">GAME2_draw_player</a></td><td><code>$6b03</code></td></tr>
  <tr><td><a href="#SymGAME2_drawtile">GAME2_drawtile</a></td><td><code>$6003</code></td></tr>
  <tr><td><a href="#SymGAME2_erase_player">GAME2_erase_player</a></td><td><code>$6b06</code></td></tr>
  <tr><td><a href="#SymGAME2_examine">GAME2_examine</a></td><td><code>$77ee</code></td></tr>
  <tr><td><a href="#SymGAME2_init_item_state">GAME2_init_item_state</a></td><td><code>$603f</code></td></tr>
  <tr><td><a href="#SymGAME2_intro">GAME2_intro</a></td><td><code>$6027</code></td></tr>
  <tr><td><a href="#SymGAME2_lose_weight">GAME2_lose_weight</a></td><td><code>$7712</code></td></tr>
  <tr><td><a href="#SymGAME2_menu_input">GAME2_menu_input</a></td><td><code>$6b2a</code></td></tr>
  <tr><td><a href="#SymGAME2_message_wait">GAME2_message_wait</a></td><td><code>$7706</code></td></tr>
  <tr><td><a href="#SymGAME2_next_frame">GAME2_next_frame</a></td><td><code>$6b00</code></td></tr>
  <tr><td><a href="#SymGAME2_next_tick">GAME2_next_tick</a></td><td><code>$771b</code></td></tr>
  <tr><td><a href="#SymGAME2_num_to_str">GAME2_num_to_str</a></td><td><code>$7718</code></td></tr>
  <tr><td><a href="#SymGAME2_ongoing_input">GAME2_ongoing_input</a></td><td><code>$6b09</code></td></tr>
  <tr><td><a href="#SymGAME2_play_melody">GAME2_play_melody</a></td><td><code>$6024</code></td></tr>
  <tr><td><a href="#SymGAME2_player_init">GAME2_player_init</a></td><td><code>$6039</code></td></tr>
  <tr><td><a href="#SymGAME2_print_item_desc">GAME2_print_item_desc</a></td><td><code>$770f</code></td></tr>
  <tr><td><a href="#SymGAME2_printchar">GAME2_printchar</a></td><td><code>$600f</code></td></tr>
  <tr><td><a href="#SymGAME2_PRNTSTR">GAME2_PRNTSTR</a></td><td><code>$600c</code></td></tr>
  <tr><td><a href="#SymGAME2_read_0900">GAME2_read_0900</a></td><td><code>$6021</code></td></tr>
  <tr><td><a href="#SymGAME2_read_playfield">GAME2_read_playfield</a></td><td><code>$601e</code></td></tr>
  <tr><td><a href="#SymGAME2_redraw_player">GAME2_redraw_player</a></td><td><code>$6b0c</code></td></tr>
  <tr><td><a href="#SymGAME2_slot_to_item">GAME2_slot_to_item</a></td><td><code>$7703</code></td></tr>
  <tr><td><a href="#SymGAME2_swapzp8">GAME2_swapzp8</a></td><td><code>$6015</code></td></tr>
  <tr><td><a href="#SymGAME2_teleport_home">GAME2_teleport_home</a></td><td><code>$601b</code></td></tr>
  <tr><td><a href="#SymGAME2_tile_at_xy">GAME2_tile_at_xy</a></td><td><code>$6b1e</code></td></tr>
  <tr><td><a href="#SymGAME2_txtpos_to_addr">GAME2_txtpos_to_addr</a></td><td><code>$7721</code></td></tr>
  <tr><td><a href="#SymGAME2_win_game">GAME2_win_game</a></td><td><code>$6b24</code></td></tr>
  <tr><td><a href="#SymGAME2_write_tiles_to_text">GAME2_write_tiles_to_text</a></td><td><code>$6009</code></td></tr>
  <tr><td><a href="#SymGAME2_writetile">GAME2_writetile</a></td><td><code>$6045</code></td></tr>
</table>

    </div>

    <div id="footer">
        <hr/>
        <p>HTML generated by <a href="https://6502bench.com/">6502bench SourceGen</a> v1.7.3
        on 2021/12/18 <!--00:30:20 -06:00--></p>
        <p>Expression style: Common</p>
        <!-- parameters: cols=22,8,24,100;extraCols=Address,Bytes;byteSpc=True;commaBulk=False;nonuPfx='@';varPfx='';labelBrk=True;notes=True;gfx=True;opWrap=64 -->
    </div>
</body>
</html>
